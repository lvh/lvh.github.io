<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="lvh's blog">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>lvh (old posts, page 6) | lvh</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#383234">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://www.lvh.io/index-6.html">
<link rel="prev" href="." type="text/html">
<link rel="next" href="index-5.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="https://www.lvh.io/">
            <img src="pinchy.svg" alt="lvh" id="logo" class="d-inline-block align-top"><span id="blog-title">lvh</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="archive/" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="tags/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="talks/" class="nav-link">Talks</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<!-- Custom search --><form method="get" id="search" action="//duckduckgo.com/" class="navbar-form pull-right">
<input type="hidden" name="sites" value="https://www.lvh.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="display: none;">
</form>
<!-- End of custom search -->


            <ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/smaller-clojure-docker-builds-with-multi-stage-builds/" class="u-url">Smaller Clojure Docker builds with multi-stage builds</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                lvh
            </span></p>
            <p class="dateline">
            <a href="posts/smaller-clojure-docker-builds-with-multi-stage-builds/" rel="bookmark">
            <time class="published dt-published" datetime="2017-06-16T10:12:46-07:00" itemprop="datePublished" title="2017-06-16 10:12">2017-06-16 10:12</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>A common pattern in Docker is to use a separate build environment from the
runtime environment. Many platforms have different requirements when you're
generating a runnable artifact than when you're running it.</p>
<p>In languages like Go, Rust or C, where the most common implementations produce
native binaries, the resulting artifact may require nothing from the environment
at all, or perhaps as little as a C standard library. Even in languages like
Python that don't typically have a build step, you might indirectly use code
that still requires compilation. Common examples include OpenSSL with
pyca/cryptography or NETLIB and other numerical libraries with numpy/scipy.</p>
<p>In Clojure, you can easily build "uberjars" with both lein and boot. These are
jars (the standard JVM deployable artifact) that come with all dependencies
prepackaged, requiring nothing beyond what's in the Java standard library
(rt.jar). While this still requires a JRE to run, that is still much smaller
than the full development environment.</p>
<p>There are a few advantages to separating environments. It all boils down to them
not having anything in them they don't need. That has clear performance
advantages, although Docker has historically mitigated this problem with layered
pulls. It can have security benefits as well: you can't have bugs in software
you don't ship. Even software that isn't directly used in the build process can
be affected: some build environments will contain plenty of software that is
never used that would normally carry over into your production environments.</p>
<p>Historically, most users of Docker haven't bothered. Even if there are
advantages, they aren't worth the hassle of having separate Docker environments
and ferrying data between them. While different ways of effectively sharing data
between containers have been available for years, people who wanted a shared
build step have mostly had to write their own tooling. For example,
my <a href="https://github.com/lvh/icecap/blob/master/utils/build-libsodium-package.sh">icecap</a> project has a batch file with an embedded Dockerfile that builds
libsodium debs.</p>
<p>The upcoming release of Docker will add support for a new feature called
multi-stage builds, where this pattern is much simpler. Dockerfiles themselves
know about your precursor environments now, and future containers have full
access to previous containers for copying build artifacts around. This
requires Docker 17.05 or newer.</p>
<p>Here's an example Dockerfile that builds an uberjar from a standard lein-based
app, and puts it in a new JRE image:</p>
<pre class="code literal-block"><span></span><span class="k">FROM</span> <span class="n">clojure</span> <span class="k">AS</span> <span class="n">build</span><span class="o">-</span><span class="n">env</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">myapp</span>
<span class="k">COPY</span> <span class="n">project</span><span class="p">.</span><span class="n">clj</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">myapp</span><span class="o">/</span>
<span class="n">RUN</span> <span class="n">lein</span> <span class="n">deps</span>
<span class="k">COPY</span> <span class="p">.</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">myapp</span>
<span class="n">RUN</span> <span class="n">mv</span> <span class="ss">"$(lein uberjar | sed -n 's/^Created \(.*standalone\.jar\)/\1/p')"</span> <span class="n">myapp</span><span class="o">-</span><span class="n">standalone</span><span class="p">.</span><span class="n">jar</span>

<span class="k">FROM</span> <span class="n">openjdk</span><span class="p">:</span><span class="mi">8</span><span class="o">-</span><span class="n">jre</span><span class="o">-</span><span class="n">alpine</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">myapp</span>
<span class="k">COPY</span> <span class="c1">--from=build-env /usr/src/myapp/myapp-standalone.jar /myapp/myapp.jar</span>
<span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="ss">"java"</span><span class="p">,</span> <span class="ss">"-jar"</span><span class="p">,</span> <span class="ss">"/myapp/myapp.jar"</span><span class="p">]</span>
</pre>


<p>This captures the uberjar name from the <code>lein uberjar</code> output. If your uberjar
name doesn't end in <code>.standalone.jar</code>, that won't work. You can change the name
of the uberjar with the <code>:uberjar-name</code> setting in <code>project.clj</code>. If you set it
to <code>myapp-standalone.jar</code>, you don't need the gnarly <code>sed</code> expression anymore at
all, and can just call <code>lein uberjar</code>. (Thanks to Łukasz Korecki for the
suggestion!)</p>
<p>The full clojure base image is a whopping 629MB (according to <code>docker images</code>),
whereas <code>openjdk:8-jre-alpine</code> clocks in at 81.4MB. That's a little bit of an
unfair comparison: <code>clojure</code> also has an alpine-based image. However, this still
illustrates the savings compared to the most commonly used Docker image.</p>
<p>There are still good reasons for not using multi-stage builds. In the icecap
example above, the entire point is to use Docker as a build system to produce
a deb artifact <em>outside of Docker</em>. However, that's a pretty exotic use case:
for most people this will hopefully make smaller Docker images an easy
reality.</p>
<p><em>Edited:</em> The original blog post said that the Docker version to support this
feature was in beta at time of writing. That was/is correct, but it's since
been released, so I updated the post.</p>
<p><em>Edited:</em>* Łukasz Korecki pointed out that <code>project.clj</code> has an <code>:uberjar-name</code>
parameter which can be used to avoid the gnarly <code>sed</code> expression. Thanks Łukasz!</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2016-rmbp-caveats/" class="u-url">2016 rMBP caveats</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                lvh
            </span></p>
            <p class="dateline">
            <a href="posts/2016-rmbp-caveats/" rel="bookmark">
            <time class="published dt-published" datetime="2016-11-22T07:49:16-08:00" itemprop="datePublished" title="2016-11-22 07:49">2016-11-22 07:49</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>I bought the 2016 15" retina MacBook Pro as soon as it became available. I've
had it for a week now, and there have been some issues you might want to be
aware of if you'd like to get one.</p>
<p>(There are a bunch of links to Amazon in this article. They're not affiliate
links.)</p>
<h2>System Integrity Protection is often disabled</h2>
<p>I noticed <a href="https://twitter.com/schwa/status/799160866209828864">via Twitter</a> that some people were reporting that <a href="https://en.wikipedia.org/wiki/System_Integrity_Protection">System Integrity
Protection (SIP)</a> was disabled by default on their Macs. SIP is a mechanism via
which macOS protects critical system files from being overwritten.</p>
<p>You can check if SIP is enabled on your system by running <code>csrutil status</code> in a
terminal. Sure enough, SIP was disabled for both me and my wife's new rMBPs. To
enable SIP, boot into the recovery mode (hold ⌘-R when booting), open a
terminal, type <code>csrutil enable</code> and reboot.</p>
<p>Perhaps unrelatedly, different out-of-the-box rMBPs appear to have different
builds of OS X Sierra 10.12.1.</p>
<h2>Thunderbolt 2 dongle doesn't work with external screens</h2>
<p>I have a Dell 27" 4k montior (P2715Q). I used it with my previous-generation
rMBP with a DisplayPort-to-mDP2 cable to connect it to its Thunderbolt 2 port.
When buying my laptop, it suggested I get a Thunderbolt 3 to Thunderbolt 2
dongle. I was expecting to get a Thunderbolt 2 port like the one on my previous
Mac. When I plugged it in to my monitor, it told me that there was a cable
plugged in, but no signal coming from the computer.</p>
<p>My understanding was that the Thunderbolt spec implies PCIe lanes and other
protocols over the same port. Specifically, Thunderbolt 2 means 4 PCI Express
2.0 lanes with DisplayPort 1.2; at a cursory glance, <a href="https://en.wikipedia.org/wiki/Thunderbolt_(interface)">Wikipedia agrees</a>.
(Thunderbolt 3 adds HDMI 2.0 and USB 3.1 gen 2.)</p>
<p>I spent about an hour and a half on the phone with AppleCare folks. The Apple
support people were very friendly. (I'm guessing their instructions tell them to
never, under any circumstances, interrupt a customer. It was a little weird.) I
was redirected a few times. They had a variety of suggestions, including:</p>
<ul>
<li>Changing my monitor to MST mode, which shouldn't be necessary for DisplayPort
  1.2-supporting devices, and did nothing but make my monitor not work with my old
  rMBP either. Fortunately I was able to recover via HDMI to my old laptop.</li>
<li>Buying the Apple Digital AV Adapter instead. That adapter used HDMI instead of
  mDP2. That's a significant downgrade; my use of DisplayPort was intentional,
  because DisplayPort 1.2 is the only way I can power the 4K display at 60Hz.
  (The new adapter does not support HDMI 2.0, which is necessary for 4K@60Hz.)</li>
<li>Buying a third-party DisplayPort adapter or dock. This is precarious at best.
  Most existing devices <a href="https://9to5mac.com/2016/11/03/2016-macbook-pro-thunderbolt-compatibility-issues/">don't work with the new rMBP</a>, because they
  use a previous-generation TI chip. There are plenty of docks that wont work,
  by <a href="https://www.amazon.com/StarTech-com-Thunderbolt-Dual-4K-Docking-Station">StarTech</a>, <a href="https://www.amazon.com/Dell-Dock-WD15-Adapter-Type-C">Dell</a>, <a href="https://www.amazon.com/Kensington-Delivery-DisplayPort-Microphone-K38231WW">Kensington</a>
  and <a href="https://www.amazon.com/Plugable-Display-Docking-Charging-Delivery">Plugable</a>. I found one Dock by <a href="https://www.amazon.com/CalDigit-USB-C-Docking-Station-DisplayPort">CalDigit</a> that will
  ostensibly work with the new rMBP, but doesn't supply enough power to charge
  it.</li>
</ul>
<p>Eventually, we found <a href="https://support.apple.com/en-us/HT207266">a KB article</a> that spells out that the Thunderbolt
dongle doesn't work for DisplayPort displays:</p>
<blockquote>
<p>The Thunderbolt 3 (USB-C) to Thunderbolt 2 Adapter doesn't support connections to these devices:</p>
<ul>
<li>Apple DisplayPort display</li>
<li>DisplayPort devices or accessories, such as Mini DisplayPort to HDMI or Mini DisplayPort to VGA adapters</li>
<li>4K Mini DisplayPort displays that don’t have Thunderbolt</li>
</ul>
</blockquote>
<p>I'm a little vindicated by the <a href="http://www.apple.com/shop/reviews/MMEL2AM/A/thunderbolt-3-usb-c-to-thunderbolt-2-adapter">Mac Store</a> review page for the dongle;
apparently I wasn't the only person to expect that. (I was unable to see the
reviews before my purchase, because I purchased it with my Mac, which doesn't
show reviews. Also, the product was brand new at the time, and didn't have these
reviews yet.)</p>
<p><a href="http://www.belkin.com/us/p/P-F4U095/">Belkin</a> and <a href="https://9to5mac.com/2016/11/03/owc-announces-thunderbolt-3-dock-adds-13-ports-of-legacy-io-to-the-new-macbook-pros-over-a-single-cable/">OWC</a> will be shipping docks that allegedly work with
the new rMBP, but Belkin's is currently unavailable with no ship date mentioned,
and OWC claims February 2017.</p>
<h2>WiFi failing with USB-C devices plugged in</h2>
<p>Just as I was going to start writing this post, I noticed that I wasn't able
to sync my blog repository from GitHub:</p>
<pre class="code literal-block"><span></span><span class="nv">Get</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">api</span>.<span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">repos</span><span class="o">/</span><span class="nv">lvh</span><span class="o">/</span><span class="nv">lvh</span>.<span class="nv">github</span>.<span class="nv">io</span>: <span class="nv">dial</span> <span class="nv">tcp</span> <span class="mi">192</span>.<span class="mi">30</span>.<span class="mi">253</span>.<span class="mi">116</span>:<span class="mi">443</span>: <span class="k">connect</span>: <span class="nv">network</span> <span class="nv">is</span> <span class="nv">unreachable</span>
</pre>


<p>It didn't click at first what was going on. I restarted my router, connected to
different networks, tried a different machine -- all telling me it was this
laptop that was misbehaving. I started trying everything, and realized I had
recently plugged in my WD backup drive from which I was copying over an SSH key.
It's a USB 3.0 drive that I'm connecting via an AUKEY USB 3 to USB-C converter.
I removed the drive, and my WiFi starts working again. Plugging it back in does
not instantly, but eventually, break WiFi again.</p>
<p>After searching, I was able <a href="https://www.youtube.com/watch?v=NYVjIjBMx6o">to find someone with the same problem</a>.
It is unclear to me if this issue is related to the first-gen TI chip issue
mentioned above. In that video, the authors are also using a USB 3.0 to USB-C
plug, albeit a different one from mine. I don't have a reference USB-C machine
that isn't a new 2016 rMBP to test with. However, this seems plausible, because
the USB 3.0 dongle I purchased from Apple ostensibly works fine.</p>
<p>This does not seem like a reasonable failure mode.</p>
<h2>The escape key, and the new keyboard</h2>
<p>I spend most of my day in Emacs. I'm perfectly happy with the new keyboard. I've
also used the regular MacBook butterfly keyboard, and the new version is
significantly better. I've never had a problem with not having an escape key;
every app where I would've cared to press it had an escape key drawn on the new
Touch Bar. However, not having tactile feedback for the escape key is annoying.
When I was setting up my box and quickly editing a file in vim, I successfully
pressed Escape to exit insert mode -- but I ended up pressing it five times
because I thought I didn't hit it. Apparently the visual feedback vim gives me
that I've exited insert mode is not, actually, what my brain relies on. I'll let
you know if I get used to it.</p>
<h2>Charging</h2>
<p>I'll miss the safety of Magsafe, but being able to plug in your charger on
either side is an unexpected nice benefit.</p>
<h2>Conclusion</h2>
<p>I was ready to accept a transition period of dongles; I bought into it,
literally and figuratively. However, most of the dongles don't actually work,
and that sucks. So, maybe wait for the refresh, or at least until the
high-quality docks are available.</p>
</div>
    </div>
    </article>
</div>

        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="." rel="prev">Newer posts</a></li>
            <li class="next"><a href="index-5.html" rel="next">Older posts</a></li>
        </ul>
<!--End of body content--><footer id="footer">
            Contents © 2019         <a href="mailto:_@lvh.io">lvh</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36779422-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
