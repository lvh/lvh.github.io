<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="https://www.lvh.io/index-3.html">
<meta name="description" content="lvh's blog">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>lvh (old posts, page 3) | lvh</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://www.lvh.io/index-3.html">
<link rel="prev" href="index-4.html" type="text/html">
<link rel="next" href="index-2.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://www.lvh.io/">
                <img src="pinchy.svg" alt="lvh" id="logo"><span id="blog-title">lvh</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="about.html">About</a>
                </li>
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="talks.html">Talks</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<!-- Custom search --><form method="get" id="search" action="//duckduckgo.com/" class="navbar-form pull-right">
<input type="hidden" name="sites" value="https://www.lvh.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Searchâ€¦" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="display: none;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2014/05/on-truecrypt-and-full-disk-encryption.html" class="u-url">On TrueCrypt and full-disk encryption</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2014/05/on-truecrypt-and-full-disk-encryption.html" rel="bookmark"><time class="published dt-published" datetime="2014-05-29T10:53:00-07:00" title="2014-05-29 10:53">2014-05-29 10:53</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>Since the early hours of May 29th (CEST), <a href="https://www.truecrypt.org">the TrueCrypt website
(<code>https://www.truecrypt.org</code>)</a> has pointed
to <code>http://truecrypt.sourceforge.net/</code>, with an ominous-looking error
message:</p>
<blockquote>
<p>WARNING: Using TrueCrypt is not secure as it may contain unfixed
security issues</p>
<p>This page exists only to help migrate existing data encrypted by
TrueCrypt.</p>
<p>The development of TrueCrypt was ended in 5/2014 after Microsoft
terminated support of Windows XP. Windows 8/7/Vista and later offer
integrated support for encrypted disks and virtual disk images. Such
integrated support is also available on other platforms (click here
for more information). You should migrate any data encrypted by
TrueCrypt to encrypted disks or virtual disk images supported on
your platform.</p>
</blockquote>
<p>The website then explains how you can install BitLocker, a proprietary
disk encryption system available in many versions of Windows, as well
as how you could "rescue" existing TrueCrypt volumes.</p>
<p>People were pretty unhappy, for a variety of reasons:</p>
<ul>
<li>Lack of trust in proprietary full-disk encryption software.</li>
<li>Many versions of Windows didn't even ship with BitLocker, only a few
  "premium" versions did.</li>
</ul>
<p>As a proprietary system, BitLocker is not susceptible to the same
amount of public scrutiny as a publicly available system. This is in
stark contrast with TrueCrypt, where Matt Green recently raised around
70k USD to perform an <a href="http://istruecryptauditedyet.com/">audit</a>.</p>
<p>There are variety of scenarios that could've caused the TrueCypt
website to suddenly sport that message. The live Internet audience has
speculated wildly. I'll share my thoughts on that near the end of this
post, but there are two points I'd like to make that I think are far
more important:</p>
<ol>
<li>Consider if full-disk encryption is really what you want.</li>
<li>If it is, consider if it should be TrueCrypt.</li>
</ol>
<h4>Full-disk encryption</h4>
<p>Something I learned from the inimitable <a href="https://zooko.com">Zooko</a>:</p>
<blockquote>
<p>Security isn't about perfect versus imperfect or about better versus
worse, it's about <em>this</em> attack surface versus <em>that</em> attack
surface.</p>
</blockquote>
<p>You can't just add more crypto junk to something and expect to somehow
get better security. You have to consider what it is buying you, and
what it's costing you.</p>
<p>Full-disk encryption buys you one simple thing: if someone steals your
device while the encrypted volume is locked, they probably can't read
it.</p>
<p>If the encrypted volume is unlocked, it's over; and that's the state
it's probably usually in. If the key lives in RAM (it usually does),
there's a variety of ways that can be extracted. There's devices that
have complete direct memory access, including everything that speaks
FireWire or has FireWire-compatibility built-in. Even if you shut off
your machine, cold boot attacks mean that the key can be extracted for
a limited about of time. Various jurisdictions can try to force you to
hand over the keys.</p>
<p>If an attacker can write to the (encrypted!) volume, it's probably
over. Virtually all sector-level full-disk encryption formats are
unauthenticated (with good reason), they're all malleable and
vulnerable to (adaptive) chosen-ciphertext attacks.</p>
<p>If you're encrypting files or blobs of data within other files, an
authenticated encryption scheme like GPG is far more useful.</p>
<p>Don't get me wrong. Full-disk encryption is a good idea, and you
should do it. I'm just saying that what it actually protects against
is pretty limited. If there's files you want to keep secret, full-disk
encryption is probably not enough.</p>
<p>For more details, try Thomas &amp; Erin Ptacek's
<a href="http://sockpuppet.org/blog/2014/04/30/you-dont-want-xts/">blog post</a>
on why XTS isn't what you want. XTS is a way to build tweakable
ciphers that can be used to create full-disk encryption; but the post
applies to full-disk encryption generically as well.</p>
<h4>TrueCrypt as a full-disk encryption mechanism</h4>
<p>So, you probably want full-disk encryption, and you probably want to
make sure that sensitive data is encrypted on top of that. Great. What
full-disk encryption scheme do you use?</p>
<p>I don't want to bash TrueCrypt. It is (was, perhaps?) a great go-to
project for full-disk encryption. It got a lot of things right. It
also got a bunch of things wrong.</p>
<p>TrueCrypt was made by a bunch of people we don't know occasionally
throwing a bunch of binaries over the wall. The source is available
(under a non-OSI license), so you could audit that and compile your
own binaries, but the truth is that the vast majority of TrueCrypt
users never actually did that.</p>
<p>The TrueCrypt disk format and encryption standards are a bit iffy. It
has terrible file system support. It has major performance issues,
partially due to questionable cryptographic practices such as cipher
cascades. It was great for when it was originally conceived and
full-disk encryption was still new and exciting, it's still pretty
decent now, but we can certainly do better.</p>
<h4>What actually happened to the website?</h4>
<p>We don't really know. There's a couple of guesses.</p>
<p>First of all, it looks like it are the original authors that folded:
the key is the same one that was being used to sign releases months
ago. Of course, that could mean that it was compromised or that they
were forced to hand it over.</p>
<p>Since the DNS records changed, the e-mail server behavior changed, the
same key was used, the Sourceforge client was involved, and fairly
major changes to the source code were involved, it's unlikely that
it's a simple defacement.</p>
<p>It's unlikely that they folded because they felt discovery of some
backdoor was imminent. Folding wouldn't actually stop that discovery,
because the source was already open.</p>
<p>It's strange that they would point to alternatives like Bitlocker for
Windows and even more dubious alternatives for other operating
systems. The authors certainly knew that this would not be an
acceptable alternative for the vast majority of their users.</p>
<p>Additionally, the support window for XP ending isn't a particularly
convincing impetus for migrating away from TrueCrypt <em>right now</em>. This
has lead some to believe that it's an automated release. Worse, it
could be a gagged response: a big and powerful three-letter agency
might be twisting their arm and forcing them to fold, in return for
something else (like, say, not being thrown in a Gitmo cell and
forgotten about). Again: pure speculation.</p>
<p>Another option is that some of the developers just really, genuinely
folded. They felt that for atechnical users, BitLocker was good
enough, while the particularly discerning TrueCrypt user would be able
to find some other alternative.</p>
<p>Bottom line is that none of this really matters. What matters is what
you should do next if you want to have full-disk encryption.</p>
<h4>So what do I do now?</h4>
<p>I think LUKS is probably the best system that we have right now, and
one of the few that actually improves on TrueCrypt.</p>
<p>If you're on Linux, dm-crypt + cryptsetup + LUKS is probably what you
want. If you're on OS X, FileVault 2 is probably what you want. If
you're on Windows, your options are looking a bit thin right now:</p>
<ul>
<li>Keep using old versions of TrueCrypt.</li>
<li>Give up and use BitLocker.</li>
<li>Use a Linux virtual machine to use dm-crypt/LUKS, eventually
  migrating to native support.</li>
</ul>
<p>Personally, I think the first option is the most reasonable right now,
and then wait until someone actually writes the native LUKS support.</p>
<p>Oh, and you should probably install GPG to encrypt some of those files
stored on that encrypted volume.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2014/04/more-on-financial-aid-grant-optimization.html" class="u-url">More on financial aid grant optimization</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2014/04/more-on-financial-aid-grant-optimization.html" rel="bookmark"><time class="published dt-published" datetime="2014-04-06T20:34:00-07:00" title="2014-04-06 20:34">2014-04-06 20:34</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>In <a href="http://www.lvh.io/blog/2014/03/10/optimization-problems-and-pycon-financial-aid/">a previous post</a>, I talked about ways to optimize PyCon
financial aid grants. This is a follow-up on those efforts. Quick
recap:</p>
<ul>
<li>There is a fixed budget \(b\) available for grants, between 100k
  and 200k USD.</li>
<li>There are a number of people (approximately 300) requesting various
  amounts \(r_i\) (approximately between 100 USD and 2000 USD) of
  financial aid, and receive a grant \(g_i\) so that \(0 \le g_i
  \le r_i\).</li>
<li>Financial aid applicants can be assigned scores \(s_i\), a
  relative value describing how much we'd like to have them at PyCon.</li>
<li>PyCon wants to optimize the total expected value of scores. That
  means getting as many people as possible to come, weighted by score.</li>
<li>We've conjectured that we can estimate the probability \(p_i\)
  that someone attends as either \(g_i/r_i\), or \((g_i/r_i)^2\).
  The former prefers to spread the budget across a larger number of
  smaller grants, whereas the latter prefers to focus the budget into
  a smaller number of larger grants.</li>
</ul>
<p>If any of that doesn't make sense, you should read
<a href="http://www.lvh.io/blog/2014/03/10/optimization-problems-and-pycon-financial-aid/">the previous blog post</a> for more details.</p>
<p>In short, we're trying to solve the optimization problem:</p>
<p>$$\max \sum E[S_i] = \sum s_i \cdot p_i$$</p>
<p>Since most optimization texts appear to prefer minimization,
alternatively:</p>
<p>$$\min - \sum s_i \cdot p_i$$</p>
<p>Subject to a budget constraint and an individual grant constraint:</p>
<p>$$\sum g_i \le b$$</p>
<p>$$0 \le g_i \le r_i$$</p>
<p>The greater-than-zero constraint for individual grants is fairly
important, otherwise the algorithm might casually give you answers
like:</p>
<pre class="code literal-block"><span></span>k = 1: [ 10.  20. -20.  30.  50.  10.  50.], sum: 150.0
</pre>


<p>That list in the middle are the per-person grants. Notice how the
algorithm feels that the third person really ought to pony up some
cash so that some of the other people can go to PyCon ;-)</p>
<h3>Squared problems</h3>
<p>In the <a href="http://www.lvh.io/blog/2014/03/10/optimization-problems-and-pycon-financial-aid/">previous blog post</a> I ran into issues using a very
generic constraint solver. I ended that post saying that I would try
to remeedy that by applying a more specific solver that takes
advantage of a particular structure of the problem.</p>
<p>When you set \(p_i = g_i/r_i\), this turns into a linear programming
problem, since \(r_i\) is a constant. When you set \(p_i =
\left(g_i/r_i\right)^2\), it turns into a quadratic programming
problem. Turns out there's two things I missed about the quadratic
problem:</p>
<ul>
<li>The resulting problem is not convex. That means it's (probably)
  difficult to solve.</li>
<li>The estimated probability that someone will attend falls off sharply
  as soon as they don't receive the full amount they requested. At 50%
  of the requested grant, the estimated probability of attending is
  only 25%; at 90%, it's 81%. This is the opposite of what we want.</li>
</ul>
<h3>Fixing the model</h3>
<p>That doesn't mean we should put the \((g_i/r_i)^k\) out to pasture:
it just means that I didn't pick the \(k\) I really wanted.
Specifically, if I were to pick \(k=1/2\), I'd get:</p>
<p>$$p_i = \left(\frac{g_i}{r_i}\right)^{1/2} = \sqrt{\frac{g_i}{r_i}}$$</p>
<p>In general, if  \(k = 1/n\):</p>
<p>$$p_i = \left(\frac{g_i}{r_i}\right)^{1/n} = \sqrt[n]{\frac{g_i}{r_i}}$$</p>
<p>That problem <em>is</em> convex, but it isn't linear, quadratic, or some
other easy specific problem. It's just constrained multivariate convex
optimization. That's okay, there are still a couple of applicable
optimization algorithms.</p>
<p>Some of these algorithms require the derivative of the goal function
with respect to a particular grant size \(g_j\) at a particular
point. In case we don't have the real derivative, we can still provide
a numerical approximation. In our case, we don't really need to
approximate, since the derivatives are fairly easy to compute
analytically:</p>
<p>$$\frac{\partial}{\partial g_j} \sum_i s_i \cdot
\sqrt[n]{\frac{g_i}{r_i}} = \frac{s_j \cdot {g_j}^{\frac{1}{n} -
1}}{\sqrt[n]{r_j} \cdot n}$$</p>
<h3>Finding a solution with Python</h3>
<p>There are a few Python packages that contain optimization algorithms:</p>
<ul>
<li>SciPy</li>
<li>cvxopt</li>
<li>pyopt</li>
</ul>
<p>Someone originally pointed me towards cvxopt. While I'm sure it's
excellent software, I already knew SciPy, so I went with that.</p>
<p>SciPy's optimization module provides the following algorithms:</p>
<ul>
<li>
<code>fmin_l_bfgs_b</code> - Zhu, Byrd, and Nocedal's constrained optimizer</li>
<li>
<code>fmin_tnc</code> - Truncated Newton code</li>
<li>
<code>fmin_cobyla</code> - Constrained optimization by linear approximation</li>
<li>
<code>fmin_slsqp</code> - Minimization using sequential least-squares programming</li>
<li>
<code>nnls</code> - Linear least-squares problem with non-negativity constraint</li>
</ul>
<p>The first two are not applicable because they only appear to support
bounds on individual variables. I also need a constraint over the
<em>sum</em> of variables for the budget:  \(\sum g_i \le b\). The last one
isn't applicable because this isn't a linear least-squares problem.
That leaves <code>cobyla</code> and <code>slsqp</code>.</p>
<h3>Experimenting with linear approximation (COBYLA)</h3>
<p>Making COBYLA work ended up being pretty easy. The only non-trivial
part is expressing all your constraints as expressions greater than or
equal to zero.</p>
<p>I've uploaded my IPython notebook
(<a href="http://nbviewer.ipython.org/gist/lvh/10107818">viewer</a>,
<a href="https://gist.github.com/lvh/10107818">gist</a>).</p>
<p>This produced the following results:</p>
<pre class="code literal-block"><span></span>scores: [1 1 1 2 3 5 5]
requested: [10 20 30 30 50 10 50] total: 200, budget: 150
k = 1/0.5: [ 10.  20.  30.  30.  50.  10.   0.], sum: 150.0
k = 1/1: [ 10.  -0.   0.  30.  50.  10.  50.], sum: 150.0
k = 1/2: [ 10.  10.   7.  27.  36.  10.  50.], sum: 150.0
k = 1/3: [ 10.  11.   9.  25.  35.  10.  50.], sum: 150.0
k = 1/5: [ 10.  11.  10.  24.  35.  10.  50.], sum: 150.0
k = 1/10: [ 10.  11.  11.  23.  35.  10.  50.], sum: 150.0
k = 1/100: [ 10.  11.  11.  23.  34.  10.  50.], sum: 150.0
</pre>


<p>Some takeaways:</p>
<ul>
<li>As predicted, as \(1/k\) increases, the optimization gradually
  starts spreading the budget out more evenly; preferring to give many
  partial grants rather than a few large ones.</li>
<li>This effect is mostly only pronounced for \(1/k = 2, 3\); after
  that, increasing \(1/k\) doesn't make much of a difference
  anymore. This is what I'd expect when I visualize the \(p_i\)
  functions in my head, but I haven't ruled out numerical instability.</li>
<li>Even at high \(1/k\), the two high scorers get their full grant
  amount. That's quite understandable for the one that's only asking
  for 10, but even the one asking for a large grant gets it
  unconditionally. This probably means that tweaking the scoring
  functions is going to be very important.</li>
<li>The linear version is apparently already quite brutal: the person
  with score 3 requesting 50 simply gets it entirely, leaving no
  budget left over for the people with score 1.</li>
</ul>
<p>Since I'm so pleased with these results, I'm skipping <code>slsqp</code> until I
feel like it. Next up, I'll try to compare the COBYLA results above
with the results of the greedy algorithm under various fitness
metrics.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2014/03/optimal-hotel-room-pairing.html" class="u-url">Optimal hotel room pairing</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2014/03/optimal-hotel-room-pairing.html" rel="bookmark"><time class="published dt-published" datetime="2014-03-18T13:05:00-07:00" title="2014-03-18 13:05">2014-03-18 13:05</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>The greedy hotel pairing algorithm from my <a href="http://blog.lvh.io/blog/2014/03/10/optimization-problems-and-pycon-financial-aid/">previous post</a>
gives good solutions. If you make some fairly reasonable-sounding
assumptions about the problem, <em>very</em> good solutions. At any rate
nicer than forcing a human to drudge through it; both in terms of
person-hours spent and quality of the solutions.</p>
<p>However, it turns out I was wrong about them being <em>optimal</em>
solutions. There's no guarantee they would be, and in fact a good
chance that they won't.</p>
<h3>Finding optimal solutions</h3>
<p>The good news is that there is a way to find the optimal solution.
This problem can be modeled as a <a href="https://en.wikipedia.org/wiki/Matching_%28graph_theory%29">graph matching problem</a>;
what we're trying to find is a weighted maximal matching.</p>
<p>This is really easy if the graph is bipartite, but in our case we're
actually dealing with two <a href="https://en.wikipedia.org/wiki/Complete_graph">complete graphs</a>: we try to pair
people with similar gender. Within that compatible group, anyone can
theoretically pair with anyone.</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/8/86/10-simplex_graph.svg"></p>
<p>People interested in additional reading might be interested in:</p>
<ul>
<li><a href="http://theory.stanford.edu/~jvondrak/CS369P-files/lec6.pdf">Notes from a Stanford course by Jan Vondrak</a></li>
<li><a href="http://www-sop.inria.fr/members/Frederic.Havet/Cours/matching.pdf">Notes from an Inria course by Frederic Havet</a></li>
</ul>
<h3>Picking an algorithm</h3>
<p>There are several feasible algorithms for this.</p>
<ul>
<li>
<a href="https://en.wikipedia.org/wiki/Blossom_algorithm">Edmonds' blossom algorithm</a>, the first polynomial-time
  algorithm with running time \(O(V^4)\) or \(O(V^2\cdot E)\)</li>
<li>Gabow's 1973 PhD thesis, an \(O(V^3)\) algorithm</li>
<li>
<a href="http://dl.acm.org/citation.cfm?id=1382663">An \(O(\sqrt{V} \cdot E)\)) improvement</a> by Micali (yes,
  <a href="https://en.wikipedia.org/wiki/Silvio_Micali"><em>that</em> Micali</a>) and Vazirani</li>
<li>Another improvement by Gabow, \(O(V(E + \log{V}))\)</li>
</ul>
<p>The current state of the art in computerized algorithms appears to be
<a href="http://pub.ist.ac.at/~vnk/papers/blossom5.pdf">Blossom V</a> by Vladimir Kolmogorov. This algorithm finds
<em>perfect</em> matchings (i.e. all nodes are included), which may be
impossible for us, e.g. because of an odd number of pairs.</p>
<h3>Issues</h3>
<p>One issue with this approach is that it becomes pretty much impossible
to adapt this to rooms for more than two people. In order to support
that case my previous greedy algorithm remains the best thing I've
found.</p>
<p>I was unable to find an implementation of this in Java or Clojure.
Fortunately, there is a Python library called <a href="http://networkx.lanl.gov">NetworkX</a>
that does have <a href="http://networkx.lanl.gov/reference/generated/networkx.algorithms.matching.max_weight_matching.html">an implementation</a>.</p>
<p>I have not yet turned this into a fully functional program, because:</p>
<ul>
<li>it's too late to apply it for this year</li>
<li>there's a good chance we won't be doing this again for next year</li>
</ul>
<h3>Credits</h3>
<p>I'd like to thank Tor Myklebust (<code>tmyklebu</code> on Freenode) for pointing
out I was wrong, and shoving me in the direction of the answers.</p>
<p>In this blog post I used several freely available graph illustrations
from Wikipedia. The complete graph illustrations were made by
<a href="https://commons.wikimedia.org/wiki/User:Koko90">koko90</a>.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2014/03/optimization-problems-and-pycon-financial-aid.html" class="u-url">Optimization problems and PyCon financial aid</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2014/03/optimization-problems-and-pycon-financial-aid.html" rel="bookmark"><time class="published dt-published" datetime="2014-03-10T16:47:00-07:00" title="2014-03-10 16:47">2014-03-10 16:47</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>This year, I have partly taken on some new responsibilities in
organizing PyCon. Specifically, I've done some work on financial aid.
(Next year, I will be taking on the position of financial aid chair.)
There have been some challenges that I've thrown some code at. Some of
it stuck.</p>
<p>I'm very much interested in your comments, thoughts, alternative
approaches, et cetera. Hit me up on
<a href="https://twitter.com/lvh">Twitter</a>.</p>
<h3>Hotel room allocation</h3>
<p>The first issue I solved was one of hotel room allocation. We provide
the financial aid applicants with hotel rooms. To keep costs down, we
pair people up, two by two.</p>
<p>We want to pair people so that we have to book a minimal number of
days. If there's days on the start of the room booking where only one
person is booking the room, we have to pay for the rest.</p>
<h4>A greedy algorithm</h4>
<p>I start out with generating every possible pairing. Assuming we have
300 financial aid applicants, that's:</p>
<p>$${300 \choose 2} = \frac{300!}{2! \cdot 298!} = 44850$$</p>
<p>That's more than we can check by hand, but still pretty easy for a
computer. Besides, there are actually fewer pairs than that: some
people request to be paired together explicitly, and we only pair
people of the same gender.</p>
<p>Then, I sort them by number of unmatched days, that is, how many days
would have a single person in the hotel room if we paired them
together. Finally, I just greedily start grabbing pairs, keeping track
of the people that have been allocated rooms as I go along. As soon as
everyone is accounted for, we stop.</p>
<p>Other than perhaps minding the edge conditions where you have an odd
number of people to pair, this isn't too tricky. The implementation
for this is on Github, in
<a href="https://github.com/lvh/pairing/blob/master/src/pairing/core.clj"><code>lvh/pairing</code></a>.</p>
<h4>Solution, meet reality</h4>
<p>Before I wrote this, humans did this by hand. That took pretty long,
and the solutions were decent, but suboptimal. All the humans that
have tackled this problem seem to take the same approach: sort by
check-in date, find exact or near matches in check-out dates, rinse,
repeat.</p>
<p>The algorithm above did quite well, coming up with a significantly
better result than the previous human allocation. It also produced
very <em>interesting</em> solutions. Turns out that by taking a big hit on
one of the pairs (say, a pair that's 4 days mismatched four days), you
can limit the damage on a large number of other pairs, and still come
out on top. After reviewing with the person who previously had to do
this manually, we quickly agreed that a human would most likely not
have come up with this.</p>
<p>Furthermore, a lot of the pairs have matching check-out dates but with
a mismatched check-in date; whereas humans typically only look for
solutions in the other direction. This is easy to explain in
hindsight; the algorithm has no concept of an ordering of events in
time. It just tries to minimize the number of mismatched days.</p>
<p>I'm quite happy with the result. Any dollar I'm not devoting to a room
that isn't being fully used will instead be going into an increased
grant.</p>
<p>Unfortunately, finding this solution isn't the end of the story. It
rarely survives the clash with reality. Many complex factors affect
it: people will drastically change their room dates, people's visas
get denied, et cetera. All sorts of unforseeable circumstances have
lead to changes to the answer the algorithm originally produced. I
don't expect that to change until PyCon is over; unfortunately, I also
don't think that's a problem I can fix in a few lines of Clojure.</p>
<h3>Grant allocation</h3>
<p>The second issue is a much thornier one. Given the financial aid
budget, figure out how to optimally distribute it. The budget is quite
limited, a good deal smaller than the sum of what everyone requests.</p>
<p>There's a few reasons why this problem is complex. First of all,
"optimal" is highly subjective. As I'm sure you'll notice very soon
after thinking about it, it's very easy to verge off from math and
straight into the realm of politics.</p>
<h4>A very simple greedy algorithm</h4>
<p>You might say that you want to get as many people as possible to come
to PyCon, and you just greedily allocate the smallest grant requests
first. This has a few disadvantages:</p>
<ol>
<li>It biases against the people that ostensibly need the money the
   most.</li>
<li>It is ordering-sensitive: equivalent applications that happen to
   come later in the queue are disadvantaged.</li>
<li>It oversimplifies how people react to grants, by making grant
   allocation binary. Someone receiving 90% of their requested grant
   amount will likely still be able to attend. Suppose you have 11
   people, all requesting 100 USD, and you have 1000 USD to spend. The
   greedy algorithm would give the first ten of them 100 USD and find
   its purse empty for the eleventh. It would almost certainly be
   better to give them all 90.91 USD instead.</li>
<li>Game-theoretically, it makes a lot of sense for everyone to apply
   for a small grant that they will almost certainly get. (This is not
   a real issue for us, because we still have humans eyeballing all
   the applications.)</li>
<li>The only difference between applications is the amount they're
   requesting, but there are people that we would like to bias in
   favor of. For example, we'd like to try very hard to get speakers
   or tutorial presenters to the conference, we might want to reward
   people doing open source work, et cetera.</li>
</ol>
<p>Selecting these critera is definitely squarely in the realm of
politics, and I'd like to stick to the realm of math; so let's just
assume that we can assign scores to applicants and that those scores
are fair and just. If you feel like we shouldn't bias in favor of
anyone at all, just assume that whenever I say "the score of an
applicant" I mean "the number 1".</p>
<h4>A slightly smarter greedy algorithm</h4>
<p>One of the key ideas (which a lot of people seem to have when tackling
this problem) is to translate an application's score into an amount of
the budget. So, for example, let's say that the sum of all scores is
100, and your score is 10, that means you can have up to 10% of the
budget allocated to you.</p>
<p>So, I make a pass over all the remaining applicants. If you're asking
less than your budget slice, you get your requested grant. If you're
asking for more, I save you for a future pass. Even though the budget
goes down between passes, budget slices will go up, because the total
score drops.</p>
<p>You can't do this in one pass, increasing the budget as you go along
if people request less than their slice, because you might introduce
order dependence. For example, consider what happens when Alice and
Charlie both need more than the budget allows for (and they have the
same score and requested amount), and Bob needs less. If you process
them in the order Alice - Bob - Charlie, Charlie may get his requested
grant and Alice may not, just because Bob's in the middle making the
budget bigger for Charlie.</p>
<p>Once everyone left is requesting more than their slice, they just get
their slice instead of their requested amount.</p>
<p>This solution is adequate, but I'm not completely satisfied; everyone
besides the last pass will get full grant amounts. You can find my
implementation of this algorithm
<a href="https://github.com/lvh/hood/blob/master/src/hood/greedy.clj">on Github</a>
as well.</p>
<h4>A better model</h4>
<p>I think we can do better by applying some elementary probability
theory. What we really want is to maximize the total score of the
applicants that we expect to see at PyCon as a consequence of
financial aid. Probability theory has a thing called the expected
value of a random variable, which is pretty much just the integral of
the random variable with respect to the probability. In our case, that
just means that we want to maximize the sum of the probabiliies that a
given applicant will come to PyCon given a particular grant amount,
weighted by their score:</p>
<p>$$\max \sum s_i \cdot p_i$$</p>
<p>That just restates problems we can't solve in terms of problems we
can't solve. What on earth could the probability that someone shows up
be? We can't know the real value, since it's specific to each
individual, and dependent on a lot of random, unknowable events. We
can, however, make an educated guess. If we don't give them any money,
they probably won't come. If we give them the amount they're asking
for, they probably will.</p>
<p>We could conjecture that the probability someone will come to the
conference is approximately the fraction of the amount they requested
that they actually received:</p>
<p>$$p_i = \frac{g_i}{r_i}$$</p>
<p>For example, if someone gets 90% of their
requested grant, we estimate that the odds they will attend are also
90%; if we give them only 10%, we estimate it at just 10%.</p>
<p>Alternatively, we could conjecture that it's closer to the <em>square</em> of
that ratio; when giving someone a value that's very close to what they
asked for, their probability of attending is still going to be very
high; but if we only give them half, the odds they will attend will be
closer to 25%, much lower than 50%. So, the expression becomes:</p>
<p>$$p^{\prime}_i = \left(\frac{g_i}{r_i}\right)^{2}$$</p>
<p><em>Update:</em> I now realize that this is probably not the expression that
 I actually want: it falls off very quickly as soon as an applicant
 gets anything less than the full amount. I've elaborated on this in
 <a href="http://www.lvh.io/blog/2014/04/06/more-on-financial-aid-grant-optimization/">a new blog post</a>.</p>
<p>We will see how the square model emphasizes focusing the available
funds on fewer grants, whereas the linear model will spread smaller
grants more liberally.</p>
<h4>An attempt with constraint solvers</h4>
<p>(I would like to thank Mark Engelberg for helping me with the stuff in
this chapter. It may not have panned out, but it was a very
educational experience nonetheless.)</p>
<p>It'd be nice if we could just declaratively describe the problem,
throw it into a computer program, and have it magically tell us the
answer. Of course, there are programs that do exactly that, called
solvers.</p>
<p>When I reached out on the Clojure mailing list, Mark Engelberg
helpfully reached out and immediately handed out some cool runnable
example for me to play with. Sure enough, they worked super, and with
a carefully crafted three-person example we could clearly see the
difference between the linear and quadratic models I was talking about
above: under the square model, the concentrated grants, trying harder
to give high-scoring applications the amount they requested. The
linear model spread money out more evenly. That is, with the following
applications:</p>
<pre class="code literal-block"><span></span><span class="p">(</span><span class="k">def </span><span class="nv">alice</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">"Alice"</span>, <span class="ss">:score</span> <span class="mi">5</span>, <span class="ss">:requested</span> <span class="mi">120</span><span class="p">})</span>
<span class="p">(</span><span class="k">def </span><span class="nv">bob</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">"Bob"</span>, <span class="ss">:score</span> <span class="mi">4</span>, <span class="ss">:requested</span> <span class="mi">100</span><span class="p">})</span>
<span class="p">(</span><span class="k">def </span><span class="nv">carol</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">"Carol"</span>, <span class="ss">:score</span> <span class="mi">3</span>, <span class="ss">:requested</span> <span class="mi">80</span><span class="p">})</span>
</pre>


<p>In a linear model, it comes up with:</p>
<pre class="code literal-block"><span></span><span class="p">{</span><span class="nv">alice</span> <span class="mi">120</span>
 <span class="nv">bob</span> <span class="mi">80</span>
 <span class="nv">carol</span> <span class="mi">0</span><span class="p">}</span>
</pre>


<p>However, in the quadratic model, the optimizer rather gives Carol (who
has a lower score) a complete grant than give Bob a partial one:</p>
<pre class="code literal-block"><span></span><span class="p">{</span><span class="nv">alice</span> <span class="mi">120</span>
 <span class="nv">bob</span> <span class="mi">0</span>
 <span class="nv">carol</span> <span class="mi">80</span><span class="p">}</span>
</pre>


<p>You can find the code <a href="https://github.com/lvh/hood/blob/master/src/hood/constraint.clj">on
Github</a>.
The tests that confirm the difference in behavior for the linear and
quadratic models are in <a href="https://github.com/lvh/hood/blob/master/test/hood/constraint_test.clj">the
tests</a>.</p>
<p>There's one issue though; it didn't scale. Not bad enough that you'd
notice on the three-person example (I thought my REPL was just being
laggy), but bad enough that any real-world problem would be completely
unsolvable. Why? Clearly constraint solvers are awesome real world
tools with real world usage, it's not like they're supposed to fall
over as soon as you throw a problem of reasonable size at it.</p>
<p>Well, let's do some napkin math. If we have 200 financial aid
recipients that are all getting 1000 possible options (somewhere
between 0 USD and 1000 USD, in whole-dollar increments), there's
200,000 possible places to put any given dollar. If we have 100,000
USD to spend, that's:</p>
<p>$${2 \cdot 10^{5} \choose 10^{5}} = \frac{(2 \cdot 10^{5})!}{10^{5}! \cdot 10^{5}!} \approx 10^{60203}$$</p>
<p>That is a very big number. I needed logarithms to compute it. It is so
huge that it makes the number of atoms in the observable universe
(about \(10^{80}\)) look like rounding error.</p>
<p>In an attempt to "fix" that problem, I tried only handing out funds in
chunks of 100 USD each. Then, we have 1000 chunks to hand out and 2000
places to put them:</p>
<p>$${2000 \choose 1000} = \frac{2000!}{1000! \cdot 1000!} \approx 10^{600}$$</p>
<p>I have made the problem 59,603 decimal orders of magnitude easier!
Rejoice!</p>
<p>A constraint solver really doesn't "know" anything about the structure
of the problem you're feeding it. That's a trade-off: in return, it
grants you a lot of freedom in expressing your problem. Constraint
solvers like LoCo are very valuable, they just aren't a good fit for
this problem. They are designed for problems where the constraints
really constraining the solution space. We're clearly not in that
territory. We have many valid solutions, and we're struggling to look
for a <em>good</em> one.</p>
<p>There are two ways we can fix this:</p>
<ol>
<li>Compromising on the freedom of expressing the problem. By pouring
   our problem into a specific structured shape, we may be able to use
   a much faster solver, specific to that class of problems. Also, by
   allowing arbitrary real numbers instead of just integers, we can
   use much faster solvers.</li>
<li>Compromising on finding the <em>optimal</em> solution, instead searching
   for a <em>decent</em> solution. You can do that with algorithms like tabu
   search or simulated annealing.</li>
</ol>
<p>I will be elaborating on these problems in a future blog post.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2013/12/external-drive-lossage-on-mavericks.html" class="u-url">External drive lossage on Mavericks</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2013/12/external-drive-lossage-on-mavericks.html" rel="bookmark"><time class="published dt-published" datetime="2013-12-18T11:22:00-08:00" title="2013-12-18 11:22">2013-12-18 11:22</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>Welp, my WD 1TB Passport drive borked. Seems to be a <a href="https://discussions.apple.com/thread/5475136">common issue on
Mavericks</a> with a select
number of drives, including this one, apparently...</p>
<p>Common themes:</p>
<ol>
<li>Started with OS X complaining at me because I supposedly ejected
the drive unsafely, even though the drive was still in the USB slot.</li>
<li>Drive isn't mounted automatically anymore. Console says filesystem
is busted: <code>17/12/13 20:18:35,000 kernel[0]: hfs: Runtime corruption
detected on My Passport, fsck will be forced on next mount.</code>
</li>
<li>Drive can't be /unmounted/ using Disk Utility either both in
regular desktop mode and in recovery mode (booting with âŒ˜+R). This
means that even trying to just nuke the partition and starting over
doesn't work; it just sits there for a while and then eventually times
out saying it can't unmount the drive.</li>
</ol>
<p>I did not, at any point, have WD's drive management software installed
(unless it managed to do it behind my back). First thing I did was put
a new GUID table on it with one partition.</p>
<p>Apparently the solution is to boot into Linux to fix the drive. I'll
let you know how that pans out.</p>
<p>UPDATE: Booted into Linux, was able to read everything. <code>fsck</code> does
report something wrong with the filesystem, but not bad enough that I
can't mount or umount it. Was able to salvage what looks to be all the
data I wanted; didn't bother to try and get e.g. Time Machine or
Spotlight index data off, which is where I suspect the issues to stem
from.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2013/11/using-protractor-with-angularjs-and-yeoman.html" class="u-url">Using protractor with AngularJS and Yeoman</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2013/11/using-protractor-with-angularjs-and-yeoman.html" rel="bookmark"><time class="published dt-published" datetime="2013-11-15T11:29:00-08:00" title="2013-11-15 11:29">2013-11-15 11:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>In writing the website for Crypto 101, my upcoming book, I've been
toying around with AngularJS. The basic setup was done using Yeoman.</p>
<p>First of all, the Yeoman Angular generator gives you a
<code>karma-e2e.conf.js</code>, but doesn't really configure grunt to do any
end-to-end testing. Turns out that the new hotness for Angular
scenario testing is based on Protractor. Karma isn't deprecated, it's
just for unit tests. Protractor is based on Selenium, which is
probably an upgrade :-)</p>
<p>Anyway, here's what I had to do to get started.</p>
<ol>
<li>In the root of your app, install protractor and the Selenium
   standalone server.</li>
</ol>
<pre class="code literal-block"><span></span>npm install --save-dev protractor
./node_modules/protractor/bin/install_selenium_standalone
</pre>


<ol>
<li>
<p>Optionally, add <code>selenium</code> to your <code>.gitignore</code>, since it contains
   a ~30MB binary that doesn't belong in your git repo.</p>
</li>
<li>
<p>Add a <code>protractor.conf.js</code> file. Here's mine. Remember that there's
   some stuff in there for you to uncomment, so don't just copy paste.
   On my machine, the default driver was Internet Explorer for
   Windows, which is strange given that I'm running on OS X. Oh well.
   This uses Chrome instead.</p>
</li>
</ol>
<pre class="code literal-block"><span></span><span class="nx">exports</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">seleniumAddress</span><span class="o">:</span> <span class="s1">'http://localhost:4444/wd/hub'</span><span class="p">,</span>
  <span class="nx">specs</span><span class="o">:</span> <span class="p">[</span>
    <span class="c1">// To run plain JS files, uncomment the following line:</span>
    <span class="c1">// './test/integration/*.js',</span>
    <span class="c1">// To run Coffeescript files, uncomment the following line:</span>
    <span class="c1">// '.tmp/integration/*.js'</span>
  <span class="p">],</span>

  <span class="c1">// Set capabilities.</span>
  <span class="nx">capabilities</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">'browserName'</span><span class="o">:</span> <span class="s1">'chrome'</span>
  <span class="p">},</span>

  <span class="nx">jasmineNodeOpts</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">showColors</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">defaultTimeoutInterval</span><span class="o">:</span> <span class="mi">30000</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>


<ol>
<li>If you're using Coffeescript, change your Gruntfile to build your
   integration tests:</li>
</ol>
<pre class="code literal-block"><span></span>  grunt.initConfig({
    // ...
    coffee: {
      // ...
      test: {
        files: [
        // ...
        {
          expand: true,
          cwd: 'test/integration',
          src: '{,*/}*.coffee',
          dest: '.tmp/integration',
          ext: '.js'
        }]
      }
    },
  // ...
})
</pre>


<ol>
<li>
<p>Write some tests in <code>test/integration</code>.</p>
</li>
<li>
<p>You can now manually run your tests. First run Selenium:</p>
</li>
</ol>
<pre class="code literal-block"><span></span>./node_modules/protractor/bin/install_selenium_standalone
</pre>


<p>Then run your tests:</p>
<pre class="code literal-block"><span></span>./node_modules/protractor/bin/protractor protractor.conf.js
</pre>


<p>Once I figure out the proper way to do this in Grunt, I'll let you
know.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2013/10/thoughts-on-rdrand-in-linux.html" class="u-url">Thoughts on RDRAND in Linux</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2013/10/thoughts-on-rdrand-in-linux.html" rel="bookmark"><time class="published dt-published" datetime="2013-10-19T21:47:00-07:00" title="2013-10-19 21:47">2013-10-19 21:47</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>This has been brewing since I read <a href="https://www.change.org/en-GB/petitions/linus-torvalds-remove-rdrand-from-dev-random-4/responses/9066">Linus' response to the petition to
remove <code>RDRAND</code> from /dev/random</a>.</p>
<p>For those of you who don't know, <code>RDRAND</code> is a CPU instruction
introduced by Intel on recent CPUs. It (supposedly) uses a hardware
entropy source, and runs it through AES in CBC-MAC mode, to produce
random numbers.</p>
<p>Out of fear that <code>RDRAND</code> may somehow be backdoored, someone
petitioned to remove <code>RDRAND</code> support to "improve the overall security
of the kernel". If <code>RDRAND</code> contains a back door, and an unknown
attacker can control the output, that could break pretty much all
userland crypto.</p>
<p>Linus fulminated, as he is wont to do. He suggested we go read
<code>drivers/char/random.c</code>. I quote (expletives and insults omitted):</p>
<blockquote>
<p>we use rdrand as <em>one</em> of many inputs into the random pool, and we
use it as a way to <em>improve</em> that random pool. So even if rdrand
were to be back-doored by the NSA, our use of rdrand actually
improves the quality of the random numbers you get from
/dev/random.</p>
</blockquote>
<p>I went ahead and read <code>random.c</code>. You can read it for yourself <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/char/random.c">in
Linus' tree</a>.</p>
<p>Disclaimer: I am not an expert in this piece of code. I have no doubt
Linus is far more familiar with it than I am. I'd love to be proven
wrong. I'm just taking his advice and reading some code.</p>
<p>The function I'm interested in is <code>extract_buf</code>:</p>
<pre class="code literal-block"><span></span>    <span class="cm">/*</span>
<span class="cm">     * If we have a architectural hardware random number</span>
<span class="cm">     * generator, mix that in, too.</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LONGS</span><span class="p">(</span><span class="n">EXTRACT_SIZE</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arch_get_random_long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">hash</span><span class="p">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">v</span><span class="p">;</span>
    <span class="p">}</span>
</pre>


<p>This is in the extraction phase. This is after the hash is being mixed
back in to the pool (and that's for backtracking attacks: not intended
as an input to the pool). It seems to me like the output of
<code>arch_get_random_long</code> is being XORed in with the extracted output,
not with the pool.</p>
<p>If I were to put on my tin-foil hat, I would suggest that the
difficulty has now been moved from being able to subvert the pool as
one of its entropy sources (which we think is impossible), versus
being able to see what you're about to be XORed with. The latter seems
a lot closer to the realm of stuff a microcode instruction can do.</p>
<p>To put it into Python:</p>
<pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">currentframe</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">getrandbits</span>

<span class="k">def</span> <span class="nf">extract_buf</span><span class="p">():</span>
    <span class="sd">"""Gets 16 bytes from the pool, and mixes them with RDRAND output.</span>

<span class="sd">    """</span>
    <span class="n">pool_bits</span> <span class="o">=</span> <span class="n">extract_from_pool</span><span class="p">()</span>
    <span class="n">rdrand_bits</span> <span class="o">=</span> <span class="n">rdrand</span><span class="p">()</span>
    <span class="k">return</span>  <span class="n">pool_bits</span> <span class="o">^</span> <span class="n">rdrand_bits</span>

<span class="k">def</span> <span class="nf">extract_from_pool</span><span class="p">():</span>
    <span class="sd">"""Pretend to get some good, unpredictable bytes from the pool.</span>

<span class="sd">    Actually gets a long with some non-cryptographically secure random</span>
<span class="sd">    bits from random.getrandbits, which is usually a Mersenne Twister.</span>

<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rdrand</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    A malicious hardware instruction.</span>
<span class="sd">    """</span>
    <span class="n">pool_bits</span> <span class="o">=</span> <span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">"pool_bits"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pool_bits</span> <span class="o">^</span> <span class="mh">0xabad1dea</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">extract_buf</span><span class="p">()</span> <span class="o">==</span> <span class="mh">0xabad1dea</span>
</pre>


<p>Why can't RDRAND work like this?</p>
<p>Some comments based on feedback I've gotten so far:</p>
<ol>
<li>This attack does not need to know where the PRNG state lives in
memory. First of all, this isn't an attack on the PRNG state, it's on
the PRNG output. Secondly, the instruction only needs to peek ahead at
what is about to happen (specifically, what's about to be XORed with)
the RDRAND output. That doesn't require knowing where the PRNG state
(or its output) is being stored in memory; we're already talking
register level at that point.</li>
<li>While it's certainly true that if you can't trust the CPU, you
can't trust anything, that doesn't really make this problem go away.
<code>RDRAND</code> being broken wouldn't make software crash, which is a lot
harder for almost all other instructions. <code>RDRAND</code> being broken
wouldn't result in measurable side-effects, unlike what would happen
if <code>PCLMULDQ</code> contained a back door. Furthermore, it's a lot easier to
backdoor one single microcode instruction and a lot more plausible and
feasible for a CSPRNG to be backdoored than it is to think of a CPU as
some kind of intelligent being that's actively malicious or being
remotely controlled.</li>
</ol>
<p>For what it's worth, it seems <a href="https://twitter.com/zooko/status/392334674690723840">Zooko agrees with me</a>.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2013/01/securing-against-timing-attacks-with-twisted.html" class="u-url">Securing against timing attacks with Twisted</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2013/01/securing-against-timing-attacks-with-twisted.html" rel="bookmark"><time class="published dt-published" datetime="2013-01-30T18:55:00-08:00" title="2013-01-30 18:55">2013-01-30 18:55</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<h3>What are timing attacks?</h3>
<p>Timing attacks are side-channel attacks that rely on inferring secret
information from operations by measuring how long they take to execute.</p>
<p>A complete explanation is outside of the scope of this article, but
the <a href="https://en.wikipedia.org/wiki/Timing_attack">Wikipedia article</a>
might be a good starting point for the interested reader.</p>
<h3>Why should I care about them?</h3>
<p>Because they can creep in before you know it, and break your otherwise
fine system.</p>
<p>A common way they're introduced are string comparisons. String
comparisons in many langauge implementations, including all
implementations of Python I know of, short-circuit. They work roughly
like this:</p>
<pre class="code literal-block"><span></span><span class="k">def</span> <span class="nf">strcmp</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s2</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c1</span> <span class="o">!=</span> <span class="n">c2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>
</pre>


<p>This means that as soon as they can prove the two strings are not
equal, they return <code>False</code> and ignore the rest of the string. This is
a very simple and effective performance optimization. And that's
precisely why, from a security point of view, it's a liability.</p>
<p>Since it takes longer to compare "The quick brown fox jumps over the
lazy dog" to "The quick brown fox jumps over the lazy god" than it
does to compare it to "Lorem ipsum", or even a Lipsum of the same
length, an attacker can use that timing information to figure out what
the original string is that is being compared to, even when he
shouldn't.</p>
<h3>Why did you care?</h3>
<p>Password resets.</p>
<p>The typically recommended way of doing them is to generate a random
number, one that's sufficiently long that an attacker can't guess it.
Then, you relay that number to the user using some alternative channel
(usually a URL in an e-mail).</p>
<p>Bar the random number, those URLs are predictable. That means an
attacker can trivially try any number he wants. If an attacker is
allowed to do that enough, he could measure timing differences between
different numbers (introduced by string comparison functions that
short-circuit or even by the database's index) to efficiently deduce
the value of a "good" number.</p>
<p>Also, if membership is private, an attacker may exploit timing
differences in the password reset <em>request</em> function to farm e-mail
addresses.</p>
<h3>How do I protect against timing attacks?</h3>
<p>Just to be clear: timing attacks are a complicated problem, and this
article describes just one strategy I've applied to help secure
against them.</p>
<p>The easiest way to prevent a timing attack is to make sure that the
timing your hypothetical attacker can measure is unrelated to the work
you have to do.</p>
<p>Since I was using <a href="http://twistedmatrix.com">Twisted</a> and
<a href="http://amp-protocol.net/">AMP</a>, this was actually quite easy. I wrote
a decorator for AMP responder functions that does exactly that:</p>
<pre class="code literal-block"><span></span><span class="k">def</span> <span class="nf">_immediateResponder</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A decorator for responder functions that should return immediately and</span>
<span class="sd">    execute asynchronously, as a defense against timing attacks.</span>

<span class="sd">    The responder decorator should be applied after (above) this decorator::</span>

<span class="sd">        @SomeCommand.responder</span>
<span class="sd">        @_immediateResponder</span>
<span class="sd">        def responder(...):</span>
<span class="sd">            ....</span>

<span class="sd">    This should be timing attack resistant since it is unconditional: the</span>
<span class="sd">    the AMP response is returned immediately, and the real responder is</span>
<span class="sd">    scheduled to run at the next chance the reactor has to do so.</span>

<span class="sd">    This only works with AMP commands with empty responses. That's probably a</span>
<span class="sd">    good idea anyway: almost all information you could add to the response</span>
<span class="sd">    is liable to introduce a timing attack vulnerability.</span>

<span class="sd">    Since this precludes your ability to communicate success or failure to</span>
<span class="sd">    the caller, the decorated function should return quite quickly (or, if it</span>
<span class="sd">    can't, that should be clearly documented). Otherwise, you may end up in a</span>
<span class="sd">    a race condition, where the caller assumes the operation has completed,</span>
<span class="sd">    but it is in progress or hasn't started yet.</span>

<span class="sd">    The original responder function is available on the decorated function as</span>
<span class="sd">    the ``responderFunction`` attribute.</span>
<span class="sd">    """</span>
    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">wrapped</span><span class="o">.</span><span class="n">responderFunction</span> <span class="o">=</span> <span class="n">f</span>
    <span class="k">return</span> <span class="n">wrapped</span>
</pre>


<p>When I get an incoming RPC call, the function doing the actual work is
scheduled to run at the next reactor iteration. Then, an empty
response is returned. All of this happens in amortized constant time,
and independent of any secrets. As a result, it can't really leak
much about them.</p>
<h3>An abstraction too high</h3>
<p>The above was an effective response to a proof-of-concept timing
attack exploit. Unfortunately, that doesn't mean you've fixed every
timing attack.</p>
<p>In particular, this example is a few layers of abstraction removed
from the grit of real-world I/O. Just because I returned <code>{}</code> (an
empty response) immediately, doesn't mean the underlying IO happens
immediately.</p>
<p>In particular, the write output latency could be coerced to depend on
the computation time, because the function passed to it could be
executed before the <code>write</code>. If that happens, and the time it takes is
dependant on some secret, delaying the write, the latency on the
attacker's side could be used to measure the work done.</p>
<p>I have not yet been able to turn the above into a working exploit.</p>
<p>There are a number of ways this could be mitigated. Since there's no
working exploit, it's unclear if this mitigation would render a timing
attack infeasible.</p>
<p>One way I've considered to mitigate this is to limit the time that the
reactor is blocked. In my concrete example, this was fortunately
already the case, since one of the first things it did was defer to a
thread that released the GIL (to compute the key from the password
using <code>scrypt</code>). Alternatively, if you're doing this for Python
code, you could write your function cooperatively.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2013/01/moving-to-octopress-on-github-pages.html" class="u-url">Moving to Octopress on Github Pages</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2013/01/moving-to-octopress-on-github-pages.html" rel="bookmark"><time class="published dt-published" datetime="2013-01-28T10:58:00-08:00" title="2013-01-28 10:58">2013-01-28 10:58</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>Long overdue, I'm told.</p>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/2011/11/designing-a-rest-api-logging-in.html" class="u-url">Designing a REST API: logging in</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                lvh
            </span></p>
            <p class="dateline"><a href="posts/2011/11/designing-a-rest-api-logging-in.html" rel="bookmark"><time class="published dt-published" datetime="2011-11-27T13:37:00-08:00" title="2011-11-27 13:37">2011-11-27 13:37</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<div>Hey. As many of you probably know, I'm building a business, and that business involves a REST API being consumed by browsers (for now).</div>

<p></p>
<div>The problem I'm hitting is registration and logging in. It just doesn't seem to be a problem that fits REST very well -- maybe I'm thinking too much about services and not enough about resources, so I'm writing this blog posts to get my thoughts in order and hopefully get some useful feedback.</div>
<p></p>
<div>This post is about user registration and login, and how they're hard to fit into REST.</div>
<p></p>
<div>Context: users are uniquely identified by a user id, which is a random string of sufficient size. These ids are immutable and uniquely refer to this user from registration until forever. User emails are also unique, but they can change, so they are not a good way to refer to a user. Users register and log in using email and password.</div>
<p></p>
<div><strong><span style="font-size: medium;">Option 1: separate authentication endpoint</span></strong></div>
<p></p>
<div>The idea here is that there are two things:</div>
<div>
<ul>
<li>the REST API, which authenticated things talk to</li>
<li>the authentication endpoint, where unauthenticated things go to become authenticated</li>
</ul>
The downside is that there are two things. One of them speaks REST, and the other speaks gnarly ad-hoc RPC or maybe JSON-RPC or something.</div>
<p></p>
<div>The upside is that the REST API only needs to understand one kind of token.</div>
<p></p>
<div><span style="font-size: medium;"><strong>Option 2: everything in REST</strong></span></div>
<p></p>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">Special cases aren't special enough to break the rules.</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">-- Zen of Python</blockquote>
<p></p>
<div>The advantage is that there is one canonical source for everything. Everything including access grants (which should be nice for OAuth later). You can use the REST API to perform any action, see anything in the system...</div>
<p></p>
<div>The downsides:</div>
<div>
<ul>
<li>the REST API has to understand more than one kind of authentication. This also might make it a bit uglier to interoperate with OAuth later.</li>
<li>Logging in takes too many round trips. First I have to query <span style="font-family: courier new,monospace;">users/?email={EMAIL}</span><span style="font-family: arial,helvetica,sans-serif;">Â to go from e-mail address to user id. Then, I have to POST to users/accessGrants -- which is if I'm allowed to guess the URL, which I really shouldn't, I should GET users/ first (HATEOAS and all that -- but I'm willing to ignore that for now). All of this happens over HTTPS with HTTP Basic auth. TLS handshakes are slow, and verifying securely stored passwords is even slower.</span>
</li>
</ul>
</div>
<p></p>
<div><strong><span style="font-size: medium;">Option 2b: everything in REST, with shortcuts</span></strong></div>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">Although practicality beats purity.</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">-- Zen of PythonÂ </blockquote>
<div>... but, unfortunately, also:</div>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">
<div>There should be one-- and preferably only one --obvious way to do it.</div>
</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">-- Zen of PythonÂ </blockquote>
<p></p>
<div>The upsides are the same as for the REST API, except we get rid of the downside that logging in takes too many round trips, because there's a shortcut for that.</div>
<p></p>
<div>That shortcut would be something that speaks some kind of ad-hoccy RPC, or possibly JSON-RPC. One of the exported methods/procedures would be "getGrant", which takes a username and password and returns the key. These endpoints talk to the same database behind the scenes. Killer feature: one round trip.</div>
<p></p>
<div>Downside is that the API should probably still be able to take user credentials, since this is is a shortcut....</div>
<p></p>
<div>Yes, I know OAuth exists. For now, we have no interest in opening this API up yet. We'll do that as soon as we have a platform worth caring about, an API that doesn't change every three seconds, and a security expert that's reviewed it.</div>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-4.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script><script type="text/x-mathjax-config">
            MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']]}});
            </script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents Â© 2016         <a href="mailto:_@lvh.io">lvh</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36779422-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
