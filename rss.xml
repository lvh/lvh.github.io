<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>lvh</title><link>https://www.lvh.io/</link><description>lvh's blog</description><atom:link href="https://www.lvh.io/rss.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><lastBuildDate>Sat, 30 Nov 2019 18:11:52 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>Clojure and native-image on JDK 11-flavored GraalVM (19.3.0+)</title><link>https://www.lvh.io/posts/clojure-and-native-image-on-jdk-11-flavored-graalvm-1930%2B/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;p&gt;My takeaways from &lt;a href="https://www.graalvm.org/docs/release-notes/19_3/"&gt;the GraalVM 19.3.0 release notes&lt;/a&gt;:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;JDK code inlining support&lt;/li&gt;
&lt;li&gt;Optional JDK11 support&lt;/li&gt;
&lt;li&gt;Better Windows support&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;These may not seem like much, but JDK code inlining fixes my one major niggle
with native-image: it was too hard to get top-notch single-binary TLS, and
now it just works.&lt;/p&gt;
&lt;p&gt;(There are lots of other great things that happened in this release! They're
just not in parts of Graal I use.)&lt;/p&gt;
&lt;h2&gt;Updating to JDK 11&lt;/h2&gt;
&lt;p&gt;Updating to JDK 11 is optional, but you might as well get it over with now.&lt;/p&gt;
&lt;h3&gt;A brief summary of Jigsaw (JDK9+) breakage&lt;/h3&gt;
&lt;p&gt;There are two things that bit Clojure-using early adopters of JDK 9, both
consequences of &lt;a href="https://openjdk.java.net/projects/jigsaw/"&gt;Project Jigsaw&lt;/a&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The module system hiding previously-available classes&lt;/li&gt;
&lt;li&gt;Changes to the way classloaders work&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These two changes broke Clojure and a whole host of common libraries (mostly
because of the now-unavailable classes) and the two common build tools
(leiningen and boot, mostly because of the bootclassloader). These were quickly
resolved and only affect you now if you care about supporting a long range of
Clojure versions or a long range of JDKs. Since this blog post is about
native-image, your output is a standalone binary and you get to pick the JDK
version. However, you still need to know a bit about this background in order to
understand some of the workarounds necessary for supporting GraalVM native-image
targeting JDK11 and above. This is happening now because Graal was previously
targeting JDK8, avoiding all of these issues.&lt;/p&gt;
&lt;p&gt;The two classes that tend to come up that were often used but hidden in modules
are &lt;code&gt;java.sql.Timestamp&lt;/code&gt; and &lt;code&gt;javax.xml.bind.DatatypeConverter&lt;/code&gt;. Despite their
package names, they don't have anything to do with SQL or XML. Clojure used them
because &lt;code&gt;Timestamp&lt;/code&gt; was the good instant type (&lt;code&gt;java.util.Date&lt;/code&gt; being famously
bad), and &lt;code&gt;DatatypeConverter&lt;/code&gt; was the good Base64 implementation available
everywhere.&lt;/p&gt;
&lt;h3&gt;Example: DatatypeConverter in clj-http-lite&lt;/h3&gt;
&lt;p&gt;Outside of Clojure, clj-http and clj-http-lite used &lt;code&gt;DatatypeConverter&lt;/code&gt; as well
(also for base64). clj-http-lite is very popular in native-image Clojure
projects. Like other libraries, they were quickly patched to support JDK9. The
patch still attempted to import &lt;code&gt;DatatypeConverter&lt;/code&gt; (see &lt;a href="https://github.com/martinklepsch/clj-http-lite/commit/3f41fc53a1b692549c88a8602e753cfb887330ae"&gt;the actual patch in
clj-http-lite&lt;/a&gt;), because the Base64 implementation
replacing it isn't available on every JDK those libraries wanted to support.
Normally, this is fine: the import fails and the alternative library gets used.
However, the static analysis step in GraalVM sees the trial import and
complains:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;oracle&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;graal&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;pointsto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;constraints&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;UnresolvedElementException&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Discovered&lt;/span&gt; &lt;span class="n"&gt;unresolved&lt;/span&gt; &lt;span class="n"&gt;type&lt;/span&gt; &lt;span class="n"&gt;during&lt;/span&gt; &lt;span class="n"&gt;parsing&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;javax&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;xml&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;bind&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;DatatypeConverter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="n"&gt;To&lt;/span&gt; &lt;span class="n"&gt;diagnose&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;issue&lt;/span&gt; &lt;span class="n"&gt;you&lt;/span&gt; &lt;span class="n"&gt;can&lt;/span&gt; &lt;span class="n"&gt;use&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;allow&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;incomplete&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;classpath&lt;/span&gt; &lt;span class="n"&gt;option&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="n"&gt;The&lt;/span&gt; &lt;span class="n"&gt;missing&lt;/span&gt; &lt;span class="n"&gt;type&lt;/span&gt; &lt;span class="k"&gt;is&lt;/span&gt; &lt;span class="n"&gt;then&lt;/span&gt; &lt;span class="n"&gt;reported&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="n"&gt;run&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="n"&gt;when&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="k"&gt;is&lt;/span&gt; &lt;span class="n"&gt;accessed&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;first&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;The classic workaround was to add the module back with &lt;code&gt;--add-modules
java.xml.bind&lt;/code&gt;. Since it's just a trial import (see patch), you can instead use
the workaround suggested in the error message (&lt;code&gt;--allow-incomplete-classpath&lt;/code&gt;)
and it'll work fine. The downside is this moves &lt;em&gt;all&lt;/em&gt; errors to runtime. There's
a &lt;a href="https://github.com/oracle/graal/issues/1664"&gt;Graal ticket&lt;/a&gt; for a more precise command line
argument limiting the suppressed error to that class. I'm confident there's
already a way to express this in Graal command line arguments, but I haven't
tried to figure out the right incantation yet.&lt;/p&gt;
&lt;h3&gt;Single binary TLS!&lt;/h3&gt;
&lt;p&gt;Once you fix the above issue with clj-http-lite, as long as you enable the TLS
subsystem (&lt;code&gt;--enable-https&lt;/code&gt;), you'll just get single-binary HTTPS with
libsunec.so under the hood, meaning I can finally close
&lt;a href="https://github.com/oracle/graal/issues/1336"&gt;#1336&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;&lt;code&gt;locking&lt;/code&gt; errors appear to be gone... sometimes?&lt;/h3&gt;
&lt;p&gt;Clojure 1.10+ introduces a dependency on clojure.spec. That library is unusual
because it uses the &lt;code&gt;locking&lt;/code&gt; macro. Ordinarily, the &lt;code&gt;locking&lt;/code&gt; macro is pretty
rare because Clojure has different, higher-level concurrency primitives.&lt;/p&gt;
&lt;p&gt;Bytecode verifiers that are more aggressive than those in the JDK would balk at
the resulting bytecode. Historically this was the Android toolchain, but the
issue resurfaced with Graal. This got documented in &lt;a href="https://clojure.atlassian.net/browse/CLJ-1472"&gt;CLJ-1472&lt;/a&gt;.
This issue had a whole myriad of workarounds that mostly involved replacing the
&lt;code&gt;locking&lt;/code&gt; implementation and then hooking clj loads with dynapath. The most
common workaround was to just downgrade Clojure to 1.9.0.&lt;/p&gt;
&lt;p&gt;With Graal 19.3.0, the error appears to have simply disappeared in my tests so
far. I don't know which Graal change precipitated this, but I'll happily take
being able to use the current release of Clojure without hacks. This
doesn't appear to be the case for everyone, so likely some combination of events
just made it harder to trigger the problem.&lt;/p&gt;
&lt;h2&gt;Example project&lt;/h2&gt;
&lt;p&gt;I updated &lt;a href="https://github.com/lvh/cljurl-graalvm-demo"&gt;cljurl-graalvm-demo&lt;/a&gt; if you want to try any of
this at home. If you're on Linux and want to debug the TLS issues, I wrote
&lt;a href="https://github.com/lvh/nscap"&gt;nscap&lt;/a&gt; specifically for this purpose. It leverages Linux namespaces to
elegantly capture network traffic for a single process. You can then throw the
resulting PCAP into e.g. wireshark.&lt;/p&gt;
&lt;h2&gt;What I'd still love to see in native-image&lt;/h2&gt;
&lt;p&gt;The compiler is slow. It's in the range of rustc speed: typically faster than
C++, certainly slower than Go. It eats a lot of RAM. It's fine because I don't
iterate on the binary version. I develop Clojure apps targeting native-image as
if they're normal Clojure apps and then eventually run some end-to-end tests on
the binary. But you knocked out my #1 feature so now I have a new one ğŸ˜Š&lt;/p&gt;&lt;/div&gt;</description><category>clojure</category><guid>https://www.lvh.io/posts/clojure-and-native-image-on-jdk-11-flavored-graalvm-1930%2B/</guid><pubDate>Sun, 24 Nov 2019 16:50:15 GMT</pubDate></item><item><title>Solving regex crosswords</title><link>https://www.lvh.io/posts/solving-regex-crosswords/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;p&gt;&lt;a href="https://regexcrossword.com/"&gt;Regex Crossword&lt;/a&gt; is a puzzle game to help you
practice regular expressions. I wrote a program to solve them. You can find it
on GitHub as &lt;a href="https://github.com/lvh/regex-crossword"&gt;&lt;code&gt;lvh/regex-crossword&lt;/code&gt;&lt;/a&gt;. If
you're on amd64 Linux, you can try the &lt;a href="https://github.com/lvh/regex-crossword/releases/tag/0.1.0"&gt;demo binary too&lt;/a&gt;. This blog post
walks you through how I wrote it using logic programming.&lt;/p&gt;
&lt;p&gt;To me this game feels more like Sudoku than a crossword. When you solve a
crossword, you start by filling out the words you're certain of and use those
answers as hints for the rest. Backtracking is relatively rare. In a sudoku, you
might start by filling out a handful of certain boxes, but in most puzzles you
quickly need to backtrack. That distinction shapes how I think of solving it:
searching and backtracking is a natural fit for logic programming.&lt;/p&gt;
&lt;p&gt;Logic programming is a niche technology, but in its sweet spot it's miraculous.
I'll introduce the concept to help you recognize what sorts of problems it's
good at. Worst case, you'll enjoy a cool hack. Best case you'll get the
satisfaction of writing a beautiful solution to a problem some time in the
future.&lt;/p&gt;
&lt;p&gt;My programming language of choice is Clojure, and Clojure has
&lt;a href="https://github.com/clojure/core.logic"&gt;&lt;code&gt;clojure/core.logic&lt;/code&gt;&lt;/a&gt;, a logic programming library. Because logic
programming is such a specialized tool, it's more useful to have libraries that
let you "drop in to" logic programming than to do everything in a full-blown
logic programming language.&lt;/p&gt;
&lt;h2&gt;Approach&lt;/h2&gt;
&lt;p&gt;It would not be a bad idea to read &lt;a href="https://regexcrossword.com/howtoplay"&gt;the instructions for Regex
Crossword&lt;/a&gt;. I'll also assume you have seen some basic regular
expressions. Hopefully the Clojure will be piecemeal enough you can
just follow along, but reading a tutorial wouldn't hurt.&lt;/p&gt;
&lt;p&gt;Let's take a look at the first beginner puzzle:&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://www.lvh.io/img/regex-crossword/beginner1.png" alt="the first regex crossword level in the Beginner set"&gt;
&lt;figcaption&gt;The first level in the Beginner set, &lt;a href="https://regexcrossword.com/challenges/beginner/puzzles/1"&gt;"Beatles"&lt;/a&gt;.&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Each regex part applies to some number of unknowns (empty boxes). The first row
regex &lt;code&gt;HE|LL|O+&lt;/code&gt; applies to the unknowns of the first row. The first column
regex &lt;code&gt;[^SPEAK]+&lt;/code&gt; applies to the unknowns of the first column. Both constrain
the top left unknown: we're counting on our logic programming engine at being
convenient for expressing that "cascading" of constraints.&lt;/p&gt;
&lt;p&gt;An unknown is just a logic variable in constraint logic programming. For brevity
we'll call them "lvars" (&lt;em&gt;[ell vars]&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;Rows, columns (and in later puzzles hexagon lines) are all just layout.
Fundamentally it's all just a regex applying to some lvars.&lt;/p&gt;
&lt;h2&gt;Breaking down regular expressions&lt;/h2&gt;
&lt;p&gt;Most regular expressions have structure, like &lt;code&gt;(AB|CD)XY&lt;/code&gt;. We'll solve this
problem recursively: if &lt;code&gt;(AB|CD)XY&lt;/code&gt; matches lvars &lt;code&gt;p, q, r, s&lt;/code&gt;, then presumably
&lt;code&gt;pq&lt;/code&gt; must match &lt;code&gt;AB|CD&lt;/code&gt; and &lt;code&gt;rs&lt;/code&gt; must match &lt;code&gt;XY&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;(There are some counterexamples to the idea that we can solve the entire problem
recursively! For example, backrefs within a regex would require a second pass,
and backrefs across regular expressions would require another top-level pass.
We'll deal with those later. There are ties to language theory here, but that's
a story for another day.)&lt;/p&gt;
&lt;p&gt;We'll parse the regular expression into a data structure that's easier to
handle. Fortunately, there's a piece of code out there that knows how to
generate strings matching a given regex, which has a parser we can reuse. That
parser is designed for Java's regular expression syntax. It's not quite
identical to that of JavaScript, but we're hoping that the puzzles avoid those
tricky edge cases for now.&lt;/p&gt;
&lt;p&gt;To parse, we use &lt;code&gt;[com.gfredericks.test.chuck.regexes :as cre]&lt;/code&gt;.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"HE|LL|O+"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt; (read: produces)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\H&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\E&lt;/span&gt;&lt;span class="p"&gt;})}&lt;/span&gt;
  &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\L&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\L&lt;/span&gt;&lt;span class="p"&gt;})}&lt;/span&gt;
  &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:repetition&lt;/span&gt;,
     &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\O&lt;/span&gt;&lt;span class="p"&gt;}]&lt;/span&gt;,
     &lt;span class="ss"&gt;:bounds&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;]})})}&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Progress! It is indeed an alternation (a or b) of a concatenation of H and E, or
L and L, or the letter O one or more times.&lt;/p&gt;
&lt;h2&gt;Logic machinery&lt;/h2&gt;
&lt;p&gt;The logic programming engine is going to search a tree of possibilities for
solutions that fit your constraints. Logic programming is inherently
declarative: instead of telling the computer how to find the answer, we describe
what the answer looks like.&lt;/p&gt;
&lt;p&gt;An lvar that doesn't have a value assigned to it yet (it could still be
anything) is called "fresh". An lvar with a definite value is called "bound".
There is nothing preventing your program from returning fresh variables: that
just means the answer that doesn't rely on what that lvar taking any particular
value (like the &lt;em&gt;x&lt;/em&gt; in &lt;em&gt;0x = 0&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;In core.logic, a program consists of a series of expressions called &lt;em&gt;goals&lt;/em&gt;.
&lt;code&gt;(l/== a b)&lt;/code&gt; is a goal to make the values of &lt;code&gt;a&lt;/code&gt; and &lt;code&gt;b&lt;/code&gt; equal. It does not, by
itself, compare &lt;code&gt;a&lt;/code&gt; to &lt;code&gt;b&lt;/code&gt; or assign anything to anything. It just expresses the
idea of comparing the two. Logic programming calls this "unification".&lt;/p&gt;
&lt;p&gt;As the engine searches the space of possible answers, sometimes &lt;code&gt;a&lt;/code&gt; will be
equal to &lt;code&gt;b&lt;/code&gt; already, or &lt;code&gt;a&lt;/code&gt; will be bound and &lt;code&gt;b&lt;/code&gt; will be fresh in which case
&lt;code&gt;b&lt;/code&gt; will become bound to whatever &lt;code&gt;a&lt;/code&gt; was bound to. Either way, the two
variables can be &lt;em&gt;unified&lt;/em&gt; and the goal is said to &lt;em&gt;succeed&lt;/em&gt;. But in many parts
of the tree this doesn't work out: &lt;code&gt;a&lt;/code&gt; and &lt;code&gt;b&lt;/code&gt; will already be bound to
incompatible values. In that case, the goal is said to fail. Unification is just
one of many goals, but it's the most important one in most programs including
ours.&lt;/p&gt;
&lt;p&gt;Finally, we need a way to actually run the logic programming engine. that's
&lt;code&gt;clojure.core.logic/run&lt;/code&gt;'s job. Something like:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;            &lt;span class="c1"&gt;;; run to find up to one answer with logic vars [q]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/==&lt;/span&gt; &lt;span class="nv"&gt;q&lt;/span&gt; &lt;span class="ss"&gt;'fred&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;        &lt;span class="c1"&gt;;; where q is unified with 'fred&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;... will return &lt;code&gt;('fred)&lt;/code&gt; (the 1-list with the symbol &lt;code&gt;'fred&lt;/code&gt; in it) because
there's only one answer for &lt;code&gt;q&lt;/code&gt; that makes all the goals (here just one goal)
succeed. &lt;code&gt;run&lt;/code&gt; takes the &lt;em&gt;maximum number of answers&lt;/em&gt; as a parameter. Since
you're describing what the answer looks like, there might be zero, one, or any
other number of answers. Sometimes the engine will be able to prove there are no
other options (because the search was exhaustive) and it'll return fewer. Some
programs run forever, some so long it might as well be forever. &lt;code&gt;run&lt;/code&gt; has a
sibling &lt;code&gt;run*&lt;/code&gt; that gets you all the answers. It returns the same result,
because there's only one value for &lt;code&gt;q&lt;/code&gt; that makes all goals succeed.&lt;/p&gt;
&lt;h2&gt;Character match&lt;/h2&gt;
&lt;p&gt;The simplest possible regular expression is just a character, which matches
itself: &lt;code&gt;A&lt;/code&gt;. In our parse tree, this is an entry of &lt;code&gt;:type&lt;/code&gt; &lt;code&gt;:character&lt;/code&gt;. We'll
write a multimethod dispatching on &lt;code&gt;:type&lt;/code&gt; to make this work so we can implement
other types later.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmulti &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:type&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;A character looks like this: &lt;code&gt;{:type :character, :character \L}&lt;/code&gt;. We'll use
destructuring to extract the &lt;code&gt;:character&lt;/code&gt; key. In general, this multimethod will
take multiple lvars, though incidentally in the case of &lt;code&gt;:character&lt;/code&gt; it'll
be just one, so we can destructure it as well.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;character&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;lvar&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/==&lt;/span&gt; &lt;span class="nv"&gt;character&lt;/span&gt; &lt;span class="nv"&gt;lvar&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;We'll write a test to verify this works.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/deftest&lt;/span&gt; &lt;span class="nv"&gt;re-&amp;gt;goal-character-test&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;])))))&lt;/span&gt;
&lt;/pre&gt;


&lt;h2&gt;Alternation&lt;/h2&gt;
&lt;p&gt;Let's look at a few parse trees for some simple alternations:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"A|B"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;, &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;})}&lt;/span&gt;
  &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;, &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;})})}&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Here's an example where the options are different length.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"AAA|B"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;})}&lt;/span&gt;
  &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;
   &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;})})}&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;It's also probably a good idea to consider something with more than two alternatives:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"A|B|C"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;, &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;})}&lt;/span&gt;
  &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;, &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;})}&lt;/span&gt;
  &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;, &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\C&lt;/span&gt;&lt;span class="p"&gt;})})}&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Note the parser will always create concatenations as elements of alternations
even if the element is really just a single character. We can't handle
concatenations yet, so while we generally prefer things that the parser actually
produces, we'll cheat with an alternation of characters first.&lt;/p&gt;
&lt;h3&gt;Alternation in logic&lt;/h3&gt;
&lt;p&gt;The obvious test to write is:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/deftest&lt;/span&gt; &lt;span class="nv"&gt;re-&amp;gt;goal-alternation-test&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"A|B"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;])))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;... but as we saw above, that introduces concatenations. Instead:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="c1"&gt;;; "A|B" with the internal concatenations removed&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;
                            &lt;span class="ss"&gt;:elements&lt;/span&gt;
                            &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
                             &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;}]}&lt;/span&gt;
                           &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]))))&lt;/span&gt;

  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt; &lt;span class="sc"&gt;\C&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="c1"&gt;;; "A|B|C" with the internal concatenations removed&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;
                            &lt;span class="ss"&gt;:elements&lt;/span&gt;
                            &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
                             &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
                             &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\C&lt;/span&gt;&lt;span class="p"&gt;}]}&lt;/span&gt;
                           &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;We need a way to express disjunction. Like &lt;code&gt;l/and*&lt;/code&gt;, there's a &lt;code&gt;l/or*&lt;/code&gt;. Once we
have that, alternation is straightforward:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/or*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;%&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;This primer is a little unorthodox because we're walking through a problem that
requires rule generation. Most introductory texts make you build up static
rules. Disjunction is usually expressed with the macro &lt;code&gt;l/conde&lt;/code&gt;. One difference
is that &lt;code&gt;conde&lt;/code&gt; can express a disjunction of conjunctions in one go:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;conde&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;a&lt;/span&gt; &lt;span class="nv"&gt;b&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;c&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="c1"&gt;;; is equivalent to&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;or*&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="nf"&gt;and*&lt;/span&gt; &lt;span class="nv"&gt;a&lt;/span&gt; &lt;span class="nv"&gt;b&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;c&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;


&lt;h2&gt;Concatenation&lt;/h2&gt;
&lt;p&gt;We want to be able to solve squares, not just individual letters. The simplest
case is a concatenation of two characters, like &lt;code&gt;AA&lt;/code&gt;.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;def &lt;/span&gt;&lt;span class="nv"&gt;a&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;def &lt;/span&gt;&lt;span class="nv"&gt;aa&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt; &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;a&lt;/span&gt; &lt;span class="nv"&gt;a&lt;/span&gt;&lt;span class="p"&gt;]})&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/deftest&lt;/span&gt; &lt;span class="nv"&gt;re-&amp;gt;goal-concatenation-test&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt; &lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;aa&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt; &lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;])))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;A simple implementation passes this test:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;for &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;e&lt;/span&gt; &lt;span class="nv"&gt;elements&lt;/span&gt;
                &lt;span class="nv"&gt;v&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
            &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;e&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;v&lt;/span&gt;&lt;span class="p"&gt;]))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;(&lt;code&gt;l/and*&lt;/code&gt;is a function that returns a goal that succeeds when all its goals
succeed. We'd use the macro version &lt;code&gt;l/all&lt;/code&gt; if we were explicitly writing out
our goals. Because we're generating them, it's easier to use a function.)&lt;/p&gt;
&lt;p&gt;We're clearly abusing the fact that we happen to know that the parts are
characters and therefore length 1. But the parts could be repetitions, or an
alternation between concatenations each of length &amp;gt;1.&lt;/p&gt;
&lt;h3&gt;Distributing lvars over groups&lt;/h3&gt;
&lt;p&gt;Next, we need to find the ways lvars can be distributed over the individual
elements. We know that each lvar represents a square and each square must be
assigned, so we know that the sum of the lengths of the elements must be the
total number of lvars.&lt;/p&gt;
&lt;p&gt;We can actually solve this sub-problem using logic programming as well! We'll
use CLP(FD), which means "constraint logic programming over finite domains".&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;;; [clojure.core.logic.fd :as f]&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/fresh&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;x&lt;/span&gt; &lt;span class="nv"&gt;y&lt;/span&gt; &lt;span class="nv"&gt;z&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/==&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;x&lt;/span&gt; &lt;span class="nv"&gt;y&lt;/span&gt; &lt;span class="nv"&gt;z&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;f/in&lt;/span&gt; &lt;span class="nv"&gt;x&lt;/span&gt; &lt;span class="nv"&gt;y&lt;/span&gt; &lt;span class="nv"&gt;z&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;f/interval&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;f/eq&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;+ &lt;/span&gt;&lt;span class="nv"&gt;x&lt;/span&gt; &lt;span class="nv"&gt;y&lt;/span&gt; &lt;span class="nv"&gt;z&lt;/span&gt;&lt;span class="p"&gt;)))))&lt;/span&gt;

&lt;span class="c1"&gt;;; =&amp;gt; ([2 3 5] [3 2 5] [2 4 4] [2 5 3] [4 2 4] [3 3 4]&lt;/span&gt;
&lt;span class="c1"&gt;;;     [3 4 3] [5 2 3] [4 3 3] [3 5 2] [4 4 2] [5 3 2])&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;As mentioned before, the approach we've taken to this problem is unique because
we're &lt;em&gt;generating&lt;/em&gt; rules. Most logic programs have a static structure and
dynamic data, while our data informs the structure itself. We need to know how
many groups there are to know how many lvars to create with &lt;code&gt;fresh&lt;/code&gt;. &lt;code&gt;f/eq&lt;/code&gt; is
itself a convenience macro that rewrites "normal" Lisp-style equations (like &lt;code&gt;(=
10 (+ x y z))&lt;/code&gt;) to a form the logic engine knows how to solve directly.&lt;/p&gt;
&lt;p&gt;One way to solve that problem is with macros and &lt;code&gt;eval&lt;/code&gt;, but that might impede our
ability to port to e.g. ClojureScript and native-image. Plus, I wanted to learn
more about how the finite domain magic works internally.&lt;/p&gt;
&lt;p&gt;The main thing &lt;code&gt;f/eq&lt;/code&gt; does here is introduce intermediate variables. The
underlying goal &lt;code&gt;f/+&lt;/code&gt; only takes 3 arguments: two summands and a sum result. To
express a sum over many summands you need intermediate "running total" lvars. I
wrote that:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defn &lt;/span&gt;&lt;span class="nv"&gt;reduceo&lt;/span&gt;
  &lt;span class="s"&gt;"Given a binary operator goal, return an n-ary one.&lt;/span&gt;

&lt;span class="s"&gt;  If the given goal has shape `(âŠ• x y z)` meaning `x âŠ• y = z`, `(reduceo âŠ• z&lt;/span&gt;
&lt;span class="s"&gt;  vars)` computes `z = vars[0] âŠ• vars[1] âŠ• vars[2]...`."&lt;/span&gt;
  &lt;span class="c1"&gt;;; lower case are input vars (a, b, c, d...)&lt;/span&gt;
  &lt;span class="c1"&gt;;; upper case are intermediate accumulator lvars ("running totals")&lt;/span&gt;
  &lt;span class="c1"&gt;;; Î© is the final result&lt;/span&gt;
  &lt;span class="c1"&gt;;;     a âŠ• b = A&lt;/span&gt;
  &lt;span class="c1"&gt;;;     A âŠ• c = B&lt;/span&gt;
  &lt;span class="c1"&gt;;;       ...&lt;/span&gt;
  &lt;span class="c1"&gt;;;     W âŠ• y = X&lt;/span&gt;
  &lt;span class="c1"&gt;;;     X âŠ• z = Î©&lt;/span&gt;
  &lt;span class="c1"&gt;;;     |   |   |&lt;/span&gt;
  &lt;span class="c1"&gt;;;     |   |   \_ (concat accumulators (list result))&lt;/span&gt;
  &lt;span class="c1"&gt;;;     |   \_ (rest lvars)&lt;/span&gt;
  &lt;span class="c1"&gt;;;     \_ (cons (first lvars) (butlast accumulators))&lt;/span&gt;
  &lt;span class="c1"&gt;;;&lt;/span&gt;
  &lt;span class="c1"&gt;;; There are two fewer accumulators than there are input lvars. The middle&lt;/span&gt;
  &lt;span class="c1"&gt;;; equations all use 2 accumulators each: one to carry the previous result and&lt;/span&gt;
  &lt;span class="c1"&gt;;; one to carry it to the next equation. The first equation uses 2 input vars&lt;/span&gt;
  &lt;span class="c1"&gt;;; and 1 accumulator, and the last equation uses 1 input var, 1 accumulator&lt;/span&gt;
  &lt;span class="c1"&gt;;; and the result (which may be an lvar, but it's not _our_ lvar -- and in&lt;/span&gt;
  &lt;span class="c1"&gt;;; common uses we expect it to be a normal value).&lt;/span&gt;
  &lt;span class="c1"&gt;;;&lt;/span&gt;
  &lt;span class="c1"&gt;;; We don't need the butlast because map will only use the shortest coll argument.&lt;/span&gt;
  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;binop&lt;/span&gt; &lt;span class="nv"&gt;result&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;results&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;-&amp;gt; &lt;/span&gt;&lt;span class="nv"&gt;lvars&lt;/span&gt; &lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;- &lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;repeatedly&lt;/span&gt; &lt;span class="nv"&gt;l/lvar&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;conj &lt;/span&gt;&lt;span class="nv"&gt;result&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;reverse&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nb"&gt;lefts &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;cons &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;first &lt;/span&gt;&lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;results&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nb"&gt;rights &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;rest &lt;/span&gt;&lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="nv"&gt;binop&lt;/span&gt; &lt;span class="nb"&gt;lefts rights &lt;/span&gt;&lt;span class="nv"&gt;results&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;This lets us define a sum goal and a helper function that runs the logic engine
for us to find all the ways we can sum up to a number, with some bounds:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;def &lt;/span&gt;&lt;span class="nv"&gt;sumo&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;partial &lt;/span&gt;&lt;span class="nv"&gt;reduceo&lt;/span&gt; &lt;span class="nv"&gt;f/+&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defn &lt;/span&gt;&lt;span class="nv"&gt;summands&lt;/span&gt;
  &lt;span class="s"&gt;"Find ways you can add some numbers up to a given total.&lt;/span&gt;

&lt;span class="s"&gt;  For each number (summand) provide bounds `[min max]` or `nil` if you don't&lt;/span&gt;
&lt;span class="s"&gt;  know. Possible assignments are returned in the same order."&lt;/span&gt;
  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;total&lt;/span&gt; &lt;span class="nv"&gt;bounds&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;lvars&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;repeatedly&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="nv"&gt;bounds&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;l/lvar&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nv"&gt;bounds-goals&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;map&lt;/span&gt;
                      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;fn &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;v&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;min &lt;/span&gt;&lt;span class="nv"&gt;max&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
                        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;f/in&lt;/span&gt; &lt;span class="nv"&gt;v&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;f/interval&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;or min &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;or max &lt;/span&gt;&lt;span class="nv"&gt;total&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
                      &lt;span class="nv"&gt;lvars&lt;/span&gt; &lt;span class="nv"&gt;bounds&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/==&lt;/span&gt; &lt;span class="nv"&gt;q&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt; &lt;span class="nv"&gt;bounds-goals&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;sumo&lt;/span&gt; &lt;span class="nv"&gt;total&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Finally we need a way to use these weights to partition up a collection:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defn &lt;/span&gt;&lt;span class="nv"&gt;partition-by-weights&lt;/span&gt;
  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;weights&lt;/span&gt; &lt;span class="nv"&gt;coll&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;loop &lt;/span&gt;&lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="nv"&gt;weight&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="nv"&gt;rest-weights&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="nv"&gt;weights&lt;/span&gt;
         &lt;span class="nv"&gt;coll&lt;/span&gt; &lt;span class="nv"&gt;coll&lt;/span&gt;
         &lt;span class="nv"&gt;acc&lt;/span&gt; &lt;span class="p"&gt;[]]&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;some?&lt;/span&gt; &lt;span class="nv"&gt;weight&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;recur&lt;/span&gt;
       &lt;span class="nv"&gt;rest-weights&lt;/span&gt;
       &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;drop &lt;/span&gt;&lt;span class="nv"&gt;weight&lt;/span&gt; &lt;span class="nv"&gt;coll&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
       &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;conj &lt;/span&gt;&lt;span class="nv"&gt;acc&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;take &lt;/span&gt;&lt;span class="nv"&gt;weight&lt;/span&gt; &lt;span class="nv"&gt;coll&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
      &lt;span class="nv"&gt;acc&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;There's an alternative way to write this using &lt;code&gt;appendo&lt;/code&gt;: &lt;code&gt;(l/appendo a b c)&lt;/code&gt; is
like &lt;code&gt;append&lt;/code&gt; but for lvars. You can create a version that supports multiple
lists (let's call it &lt;code&gt;concato&lt;/code&gt;) using the same machinery:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;def &lt;/span&gt;&lt;span class="nv"&gt;concato&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;partial &lt;/span&gt;&lt;span class="nv"&gt;reduceo&lt;/span&gt; &lt;span class="nv"&gt;l/appendo&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;In a sense &lt;code&gt;concato&lt;/code&gt; is more direct: the lists are the lists you want, there's
no &lt;code&gt;partition-by-weights&lt;/code&gt; to translate from your numeric answer to the list
partitions you need. With all of these goals in place we can implement
concatenation. We find each possible weight distribution, and for each
distribution, each group must match that set of lvars.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;n-vars&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nv"&gt;n-elems&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nv"&gt;bounds&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="nv"&gt;n-vars&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/or*&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;for &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;weights&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;summands&lt;/span&gt; &lt;span class="nv"&gt;n-vars&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;repeat &lt;/span&gt;&lt;span class="nv"&gt;n-elems&lt;/span&gt; &lt;span class="nv"&gt;bounds&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
           &lt;span class="ss"&gt;:let&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;lvar-groups&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;partition-by-weights&lt;/span&gt; &lt;span class="nv"&gt;weights&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)]]&lt;/span&gt;
       &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;elements&lt;/span&gt; &lt;span class="nv"&gt;lvar-groups&lt;/span&gt;&lt;span class="p"&gt;))))))&lt;/span&gt;
&lt;/pre&gt;


&lt;h2&gt;Fixing :character&lt;/h2&gt;
&lt;p&gt;What the concatenation problem tells us is that character is broken, too.
Concatenation may attempt to assign 2 lvars to a single character. Right now,
that returns a goal unifying the first lvar with that character: if there were
more, the remaining lvars would simply go unconstrained:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;character&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;lvar&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/==&lt;/span&gt; &lt;span class="nv"&gt;character&lt;/span&gt; &lt;span class="nv"&gt;lvar&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;We communicate a problem with a failing goal. If some goal fails, the engine
will stop exploring that branch. The always-failing goal &lt;code&gt;l/fail&lt;/code&gt; is designed
for this sort of thing. (You can probably guess what its counterpart &lt;code&gt;l/succeed&lt;/code&gt;
does.) The amended version looks like this:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;character&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;lvar&lt;/span&gt; &lt;span class="ss"&gt;:as&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;-&amp;gt; &lt;/span&gt;&lt;span class="nv"&gt;lvars&lt;/span&gt; &lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/==&lt;/span&gt; &lt;span class="nv"&gt;character&lt;/span&gt; &lt;span class="nv"&gt;lvar&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="nv"&gt;l/fail&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;You could also do this in logic programming so that it's checked at runtime, but
since we're generating our goals ahead of time here and only giving them to the
engine at the end, we can short-circuit here.&lt;/p&gt;
&lt;h2&gt;Repetition&lt;/h2&gt;
&lt;h3&gt;Sample repetition parses&lt;/h3&gt;
&lt;p&gt;Let's see what the parser does for a few simple repetitions:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"A{1}"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:repetition&lt;/span&gt;,
     &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}]&lt;/span&gt;,
     &lt;span class="ss"&gt;:bounds&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="nv"&gt;N&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="nv"&gt;N&lt;/span&gt;&lt;span class="p"&gt;]})})}&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"A{1,}"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:repetition&lt;/span&gt;,
     &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}]&lt;/span&gt;,
     &lt;span class="ss"&gt;:bounds&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="nv"&gt;N&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;]})})}&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"A{1,2}"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:repetition&lt;/span&gt;,
     &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}]&lt;/span&gt;,
     &lt;span class="ss"&gt;:bounds&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="nv"&gt;N&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="nv"&gt;N&lt;/span&gt;&lt;span class="p"&gt;]})})}&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"A*"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:repetition&lt;/span&gt;,
     &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}]&lt;/span&gt;,
     &lt;span class="ss"&gt;:bounds&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;]})})}&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"A+"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:repetition&lt;/span&gt;,
     &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:character&lt;/span&gt;, &lt;span class="ss"&gt;:character&lt;/span&gt; &lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}]&lt;/span&gt;,
     &lt;span class="ss"&gt;:bounds&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;]})})}&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;This matches our expectation, since:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;A{n}&lt;/code&gt; means exactly &lt;em&gt;n&lt;/em&gt; A's&lt;/li&gt;
&lt;li&gt;&lt;code&gt;A{m,n}&lt;/code&gt; means between &lt;em&gt;m&lt;/em&gt; and &lt;em&gt;n&lt;/em&gt; A's, inclusive&lt;/li&gt;
&lt;li&gt;&lt;code&gt;A{n,}&lt;/code&gt; means &lt;code&gt;n&lt;/code&gt; or more A's&lt;/li&gt;
&lt;li&gt;&lt;code&gt;A*&lt;/code&gt; means 0 or more A's&lt;/li&gt;
&lt;li&gt;&lt;code&gt;A+&lt;/code&gt; means 1 or more A's&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;"No bound" is represented by &lt;code&gt;nil&lt;/code&gt;. Some numbers are represented as just &lt;code&gt;1&lt;/code&gt;,
others as &lt;code&gt;1N&lt;/code&gt;. The latter are &lt;code&gt;clojure.lang.BigInts&lt;/code&gt;, not longs. The parser
does this so it can support regexes with pathologically large sizes (longer than
a &lt;code&gt;long&lt;/code&gt;, a signed 64-bit integer). We can ignore that distinction: both behave
identically for our purposes.&lt;/p&gt;
&lt;h3&gt;Implementing repetition&lt;/h3&gt;
&lt;p&gt;Repetition has a generalization of the &lt;code&gt;:character&lt;/code&gt; behavior we fixed earlier TKTK multiple vars&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:repetition&lt;/span&gt;
  &lt;span class="p"&gt;[{[&lt;/span&gt;&lt;span class="nv"&gt;elem&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;lower&lt;/span&gt; &lt;span class="nv"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="ss"&gt;:bounds&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;n-vars&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nv"&gt;lower&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;-&amp;gt; &lt;/span&gt;&lt;span class="nv"&gt;lower&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;or &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="nv"&gt;upper&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;-&amp;gt; &lt;/span&gt;&lt;span class="nv"&gt;upper&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;or &lt;/span&gt;&lt;span class="nv"&gt;n-vars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max &lt;/span&gt;&lt;span class="nv"&gt;n-vars&lt;/span&gt;&lt;span class="p"&gt;))]&lt;/span&gt;
    &lt;span class="c1"&gt;;; Even though e.g. the empty string matches "A*", we get the lvars from the&lt;/span&gt;
    &lt;span class="c1"&gt;;; structure of the puzzle, so we know all lvars have to be matched.&lt;/span&gt;

    &lt;span class="c1"&gt;;; Consequence 1: 0 reps only works if there are 0 vars to match.&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;zero? &lt;/span&gt;&lt;span class="nv"&gt;n-vars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;zero? &lt;/span&gt;&lt;span class="nv"&gt;lower&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;l/succeed&lt;/span&gt; &lt;span class="nv"&gt;l/fail&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/or*&lt;/span&gt;
       &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;for &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;reps&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;max &lt;/span&gt;&lt;span class="nv"&gt;lower&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;inc &lt;/span&gt;&lt;span class="nv"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
             &lt;span class="c1"&gt;;; Consequence 2: can't have any leftovers: must match all parts&lt;/span&gt;
             &lt;span class="ss"&gt;:when&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;zero? &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;rem &lt;/span&gt;&lt;span class="nv"&gt;n-vars&lt;/span&gt; &lt;span class="nv"&gt;reps&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
             &lt;span class="ss"&gt;:let&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;group-size&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;quot &lt;/span&gt;&lt;span class="nv"&gt;n-vars&lt;/span&gt; &lt;span class="nv"&gt;reps&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                   &lt;span class="nv"&gt;groups&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;partition&lt;/span&gt; &lt;span class="nv"&gt;group-size&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)]]&lt;/span&gt;
         &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;partial &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;elem&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;groups&lt;/span&gt;&lt;span class="p"&gt;)))))))&lt;/span&gt;
&lt;/pre&gt;


&lt;h2&gt;Trying to solve a few puzzles&lt;/h2&gt;
&lt;p&gt;We've done quite a bit of work but still haven't solved any real puzzles. We'd
like to solve the game's own puzzles, so let's start from its internal
representation. Remember the first puzzle from the beginner set:&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://www.lvh.io/img/regex-crossword/beginner1.png" alt="the first regex crossword level in the Beginner set"&gt;
&lt;figcaption&gt;The first level in the Beginner set, &lt;a href="https://regexcrossword.com/challenges/beginner/puzzles/1"&gt;"Beatles"&lt;/a&gt;.&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Its internal representation looks like this:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;$ jq &lt;span class="s1"&gt;'.[1].puzzles[0]'&lt;/span&gt; challenges.json
&lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="s2"&gt;"id"&lt;/span&gt;: &lt;span class="s2"&gt;"475e811a-da59-4ce8-9b80-3124b33cc041"&lt;/span&gt;,
  &lt;span class="s2"&gt;"name"&lt;/span&gt;: &lt;span class="s2"&gt;"Beatles"&lt;/span&gt;,
  &lt;span class="s2"&gt;"patternsX"&lt;/span&gt;: &lt;span class="o"&gt;[&lt;/span&gt;
    &lt;span class="o"&gt;[&lt;/span&gt;
      &lt;span class="s2"&gt;"[^SPEAK]+"&lt;/span&gt;
    &lt;span class="o"&gt;]&lt;/span&gt;,
    &lt;span class="o"&gt;[&lt;/span&gt;
      &lt;span class="s2"&gt;"EP|IP|EF"&lt;/span&gt;
    &lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;]&lt;/span&gt;,
  &lt;span class="s2"&gt;"patternsY"&lt;/span&gt;: &lt;span class="o"&gt;[&lt;/span&gt;
    &lt;span class="o"&gt;[&lt;/span&gt;
      &lt;span class="s2"&gt;"HE|LL|O+"&lt;/span&gt;
    &lt;span class="o"&gt;]&lt;/span&gt;,
    &lt;span class="o"&gt;[&lt;/span&gt;
      &lt;span class="s2"&gt;"[PLEASE]+"&lt;/span&gt;
    &lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;(We'll turn the keys to kebab-case-keywords so it looks a bit more Clojure-y.)
There's something strange about the sample data: &lt;code&gt;:patterns-x&lt;/code&gt; and &lt;code&gt;:patterns-y&lt;/code&gt;
are both seqs of seqs of patterns. You may have expected them to be seqs of
patterns directly. This data structure choice isn't obvious until you hit a
later puzzle such as the first level in the "Double Cross" set:&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://www.lvh.io/img/regex-crossword/doublecross.png" alt="the first regex crossword level in the Double Cross set"&gt;
&lt;figcaption&gt;The first level in the Double Cross set, &lt;a href="https://regexcrossword.com/challenges/doublecross/puzzles/1"&gt;"Telekinesis"&lt;/a&gt;.&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;This puzzle is represented internally as:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:id&lt;/span&gt; &lt;span class="s"&gt;"f0f06b00-ec0a-4572-935d-7459e2a13064"&lt;/span&gt;
 &lt;span class="ss"&gt;:name&lt;/span&gt; &lt;span class="s"&gt;"Telekinesis"&lt;/span&gt;
 &lt;span class="ss"&gt;:patterns-x&lt;/span&gt; &lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="s"&gt;"[D-HJ-M]"&lt;/span&gt; &lt;span class="s"&gt;"[^F-KM-Z]"&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;"[^A-RU-Z]"&lt;/span&gt; &lt;span class="s"&gt;"[A-KS-V]"&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
 &lt;span class="ss"&gt;:patterns-y&lt;/span&gt; &lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="s"&gt;"[A-GN-Z]+"&lt;/span&gt; &lt;span class="s"&gt;"[^A-DI-S]+"&lt;/span&gt;&lt;span class="p"&gt;]]}&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;As you can see this just represents different patterns affecting the same row.
Ironically while this is presumably intended to make the puzzle harder, the
extra constraints probably just make the logic engine's life easier. Either way,
solving means we make some lvars for each box, carve them up by rows and
columns, and then apply the regex goals:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defn &lt;/span&gt;&lt;span class="nv"&gt;solve&lt;/span&gt;
  &lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="nv"&gt;puzzle&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
   &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;solve&lt;/span&gt; &lt;span class="nv"&gt;puzzle&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
  &lt;span class="p"&gt;([{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;patterns-x&lt;/span&gt; &lt;span class="nv"&gt;patterns-y&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="ss"&gt;:as&lt;/span&gt; &lt;span class="nv"&gt;puzzle&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;n&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="ss"&gt;:as&lt;/span&gt; &lt;span class="nv"&gt;opts&lt;/span&gt; &lt;span class="ss"&gt;:or&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nv"&gt;n&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;}}]&lt;/span&gt;
   &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;n-vars&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;* &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="nv"&gt;patterns-x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="nv"&gt;patterns-y&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
         &lt;span class="nv"&gt;vars&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;repeatedly&lt;/span&gt; &lt;span class="nv"&gt;n-vars&lt;/span&gt; &lt;span class="nv"&gt;l/lvar&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
         &lt;span class="nv"&gt;rows&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;partition&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="nv"&gt;patterns-x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;vars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
         &lt;span class="nv"&gt;cols&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;apply &lt;/span&gt;&lt;span class="nv"&gt;mapv&lt;/span&gt; &lt;span class="nb"&gt;vector &lt;/span&gt;&lt;span class="nv"&gt;rows&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
         &lt;span class="nv"&gt;pattern-goals&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;map&lt;/span&gt;
                        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;fn &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;patterns&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
                          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt;
                           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;-&amp;gt; &lt;/span&gt;&lt;span class="nv"&gt;%&lt;/span&gt; &lt;span class="nv"&gt;cre/parse&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="nv"&gt;patterns&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
                        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;concat &lt;/span&gt;&lt;span class="nv"&gt;patterns-x&lt;/span&gt; &lt;span class="nv"&gt;patterns-y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;concat &lt;/span&gt;&lt;span class="nv"&gt;cols&lt;/span&gt; &lt;span class="nv"&gt;rows&lt;/span&gt;&lt;span class="p"&gt;))]&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;-&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run&lt;/span&gt; &lt;span class="nv"&gt;n&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
            &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/==&lt;/span&gt; &lt;span class="nv"&gt;q&lt;/span&gt; &lt;span class="nv"&gt;vars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt; &lt;span class="nv"&gt;pattern-goals&lt;/span&gt;&lt;span class="p"&gt;))))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;We can use this to solve the first tutorial puzzle:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;solve&lt;/span&gt;
 &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:id&lt;/span&gt; &lt;span class="s"&gt;"272901bb-0855-4157-9b45-272935da8c93"&lt;/span&gt;
  &lt;span class="ss"&gt;:name&lt;/span&gt; &lt;span class="s"&gt;"The OR symbol"&lt;/span&gt;
  &lt;span class="ss"&gt;:patterns-x&lt;/span&gt; &lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="s"&gt;"A|B"&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
  &lt;span class="ss"&gt;:patterns-y&lt;/span&gt; &lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="s"&gt;"A|Z"&lt;/span&gt;&lt;span class="p"&gt;]]})&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt; (((\A)))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Unfortunately, the second one has character classes, so we have to implement
that next.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:id&lt;/span&gt; &lt;span class="s"&gt;"6915fafc-3323-484d-b801-5daac73ddb56"&lt;/span&gt;
 &lt;span class="ss"&gt;:name&lt;/span&gt; &lt;span class="s"&gt;"A Range of characters"&lt;/span&gt;
 &lt;span class="ss"&gt;:patterns-x&lt;/span&gt; &lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="s"&gt;"[ABC]"&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
 &lt;span class="ss"&gt;:patterns-y&lt;/span&gt; &lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="s"&gt;"[BDF]"&lt;/span&gt;&lt;span class="p"&gt;]]}&lt;/span&gt;
&lt;/pre&gt;


&lt;h2&gt;Character classes&lt;/h2&gt;
&lt;p&gt;Let's look at another parse:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cre/parse&lt;/span&gt; &lt;span class="s"&gt;"[A]"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;;; =&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:alternation&lt;/span&gt;,
 &lt;span class="ss"&gt;:elements&lt;/span&gt;
 &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:concatenation&lt;/span&gt;,
   &lt;span class="ss"&gt;:elements&lt;/span&gt;
   &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class&lt;/span&gt;,
     &lt;span class="ss"&gt;:elements&lt;/span&gt;
     &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-intersection&lt;/span&gt;,
       &lt;span class="ss"&gt;:elements&lt;/span&gt;
       &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-union&lt;/span&gt;
         &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}}]}]}]&lt;/span&gt;
     &lt;span class="ss"&gt;:brackets?&lt;/span&gt; &lt;span class="nv"&gt;true&lt;/span&gt;&lt;span class="p"&gt;}]}]}&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Whoa! This parses to something a lot trickier than you might've guessed. Class
sets (intersections, unions and subtraction) are somewhat obscure set of regex
features with slightly differing support across platforms and slightly different
syntax. They're particularly useful when you have a full Unicode regex engine
and you want to say things like "match characters in this script, but not digits
or punctuation". In Java, Ruby and Python, they are spelled something like
&lt;code&gt;[Î±&amp;amp;&amp;amp;[Î²]&amp;amp;&amp;amp;[Î³]]&lt;/code&gt; where &lt;code&gt;Î±Î²Î³&lt;/code&gt; are all their own class specs.&lt;/p&gt;
&lt;p&gt;This is a side-effect of using a parser intended for parsing Java regular
expressions. JavaScript doesn't support these features. Fortunately, they're
pretty easy to implement. As usual, we'll tackle the simple base case first.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;])))&lt;/span&gt;
&lt;/pre&gt;


&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;chars&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;lvar&lt;/span&gt; &lt;span class="ss"&gt;:as&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
  &lt;span class="c1"&gt;;; It appears class-base will only ever have one char, but I'm writing this&lt;/span&gt;
  &lt;span class="c1"&gt;;; defensively since I have no proof I've exhausted all the parser cases.&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;-&amp;gt; &lt;/span&gt;&lt;span class="nv"&gt;lvars&lt;/span&gt; &lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/membero&lt;/span&gt; &lt;span class="nv"&gt;lvar&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;vec&lt;/span&gt; &lt;span class="nv"&gt;chars&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="c1"&gt;;; vec, bc membero doesn't work with sets&lt;/span&gt;
    &lt;span class="nv"&gt;l/fail&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;


&lt;h3&gt;Class union and intersection&lt;/h3&gt;
&lt;p&gt;While we could cheat implementing class union and intersection since the
original JavaScript puzzle would never have them, they're trivial to express in
logic, so let's just do them properly:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/testing&lt;/span&gt; &lt;span class="s"&gt;"class-union"&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt;
              &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-union&lt;/span&gt;
               &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}}]}&lt;/span&gt;
              &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;]))))&lt;/span&gt;

  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt;
              &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-union&lt;/span&gt;
               &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt;
                          &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;}}]}&lt;/span&gt;
              &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;])))))&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/testing&lt;/span&gt; &lt;span class="s"&gt;"class-intersection"&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt;
              &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-intersection&lt;/span&gt;
               &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}}]}&lt;/span&gt;
              &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;]))))&lt;/span&gt;

  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt;
              &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-intersection&lt;/span&gt;
               &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt;
                          &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}}]}&lt;/span&gt;
              &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;]))))&lt;/span&gt;

  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt;
              &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-intersection&lt;/span&gt;
               &lt;span class="ss"&gt;:elements&lt;/span&gt; &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt;
                          &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:type&lt;/span&gt; &lt;span class="ss"&gt;:class-base&lt;/span&gt; &lt;span class="ss"&gt;:chars&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;\B&lt;/span&gt;&lt;span class="p"&gt;}}]}&lt;/span&gt;
              &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;p&lt;/span&gt;&lt;span class="p"&gt;])))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Implemented by:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:class-union&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/or*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;%&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:class-intersection&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;%&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;


&lt;h3&gt;Ranges&lt;/h3&gt;
&lt;p&gt;You're probably catching on. Implementing ranges uses a bunch of logic machinery
we already use, and just a Clojure description of what a range &lt;em&gt;is&lt;/em&gt;:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;t/is&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt; &lt;span class="sc"&gt;\B&lt;/span&gt; &lt;span class="sc"&gt;\C&lt;/span&gt; &lt;span class="sc"&gt;\D&lt;/span&gt; &lt;span class="sc"&gt;\E&lt;/span&gt; &lt;span class="sc"&gt;\F&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/run*&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
            &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;-&amp;gt; &lt;/span&gt;&lt;span class="s"&gt;"[A-F]"&lt;/span&gt; &lt;span class="nv"&gt;cre/parse&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rcl/re-&amp;gt;goal&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;q&lt;/span&gt;&lt;span class="p"&gt;])))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Implemented by:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:range&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;lvar&lt;/span&gt; &lt;span class="ss"&gt;:as&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;-&amp;gt; &lt;/span&gt;&lt;span class="nv"&gt;lvars&lt;/span&gt; &lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="nv"&gt;lower&lt;/span&gt; &lt;span class="nv"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;comp int &lt;/span&gt;&lt;span class="ss"&gt;:character&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
          &lt;span class="nv"&gt;chars&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map char &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range &lt;/span&gt;&lt;span class="nv"&gt;lower&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;inc &lt;/span&gt;&lt;span class="nv"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;)))]&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/membero&lt;/span&gt; &lt;span class="nv"&gt;lvar&lt;/span&gt; &lt;span class="nv"&gt;chars&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="nv"&gt;l/fail&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Because ranges like &lt;code&gt;A-Z0-9&lt;/code&gt; are implemented using &lt;code&gt;:class-union&lt;/code&gt;, they just
magically work.&lt;/p&gt;
&lt;h3&gt;Simple classes&lt;/h3&gt;
&lt;p&gt;"Simple classes" are things like &lt;code&gt;\d&lt;/code&gt;, &lt;code&gt;\w&lt;/code&gt;, &lt;code&gt;\s&lt;/code&gt;. You know how to implement
these already.&lt;/p&gt;
&lt;h2&gt;Class negation&lt;/h2&gt;
&lt;p&gt;Class negation is actually surprisingly tricky! Many logic systems, core.logic
included, focus on positive statements. There is support for disunification
(e.g. this lvar will never be 5) with &lt;code&gt;l/!=&lt;/code&gt;. There's also more general support
for negation as a constraint, as used here:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:class-negation&lt;/span&gt;
    &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;for &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;e&lt;/span&gt; &lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/nafc&lt;/span&gt; &lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;e&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Unfortunately nafc is marked as experimental and for good reason. For one, it
only works if the vars are ground. Docstring claims execution will be delayed if
they aren't... but that doesn't appear to be true. See
&lt;a href="https://clojure.atlassian.net/browse/LOGIC-172"&gt;LOGIC-172&lt;/a&gt; for details. This
problem annoyingly surfaced depending on the order clauses were evaluated in
(since that changed if they were ground or not). I was able to get it to work
consistently by adding a hack to make sure the vars are ground, and adding a
test to make sure it would work even if this was the first clause:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defmethod &lt;/span&gt;&lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="ss"&gt;:class-negation&lt;/span&gt;
  &lt;span class="p"&gt;[{&lt;/span&gt;&lt;span class="ss"&gt;:keys&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;neg-goal&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;for &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;e&lt;/span&gt; &lt;span class="nv"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/nafc&lt;/span&gt; &lt;span class="nv"&gt;re-&amp;gt;goal&lt;/span&gt; &lt;span class="nv"&gt;e&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
        &lt;span class="nv"&gt;domain&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;-&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int &lt;/span&gt;&lt;span class="sc"&gt;\A&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;inc &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int &lt;/span&gt;&lt;span class="sc"&gt;\Z&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="nv"&gt;char&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="nv"&gt;ground-hack&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/and*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;for &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;v&lt;/span&gt; &lt;span class="nv"&gt;lvars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/membero&lt;/span&gt; &lt;span class="nv"&gt;v&lt;/span&gt; &lt;span class="nv"&gt;domain&lt;/span&gt;&lt;span class="p"&gt;)))]&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/all&lt;/span&gt; &lt;span class="nv"&gt;ground-hack&lt;/span&gt; &lt;span class="nv"&gt;neg-goal&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;A different way to implement this would be to walk this part of the parse tree
manually. Once you find a negation, you look at the rest of the parse tree and
aggregate all the classes it covers. Then, you use plain negation
(disunification), which has no caveats. This is what I ended up implementing; if
you're interested you can read the details &lt;a href="https://github.com/lvh/regex-crossword/blob/fd00aa5f97f285c2bcf4c539144e96d18573f755/src/lvh/regex_crossword/logic.clj#L99"&gt;in the implementation&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Backrefs&lt;/h2&gt;
&lt;p&gt;Backreferences are an interesting challenge because so far we've just assumed we
can recurisvely turn the regex parse tree into goals piecemeal, and backrefs
break that assumption: they necessarily depend on a totally different part of
the parse tree. There are two ways to address that:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Change the implementation to produce a data structure instead of logic goals
   directly, and then do something eval-like later to turn the data structure
   into goals&lt;/li&gt;
&lt;li&gt;Cheat and introduce side effects to propagate within the tree walk.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The first is clearly the "good" answer. It would also enable other improvements,
like tree-level performance optimization. It's also a good chunk of work, and I
had spent enough time on this weekend project already. So, instead, I did the
hacky side-effecty version. This turned out to be tricky to implement not from a
logic perspective (that part is easy) but because the underlying parser I had
forklifted was from a project that didn't support backrefs, and so it didn't
bother to parse them out correctly. You can see how I hacked around that &lt;a href="https://github.com/lvh/regex-crossword/blob/fd00aa5f97f285c2bcf4c539144e96d18573f755/src/lvh/regex_crossword/logic.clj#L126"&gt;in the
implementation&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;This introduction was a little unorthodox. Most texts focus on introducing
different primitives, have you write small static rules and build up from there.
You'll see &lt;code&gt;conde&lt;/code&gt; long before anyone talks to you about &lt;code&gt;or*&lt;/code&gt;.
Negation-as-failure, which we used for classes, is exotic and non-relational.
The way we implemented backrefs works but is inelegant. That's all just a
consequence of the problem we solved, not a principled stance on how to use
&lt;code&gt;core.logic&lt;/code&gt; let alone teach it. Reading &lt;a href="https://www.amazon.com/Little-Schemer-Daniel-P-Friedman/dp/0262560992"&gt;The Little Schemer&lt;/a&gt; is still a
good idea if you want to learn to write your own programs.&lt;/p&gt;
&lt;p&gt;(If you want a logic program where the goals are not fixed in advance, you might
want to just stick to the JVM so there are no restrictions on eval use. I
haven't tried running core.logic on &lt;a href="https://github.com/borkdude/sci"&gt;sci&lt;/a&gt;.)&lt;/p&gt;
&lt;h2&gt;Next steps&lt;/h2&gt;
&lt;p&gt;These are things I thought were neat but didn't make sense in the original text.&lt;/p&gt;
&lt;h3&gt;Running programs backwards&lt;/h3&gt;
&lt;p&gt;A truly mind-bending feature of relational programs is that they can be ran
"backwards". Usually, you write a program "forwards": it has some inputs and you
expect some outputs. If you write your logic program a particular way, it
doesn't actually know what's an input and what's an output, and so you can give
it an "output" and it will come up with "inputs" that would have led to that
output. This post did not demonstrate that, but it's one of the better hooks
I've found to get people excited about logic programming. I could not give this
talk better than &lt;a href="https://www.youtube.com/watch?v=RVDCRlW1f1Y"&gt;Will Byrd presenting miniKanren&lt;/a&gt;. I won't spoil the
ending, but go watch that talk.&lt;/p&gt;
&lt;p&gt;Our program does not work that way. All our "inputs" are rules, all our lvars
are the same kind (unknown boxes), so running it "backwards" doesn't really mean
anything. It could, if our parser and rule generation were also fully
relational. In that case, we could fill out some boxes and our program would
tell us progressively more creative regular expressions that would match them.
Instead of a puzzle solver, we would have written a puzzle creator.&lt;/p&gt;
&lt;h3&gt;Palindromes&lt;/h3&gt;
&lt;p&gt;Some puzzles have hints that help you solve them. Usually they're thematic cues,
(e.g. "Hamlet") which are hard to tell a logic engine about. Structural cues are
easy. For example, if you think some lines should be palindromes, you can just
add the following constraint:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/all*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;fn &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;vars&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;l/==&lt;/span&gt; &lt;span class="nv"&gt;vars&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;reverse &lt;/span&gt;&lt;span class="nv"&gt;vars&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt; &lt;span class="nv"&gt;lines&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;If evaluated at the right time, this should constrain the search tree. It's
tricky to make sure that happens without measurement and fiddling.&lt;/p&gt;
&lt;h3&gt;Thematic cues&lt;/h3&gt;
&lt;p&gt;If you really wanted to add thematic cues, e.g. "Hamlet", you could grab the
Wikipedia page, use something like TF/IDF to find important words, filter by the
appropriate size, and introduce them as constraints. I don't expect this will
speed anything up much even if you discount the initial step.&lt;/p&gt;
&lt;h3&gt;Hexagon shaped puzzles&lt;/h3&gt;
&lt;p&gt;I made these work, but didn't hook it up to the solver permanently (mostly
because I lost interest). I like hex grids a lot, but they're not interesting
from a logic perspective so I didn't cover them in this post. You can check out
&lt;a href="https://github.com/lvh/regex-crossword/blob/master/src/lvh/regex_crossword/slices.clj"&gt;the implementation&lt;/a&gt; but be warned: it's mostly just some tedious bean
counting.&lt;/p&gt;&lt;/div&gt;</description><category>clojure</category><guid>https://www.lvh.io/posts/solving-regex-crosswords/</guid><pubDate>Sat, 26 Oct 2019 02:36:29 GMT</pubDate></item><item><title>How (not) to sign a JSON object</title><link>https://www.lvh.io/posts/how-not-to-sign-a-json-object/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;p&gt;Last year we did a blog post on interservice auth. This post is mostly about authenticating consumers to an API. Thatâ€™s a related but subtly different problem: you can probably impose more requirements on your internal users than your customers. The idea is the same though: youâ€™re trying to differentiate between a legitimate user and an attacker, usually by getting the legitimate user to prove that they know a credential that the attacker doesnâ€™t.&lt;/p&gt;
&lt;h2&gt;You donâ€™t really want a signature&lt;/h2&gt;
&lt;p&gt;When cryptography engineers say "signature" they tend to mean something asymmetric, like RSA or ECDSA. Developers reach for asymmetric tools too often. There are a lot of ways to screw them up. By comparison, symmetric â€œsigningâ€ (MACs) are easy to use and hard to screw up. HMAC is bulletproof and ubiquitous.&lt;/p&gt;
&lt;p&gt;Unless you have a good reason why you need an (asymmetric) signature, you want a MAC. If you really do want a signature, check out our Cryptographic Right Answers post to make that as safe as possible. For the rest of this blog post, "signing" means symmetrically, and in practice that means HMAC.&lt;/p&gt;
&lt;h2&gt;How to sign a JSON object&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Serialize however you want.&lt;/li&gt;
&lt;li&gt;HMAC. With SHA256? Sure, whatever. We did &lt;a href="https://latacora.singles/2018/04/03/cryptographic-right-answers.html"&gt;a blog post&lt;/a&gt; on that too.&lt;/li&gt;
&lt;li&gt;Concatenate the tag with the message, maybe with a comma in between for easy parsing or something.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Wait, isnâ€™t that basically a HS256 JWT?&lt;/h2&gt;
&lt;p&gt;Shut up. Anyway, no, because you need to parse a header to read the JWT, so you inherit all of the problems that stem from that.&lt;/p&gt;
&lt;h2&gt;How &lt;em&gt;not&lt;/em&gt; to sign a JSON object, if you can help it&lt;/h2&gt;
&lt;p&gt;Someone asked how to sign a JSON object "in-band": where the tag is part of the object youâ€™re signing itself. That's a niche use case, but it happens. You have a JSON object that a bunch of intermediate systems want to read and itâ€™s important  none of them mess with its contents. You can't just send &lt;code&gt;tag || json&lt;/code&gt;: that may be the cryptographically right answer, but now it's not a JSON object anymore so third party services and middleboxes will barf. You also can't get them to reliably pass the tag around as metadata (via a HTTP header or something). You need to put the key &lt;em&gt;on the JSON object&lt;/em&gt;, somehow, to "transparently" sign it. Anyone who cares about validating the signature can, and anyone who cares that the JSON object has a particular structure doesn't break (because the blob is still JSON and it still has the data it's supposed to have in all the familiar places).&lt;/p&gt;
&lt;p&gt;This problem sort-of reminds me of format-preserving encryption. I donâ€™t mean that in a nice way, because thereâ€™s no nice way to mean that. Format-preserving encryption means you encrypt a credit card number and the result still sorta looks like a credit card number. Itâ€™s terrible and you only do it because you have to. Same with in-band JSON signing.&lt;/p&gt;
&lt;p&gt;As stated, in-band JSON signing means modifying a JSON object (e.g. removing the HMAC tag) and validating that itâ€™s the same thing that was signed. You do that by computing the HMAC again and validating the result. Unfortunately there are infinitely many equal JSON objects with distinct byte-level representations (for some useful definition of equality, like Pythonâ€™s builtin ==).&lt;/p&gt;
&lt;p&gt;Some of those differences are trivial, while others are fiendishly complicated. You can add as many spaces as you want between some parts of the grammar, like after the colon and before the value in an object. You can reorder the keys in an object. You can escape a character using a Unicode escape sequence (\u2603) instead of using the UTF-8 representation. "UTF-8" may be a serialization format for Unicode, but itâ€™s not a canonicalization technique. If a character has multiple diacritics, they might occur in different orders. Some characters can be written as a base character plus a diacritic, but thereâ€™s also an equivalent single character. You canâ€™t always know what the â€œrightâ€ character out of context: is this the symbol for the unit of resistance (U+2126 OHM SIGN) or a Greek capital letter Omega (U+03A9)? Donâ€™t even get me started on the different ways you can write the same floating point number!&lt;/p&gt;
&lt;p&gt;Three approaches:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Canonicalize the JSON.&lt;/li&gt;
&lt;li&gt;Add the tag and the exact string you signed to the object, validate the signature and then validate that the JSON object is the same as the one you got.&lt;/li&gt;
&lt;li&gt;Create an alternative format with an easier canonicalization than JSON.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Canonicalization&lt;/h3&gt;
&lt;p&gt;Canonicalization means taking an object and producing a unique representation for it. Two objects that mean the same thing ("are equal") but are expressed differently canonicalize to the same representation.&lt;/p&gt;
&lt;p&gt;Canonicalization is a quagnet, which is a term of art in vulnerability research meaning quagmire and vulnerability magnet. You can tell itâ€™s bad just by how hard it is to type â€˜canonicalizationâ€™.&lt;/p&gt;
&lt;p&gt;My favorite canonicalization bug in recent memory is probably Kelby Ludwigâ€™s SAML bug. Hold onto your butts, because this bug broke basically every SAML implementation under the sun in a masterful stroke. It used NameIds (SAML-speak for "the entity this assertion is about") that look like this:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;NameId&amp;gt;&lt;/span&gt;barney@latacora.com&lt;span class="c"&gt;&amp;lt;!----&amp;gt;&lt;/span&gt;.evil.com&lt;span class="nt"&gt;&amp;lt;/NameId&amp;gt;&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;The common canonicalization strategy ("exc-c14n") will remove comments, so that side sees â€œbarney@latacora.com.evil.comâ€. The common parsing strategy (â€œyoloâ€) disagrees, and sees a text node, a comment, and another text node. Since everyone is expecting a NameId to have one text node, you grab the first one. But that says barney@latacora.com, which isnâ€™t what the IdP signed or your XML-DSIG library validated.&lt;/p&gt;
&lt;p&gt;Not to worry: we said we were doing JSON, and JSON is not XML. Itâ€™s simpler! Right? There are at least two specs here: Canonical JSON (from OLPC) and an IETF draft (https://tools.ietf.org/id/draft-rundgren-json-canonicalization-scheme-05.html). They work? Probably? But theyâ€™re not fun to implement.&lt;/p&gt;
&lt;h3&gt;Include the exact thing youâ€™re signing&lt;/h3&gt;
&lt;p&gt;If you interpret the problem as "to validate a signature I need an exact byte representation of what to sign" and canonicalization is just the default mechanism for getting to an exact byte representation, you could also just attach a specific byte serialization to the object with a tag for it.&lt;/p&gt;
&lt;p&gt;You validate the tag matches the specific serialization, and then you validate that the specific serialization matches the outside object with the tag and specific serialization removed. The upside is that you donâ€™t need to worry about canonicalization; the downside is your messages are about twice the size that they need to be. You can maybe make that a little better with compression, since the repeated data is likely to compress well.&lt;/p&gt;
&lt;h3&gt;The regex bait and switch trick&lt;/h3&gt;
&lt;p&gt;If you interpret the problem as being about already having a perfectly fine serialization to compute a tag over, but the JSON parser/serializer roundtrip screwing it up after you compute the tag, you might try to do something to the serialized format that doesn't know it's JSON. This is a variant of the previous approach: you're just not adding a &lt;em&gt;second&lt;/em&gt; serialization to compute the tag over.&lt;/p&gt;
&lt;p&gt;The clever trick here is to add a field of the appropriate size for your tag with a well-known fake value, then HMAC, then swap the value. For example, if you know the tag is HMAC-SHA256, your tag size is 256 bits aka 32 bytes aka 64 hex chars. You add a unique key (something like &lt;code&gt;__hmac_tag&lt;/code&gt;) with a value of 64 well-known bytes, e.g. 64 ASCII zero bytes. Serialize the object and compute its HMAC. If you document some subset of JSON serialization (e.g. where CRLFs can occur or where extra spaces can occur), you know that the string &lt;code&gt;"__hmac_tag": â€œ000...â€&lt;/code&gt; will occur in the serialized byte stream. Now, you can use string replacement to shiv in the real HMAC value. Upon receipt, the decoder finds the tag, reads the HMAC value, replaces it with zeroes, computes the expected tag and compares against the previously read value.&lt;/p&gt;
&lt;p&gt;Because thereâ€™s no JSON roundtripping, the parser canâ€™t mess up the JSON objectâ€™s specific serialization. The key needs to be unique because of course the string replacement or regular expression doesnâ€™t know how to parse JSON.&lt;/p&gt;
&lt;p&gt;This feels weirdly gross? But at the same time probably less annoying than canonicalization. And it doesn't work if any of the middleboxes modiy the JSON through a parse/re-serialize cycle.&lt;/p&gt;
&lt;h3&gt;An alternative format&lt;/h3&gt;
&lt;p&gt;If you interpret the problem as "canonicalization is hard because JSON is more complex than what I really want to sign", you might think the answer is to reformat the data you want to sign in a format where canonicalization is easy or even automatic.  AWS Signatures do this: thereâ€™s a serialization format thatâ€™s far less flexible than JSON where you put some key parameters, and then you HMAC that. (Thereâ€™s an interesting part to it where it also incorporates the hash of the exact message youâ€™re signing -- but weâ€™ll get to that later.)&lt;/p&gt;
&lt;p&gt;This is particularly attractive if thereâ€™s a fixed set of simple values you have to sign, or more generally if the thing youâ€™re signing has a predictable format.&lt;/p&gt;
&lt;h2&gt;Request signing in practice&lt;/h2&gt;
&lt;p&gt;Letâ€™s apply this model to a case study of request signing has worked through the years in some popular services. These are not examples of how to do it well, but rather cautionary tales.&lt;/p&gt;
&lt;p&gt;First off, AWS. AWS requires you to sign API requests. The current spec is "v4", which tells you that there is probably at least one interesting version that preceded it.&lt;/p&gt;
&lt;h3&gt;AWS Signing v1&lt;/h3&gt;
&lt;p&gt;Letâ€™s say an AWS operation CreateWidget takes attribute Name which can be any ASCII string. It also takes an attribute Unsafe, which is false by default and the attacker wishes were true. V1 concatenates the key-value pairs youâ€™re signing, so something like Operation=CreateWidget&amp;amp;Name=iddqd became OperationCreateWidgetNameiddqd. You then signed the resulting string using HMAC.&lt;/p&gt;
&lt;p&gt;The problem with this is if I can get you to sign messages for creating widgets with arbitrary names, I can get you to sign operations for arbitrary CreateWidget requests: I just put all the extra keys and values I want in the value youâ€™re signing for me. For example, the request signature for creating a widget named &lt;code&gt;iddqdUnsafetrue&lt;/code&gt; is exactly the same as a request signature for creating a widget named &lt;code&gt;iddqd&lt;/code&gt; with Unsafe equal to true: OperationCreateWidgetNameiddqdUnsafetrue.&lt;/p&gt;
&lt;h3&gt;AWS Signing V2&lt;/h3&gt;
&lt;p&gt;Security-wise: fine.&lt;/p&gt;
&lt;p&gt;Implementation-wise: itâ€™s limited to query-style requests (query parameters for GET, x-www-form-urlencoded for POST bodies) and didnâ€™t support other methods, let alone non-HTTP requests. Sorting request parameters is a burden for big enough requests. Nothing for chunked requests either.&lt;/p&gt;
&lt;p&gt;(Some context: even though most AWS SDKs present you with a uniform interface, there are several different protocol styles in use within AWS. For example, EC2 and S3 are their own thing, some protocols use Query Requests (basically query params in GET queries and POST formencoded bodies), others use REST+JSON, some use REST+XMLâ€¦ Thereâ€™s even some SOAP! But I think thatâ€™s on its way out.)&lt;/p&gt;
&lt;h3&gt;AWS Signing V3&lt;/h3&gt;
&lt;p&gt;AWS doesnâ€™t seem to like V3 very much. The &lt;a href="https://docs.aws.amazon.com/general/latest/gr/sigv4_changes.html"&gt;"whatâ€™s new in v4 document"&lt;/a&gt; all but disavows itâ€™s existence, and no live services appear to implement it. It had some annoying problems like distinguishing between signed and unsigned headers (leaving the service to figure it out) and devolving to effectively a bearer token when used over TLS (which is great, as long as it actually gets used over TLS).&lt;/p&gt;
&lt;p&gt;Given how AWS scrubbed it away, itâ€™s hard to say anything with confidence. Iâ€™ve found implementations, but thatâ€™s not good enough: an implementation may only use a portion of the spec while the badness can be hiding in the rest.&lt;/p&gt;
&lt;h3&gt;AWS Signing V4&lt;/h3&gt;
&lt;p&gt;Security-wise: fine.&lt;/p&gt;
&lt;p&gt;Addressed some problems noted in V2; for example: just signs the raw body bytes and doesnâ€™t care about parameter ordering. This is pretty close to the original recommendation: donâ€™t do inline signing at all, just sign the exact message youâ€™re sending and put a MAC tag on the outside. A traditional objection is that several equivalent requests would have a different representation, e.g. the same arguments but in a different order. It just turns out that in most cases that doesnâ€™t matter, and API auth is one of those cases.&lt;/p&gt;
&lt;p&gt;Also note that all of these schemes are really outside signing, but theyâ€™re still interesting because they had a lot of the problems you see on an inline signing scheme (they were just mostly unforced errors).&lt;/p&gt;
&lt;h3&gt;AWS Signing V0&lt;/h3&gt;
&lt;p&gt;For completeness. It is even harder to find than V3: you have to spelunk some SDKs for it. I hear it might have been HMAC(k, service || operation || timestamp), so it didnâ€™t really sign much of the request.&lt;/p&gt;
&lt;h3&gt;Flickrâ€™s API signing&lt;/h3&gt;
&lt;p&gt;One commonality of the AWS vulnerabilities is that none of them attacked the primitive. All of them used HMAC and HMAC has always been safe. Flickr had exactly the same bug as AWS V1 signing, but also used a bad MAC. The tag you sent was MD5(secret + your_concatenated_key_value_pairs). Weâ€™ll leave the details of extension attacks for a different time, but the punchline is that if you know the value of H(secret + message) and donâ€™t know s, you get to compute H(secret + message + glue + message2), where glue is some binary nonsense and message2 is an arbitrary attacker controlled string.&lt;/p&gt;
&lt;p&gt;A typical protocol where this gets exploited looks somewhat like query parameters. The simplest implementation will just loop over every key-value pair and assign the value into an associative array. So if you have user=lvh&amp;amp;role=user, I might be able to extend that to a valid signature for user=lvh&amp;amp;role=userSOMEBINARYGARBAGE&amp;amp;role=admin.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Just go ahead and always enforce TLS for your APIs.&lt;/li&gt;
&lt;li&gt;Maybe you donâ€™t need request signing? A bearer token header is fine, or HMAC(k, timestamp) if youâ€™re feeling fancy, or mTLS if you really care.&lt;/li&gt;
&lt;li&gt;Canonicalization is fiendishly difficult.&lt;/li&gt;
&lt;li&gt;Add a signature on the outside of the request body, make sure the request body is complete, and donâ€™t worry about "signing what is said versus what is meant" -- itâ€™s OK to sign the exact byte sequence.&lt;/li&gt;
&lt;li&gt;The corollary here is that itâ€™s way harder to do request signing for a REST API (where stuff like headers and paths and methods matter) than it is to do signing for an RPC-like API.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;(This post was syndicated on the Latacora blog.)&lt;/p&gt;&lt;/div&gt;</description><category>cryptography</category><category>security</category><guid>https://www.lvh.io/posts/how-not-to-sign-a-json-object/</guid><pubDate>Thu, 25 Jul 2019 01:56:06 GMT</pubDate></item><item><title>The PGP problem</title><link>https://www.lvh.io/posts/the-pgp-problem/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;p&gt;&lt;a href="https://blog.cryptographyengineering.com/2014/08/13/whats-matter-with-pgp/"&gt;Cryptography engineers have been tearing their hair out over PGPâ€™s deficiencies&lt;/a&gt; for (literally) decades. When other kinds of engineers get wind of this, theyâ€™re shocked. PGP is bad? Why do people keep telling me to use PGP? The answer is that they shouldnâ€™t be telling you that, because PGP is bad and needs to go away.&lt;/p&gt;
&lt;p&gt;There are, as youâ€™re about to see, lots of problems with PGP. Fortunately, if youâ€™re not morbidly curious, thereâ€™s a simple meta-problem with it: it was designed in the 1990s, before serious modern cryptography. No competent crypto engineer would design a system that looked like PGP today, nor tolerate most of its defects in any other design. Serious cryptographers have largely given up on PGP and donâ€™t spend much time publishing on it anymore (&lt;a href="https://www.usenix.org/system/files/conference/usenixsecurity18/sec18-poddebniak.pdf"&gt;with a notable exception&lt;/a&gt;). Well-understood problems in PGP have gone unaddressed for over a decade because of this.&lt;/p&gt;
&lt;p&gt;Two quick notes: first, we wrote this for engineers, not lawyers and activists. Second: â€œPGPâ€ can mean a bunch of things, from the &lt;a href="https://tools.ietf.org/html/rfc4880"&gt;OpenPGP standard&lt;/a&gt; to its reference implementation in GnuPG. We use the term â€œPGPâ€ to cover all of these things.&lt;/p&gt;
&lt;h2&gt;The Problems&lt;/h2&gt;
&lt;h3&gt;Absurd Complexity&lt;/h3&gt;
&lt;p&gt;For reasons none of us here in the future understand, PGP has a packet-based structure. A PGP message (in a â€œ.ascâ€ file) is an archive of typed packets. There are &lt;a href="https://tools.ietf.org/html/rfc4880#page-13"&gt;at least 8 different ways&lt;/a&gt; of encoding the length of a packet, depending on whether youâ€™re using â€œnewâ€ or â€œoldâ€ format packets. The â€œnew formatâ€ packets have variable-length lengths, like BER (try to write a PGP implementation and you may wish for the sweet release of ASN.1). Packets can have subpackets. There are overlapping variants of some packets. The most recent keyserver attack happened because GnuPG &lt;a href="https://threadreaderapp.com/thread/1147162583969009664.html"&gt;accidentally went quadratic&lt;/a&gt; in parsing keys, which also follow this deranged format.&lt;/p&gt;
&lt;p&gt;Thatâ€™s just the encoding. The actual system doesnâ€™t get simpler. There are keys and subkeys. Key IDs and key servers and key signatures. Sign-only and encrypt-only. Multiple â€œkey ringsâ€. Revocation certificates. Three different compression formats. This is all before we get to smartcard support.&lt;/p&gt;
&lt;h3&gt;Swiss Army Knife Design&lt;/h3&gt;
&lt;p&gt;If youâ€™re stranded in the woods and, I donâ€™t know, need to repair your jean cuffs, itâ€™s handy if your utility knife has a pair of scissors. But nobody who does serious work uses their multitool scissors regularly.&lt;/p&gt;
&lt;p&gt;A Swiss Army knife does a bunch of things, all of them poorly. PGP does a mediocre job of signing things, a relatively poor job of encrypting them with passwords, and a pretty bad job of encrypting them with public keys. PGP is not an especially good way to securely transfer a file. Itâ€™s a clunky way to sign packages. Itâ€™s not great at protecting backups. Itâ€™s a downright dangerous way to converse in secure messages.&lt;/p&gt;
&lt;p&gt;Back in the MC Hammer era from which PGP originates, â€œencryptionâ€ was its own special thing; there was one tool to send a file, or to back up a directory, and another tool to encrypt and sign a file. Modern cryptography doesnâ€™t work like this; itâ€™s purpose built. Secure messaging wants crypto that is different from secure backups or package signing.&lt;/p&gt;
&lt;h3&gt;Mired In Backwards Compatibility&lt;/h3&gt;
&lt;p&gt;PGP predates modern cryptography; there are Hanson albums that have aged better. If youâ€™re lucky, your local GnuPG defaults to 2048-bit RSA, the 64-bit-block CAST5 cipher in CFB, and the OpenPGP MDC checksum (about which more later). If you encrypt with a password rather than with a public key, the OpenPGP protocol specifies PGPâ€™s S2K password KDF. These are, to put it gently, not the primitives a cryptography engineer would select for a modern system.&lt;/p&gt;
&lt;p&gt;Weâ€™ve learned a lot since Steve  Urkel graced the airwaves during ABCâ€™s TGIF: that you should authenticate your ciphertexts (and avoid CFB mode) would be an obvious example, but also that 64-bit block ciphers are bad, that we can do much better than RSA, that mixing compression and encryption is dangerous, and that KDFs should be both time- and memory-hard.&lt;/p&gt;
&lt;p&gt;Whatever the OpenPGP RFCs may say, youâ€™re probably not doing any of these things if youâ€™re using PGP, nor can you predict when you will. Take AEAD ciphers: the Rust-language Sequoia PGP defaulted to the AES-EAX AEAD mode, which is great, and nobody can read those messages because most PGP installs donâ€™t know what EAX mode is, which is not great. Every well-known bad cryptosystem eventually sprouts an RFC extension that supports curves or AEAD, so that its proponents can claim on message boards that they support modern cryptography. RFCâ€™s donâ€™t matter: only the installed base does. Weâ€™ve understood authenticated encryption for 2 decades, and PGP is old enough to buy me drinks; enough excuses.&lt;/p&gt;
&lt;p&gt;You can have backwards compatibility with the 1990s or you can have sound cryptography; &lt;em&gt;you canâ€™t have both&lt;/em&gt;.&lt;/p&gt;
&lt;h3&gt;Obnoxious UX&lt;/h3&gt;
&lt;p&gt;We canâ€™t say this any better than Ted Unangst:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;There was a PGP usability study conducted a few years ago where a group of technical people were placed in a room with a computer and asked to set up PGP. Two hours later, they were never seen or heard from again.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;If youâ€™d like empirical data of your own to back this up, hereâ€™s an experiment you can run: find an immigration lawyer and talk them through the process of getting Signal working on their phone. You probably donâ€™t suddenly smell burning toast. Now try doing that with PGP.&lt;/p&gt;
&lt;h3&gt;Long-Term Secrets&lt;/h3&gt;
&lt;p&gt;PGP begs users to keep a practically-forever root key tied to their identity. It does this by making keys annoying to generate and exchange, by encouraging â€œkey signing partiesâ€, and by creating a â€œweb of trustâ€ where keys depend on other keys.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://blog.filippo.io/giving-up-on-long-term-pgp/"&gt;Long term keys are almost never what you want&lt;/a&gt;. If you keep using a key, it eventually gets exposed. You want the blast radius of a compromise to be as small as possible, and, just as importantly, you donâ€™t want users to hesitate even for a moment at the thought of rolling a new key if thereâ€™s any concern at all about the safety of their current key.&lt;/p&gt;
&lt;p&gt;The PGP cheering section will immediately reply â€œthatâ€™s why you keep keys on a Yubikeyâ€. To a decent first approximation, nobody in the whole world uses the expensive Yubikeys that do this, and you canâ€™t imagine a future in which that changes (we can barely get U2F rolled out, and those keys are disposable). We canâ€™t accept bad cryptosystems just to make Unix nerds feel better about their toys.&lt;/p&gt;
&lt;h3&gt;Broken Authentication&lt;/h3&gt;
&lt;p&gt;More on PGPâ€™s archaic primitives: way back in 2000, the OpenPGP working group realized they needed to authenticate ciphertext, and that PGPâ€™s signatures werenâ€™t accomplishing that. So OpenPGP invented &lt;a href="https://tools.ietf.org/html/rfc4880#section-5.14"&gt;the MDC system&lt;/a&gt;: PGP messages with MDCs attach a SHA-1 of the plaintext to the plaintext, which is then encrypted (as normal) in CFB mode.&lt;/p&gt;
&lt;p&gt;If youâ€™re wondering how PGP gets away with this when modern systems use relatively complex AEAD modes (why canâ€™t everyone just tack a SHA-1 to their plaintext), youâ€™re not alone. Where to start with this Rube Goldberg contraption? The PGP MDC can be stripped off messages  it was encoded in such a way that you can simply chop off the last 22 bytes of the ciphertext to do that. To retain backwards compatibility with insecure older messages, PGP introduced a new packet type to signal that the MDC needs to be validated; if you use the wrong type, the MDC doesnâ€™t get checked. Even if you do, the new SEIP packet format is close enough to the insecure SE format that you can potentially trick readers into downgrading; &lt;a href="https://mailarchive.ietf.org/arch/msg/openpgp/tB00vO5r-qneX9wz1xz3netpXVU"&gt;Trevor Perrin worked the SEIP out to 16 whole bits of security.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;And, finally, even if everything goes right, the reference PGP implementation will (wait for it) release unauthenticated plaintext to callers, &lt;em&gt;even if the MDC doesnâ€™t match&lt;/em&gt;.&lt;/p&gt;
&lt;h3&gt;Incoherent Identity&lt;/h3&gt;
&lt;p&gt;PGP is an application. Itâ€™s a set of integrations with other applications. Itâ€™s a file format. Itâ€™s also a social network, and a subculture.&lt;/p&gt;
&lt;p&gt;PGP pushes notion of a cryptographic identity. You generate a key, save it in your keyring, print its fingerprint on your business card, and publish it to a keyserver. You sign other peopleâ€™s keys. They in turn may or may not rely on your signatures to verify other keys. Some people go out of their way to meet other PGP users in person to exchange keys and more securely attach themselves to this â€œweb of trustâ€. Other people organize â€œkey signing partiesâ€. The image youâ€™re conjuring in your head of that accurately explains how hard it is to PGPâ€™s devotees to switch to newer stuff.&lt;/p&gt;
&lt;p&gt;None of this identity goop works. Not the key signing web of trust, not the keyservers, not the parties. Ordinary people will trust anything that looks like a PGP key no matter where it came from  how could they not, when even an expert would have a hard time articulating how to evaluate a key? Experts donâ€™t trust keys they havenâ€™t exchanged personally. Everyone else relies on centralized authorities to distribute keys. PGPâ€™s key distribution mechanisms are theater.&lt;/p&gt;
&lt;h3&gt;Leaks Metadata&lt;/h3&gt;
&lt;p&gt;Forget the email debacle for a second (weâ€™ll get to that later). PGP by itself leaks metadata. Messages are (in normal usage) linked directly to key identifiers, which are, throughout PGPâ€™s cobweb of trust, linked to user identity. Further, a rather large fraction of PGP users make use of keyservers, which can themselves leak to the network the identities of which PGP users are communicating with each other.&lt;/p&gt;
&lt;h3&gt;No Forward Secrecy&lt;/h3&gt;
&lt;p&gt;A good example of that last problem: secure messaging crypto demands forward secrecy. Forward secrecy means that if you lose your key to an attacker today, they still canâ€™t go back and read yesterdayâ€™s messages; they had to be there with the key yesterday to read them. In modern cryptography engineering, we assume our adversary is recording everything, into infinite storage. PGPâ€™s claimed adversaries include world governments, many of whom are certainly doing exactly that. Against serious adversaries and without forward secrecy, breaches are a question of â€œwhenâ€, not â€œifâ€.&lt;/p&gt;
&lt;p&gt;To get forward secrecy in practice, you typically keep two secret keys: a short term session key and a longer-term trusted key. The session key is ephemeral (usually the product of a DH exchange) and the trusted key signs it, so that a man-in-the-middle canâ€™t swap their own key in. Itâ€™s theoretically possible to achieve a facsimile of forward secrecy using the tools PGP provides. Of course, pretty much nobody does this.&lt;/p&gt;
&lt;h3&gt;Clumsy Keys&lt;/h3&gt;
&lt;p&gt;An OpenBSD signify(1) public key is a Base64 string short enough to fit in the middle of a sentence in an email; the private key, which isnâ€™t an interchange format, is just a line or so longer. A PGP public key is a whole giant Base64 document; if youâ€™ve used them often, youâ€™re probably already in the habit of attaching them rather than pasting them into messages so they donâ€™t get corrupted. Signifyâ€™s key is a state-of-the-art Ed25519 key; PGPâ€™s is a weaker RSA key.&lt;/p&gt;
&lt;p&gt;You might think this stuff doesnâ€™t matter, but it matters a lot; orders of magnitude more people use SSH and manage SSH keys than use PGP. SSH keys are trivial to handle; PGPâ€™s are not.&lt;/p&gt;
&lt;h3&gt;Negotiation&lt;/h3&gt;
&lt;p&gt;PGP supports ElGamal. PGP supports RSA. PGP supports the NIST P-Curves. PGP supports Brainpool. PGP supports Curve25519. PGP supports SHA-1. PGP supports SHA-2. PGP supports RIPEMD160. PGP supports IDEA. PGP supports 3DES. PGP supports CAST5. PGP supports AES. There is no way this is a complete list of what PGP supports.&lt;/p&gt;
&lt;p&gt;If weâ€™ve learned 3 important things about cryptography design in the last 20 years, at least 2 of them are that negotiation and compatibility are evil. The flaws in cryptosystems tend to appear in the joinery, not the lumber, and expansive crypto compatibility increases the amount of joinery. Modern protocols like TLS 1.3 are jettisoning backwards compatibility with things like RSA, not adding it. New systems support &lt;em&gt;just a single suite of primitives&lt;/em&gt;, and a simple version number. If one of those primitives fails, you bump the version and chuck the old protocol all at once.&lt;/p&gt;
&lt;p&gt;If weâ€™re unlucky, and people are still using PGP 20 years from now, PGP will be the only reason any code anywhere includes CAST5. We canâ€™t say this more clearly or often enough: you can have backwards compatibility with the 1990s or you can have sound cryptography; you canâ€™t have both.&lt;/p&gt;
&lt;h3&gt;Janky Code&lt;/h3&gt;
&lt;p&gt;The de facto standard implementation of PGP is GnuPG. GnuPG is not carefully built. Itâ€™s a sprawling C-language codebase with duplicative functionality (write-ups of the most recent SKS key parsing denial of service noted that it has multiple key parsers, for instance) with a &lt;a href="https://www.cvedetails.com/vulnerability-list/vendor_id-4711/Gnupg.html"&gt;long track record of CVEs&lt;/a&gt; ranging from memory corruption to cryptographic side channels. It has at times been possible to strip authenticators off messages without GnuPG noticing. Itâ€™s been possible to feed it keys that donâ€™t fingerprint properly without it noticing. The 2018 Efail vulnerability was a result of it releasing unauthenticated plaintext to callers. GnuPG is not good.&lt;/p&gt;
&lt;p&gt;GnuPG is also effectively the reference implementation for PGP, and also the basis for most other tools that integrate PGP cryptography. It isnâ€™t going anywhere. To rely on PGP is to rely on GPG.&lt;/p&gt;
&lt;h2&gt;The Answers&lt;/h2&gt;
&lt;p&gt;One of the rhetorical challenges of persuading people to stop using PGP is that thereâ€™s no one thing you can replace it with, &lt;em&gt;nor should there be&lt;/em&gt;. What you should use instead depends on what youâ€™re doing.&lt;/p&gt;
&lt;h3&gt;Talking To People&lt;/h3&gt;
&lt;p&gt;Use Signal. Or Wire, or WhatsApp, or some other Signal-protocol-based secure messenger.&lt;/p&gt;
&lt;p&gt;Modern secure messengers are purpose-built around messaging. They use privacy-preserving authentication handshakes, repudiable messages, &lt;em&gt;cryptographic ratchets&lt;/em&gt; that rekey on every message exchange, and, of course, modern encryption primitives. Messengers are trivially easy to use and thereâ€™s no fussing over keys and subkeys. If you use Signal, you get even more than that: you get a system so paranoid about keeping private metadata off servers that it tunnels Giphy searches to avoid traffic analysis attacks, and until relatively recently didnâ€™t even support user profiles.&lt;/p&gt;
&lt;h3&gt;Encrypting Email&lt;/h3&gt;
&lt;p&gt;Donâ€™t.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://news.ycombinator.com/item?id=16088386"&gt;Email is insecure&lt;/a&gt;. Even with PGP, itâ€™s default-plaintext, which means that even if you do everything right, some totally reasonable person you mail, doing totally reasonable things, will invariably CC the quoted plaintext of your encrypted message to someone else (we donâ€™t know a PGP email user who hasnâ€™t seen this happen). PGP email is forward-insecure. Email metadata, including the subject (which is literally message content), are always plaintext.&lt;/p&gt;
&lt;p&gt;If you needed another reason, &lt;a href="https://www.usenix.org/system/files/conference/usenixsecurity18/sec18-poddebniak.pdf"&gt;read the Efail paper&lt;/a&gt;. The GnuPG community, &lt;a href="https://web.archive.org/web/20181225214730/https://flaked.sockpuppet.org/2018/05/16/a-unified-timeline.html"&gt;which mishandled the Efail disclosure&lt;/a&gt;, talks this research down a lot, but it was accepted at Usenix Security (one of the top academic software security venues) and at Black Hat USA (&lt;em&gt;the&lt;/em&gt; top industry software security venue), was one of the best cryptographic attacks of the last 5 years, and is a pretty devastating indictment of the PGP ecosystem. As youâ€™ll see from the paper, S/MIME isnâ€™t better.&lt;/p&gt;
&lt;p&gt;This isnâ€™t going to get fixed. To make actually-secure email, youâ€™d have to tunnel another protocol over email (youâ€™d still be conceding traffic analysis attacks). At that point, why bother pretending?&lt;/p&gt;
&lt;p&gt;Encrypting email is asking for a calamity. Recommending email encryption to at-risk users is malpractice. Anyone who tells you itâ€™s secure to communicate over PGP-encrypted email is putting their weird preferences ahead of your safety.&lt;/p&gt;
&lt;h3&gt;Sending Files&lt;/h3&gt;
&lt;p&gt;Use &lt;a href="https://github.com/warner/magic-wormhole"&gt;Magic Wormhole&lt;/a&gt;. Wormhole clients use a one-time password-authenticated key exchange (PAKE) to encrypt files to recipients. Itâ€™s easy (for nerds, at least), secure, and fun: we havenâ€™t introduced wormhole to anyone who didnâ€™t start gleefully wormholing things immediately just like we did.&lt;/p&gt;
&lt;p&gt;Someone stick a Windows installer on a Go or Rust implementation of Magic Wormhole right away; itâ€™s too great for everyone not to have.&lt;/p&gt;
&lt;p&gt;If youâ€™re working with lawyers and not with technologists, Signal does a perfectly cromulent job of securing file transfers. Put a Signal number on your security page to receive bug bounty reports, not a PGP key.&lt;/p&gt;
&lt;h3&gt;Encrypting Backups&lt;/h3&gt;
&lt;p&gt;Use Tarsnap. &lt;a href="https://www.tarsnap.com/design.html"&gt;Colin can tell you all about how Tarsnap is optimized to protect backups.&lt;/a&gt; Or really, use any other encrypted backup tool that lots of other people use; they wonâ€™t be as good as Tarsnap but theyâ€™ll all do a better job than PGP will.&lt;/p&gt;
&lt;p&gt;Need offline backups? Use encrypted disk images; theyâ€™re built into modern Windows, Linux, and macOS. &lt;a href="https://sockpuppet.org/blog/2014/04/30/you-dont-want-xts/"&gt;Full disk encryption isnâ€™t great&lt;/a&gt;, but it works fine for this use case, and itâ€™s easier and safer than PGP.&lt;/p&gt;
&lt;h3&gt;Signing Packages&lt;/h3&gt;
&lt;p&gt;Use Signify/Minisign. &lt;a href="https://www.openbsd.org/papers/bsdcan-signify.html"&gt;Ted Unangst will tell you all about it.&lt;/a&gt; Itâ€™s what OpenBSD uses to sign packages. Itâ€™s extremely simple and uses modern signing. &lt;a href="https://jedisct1.github.io/minisign/"&gt;Minisign&lt;/a&gt;, from Frank Denis, the libsodium guy, brings the same design to Windows and macOS; it has bindings for Go, Rust, Python, Javascript, and .NET; itâ€™s even compatible with Signify.&lt;/p&gt;
&lt;h3&gt;Encrypting Application Data&lt;/h3&gt;
&lt;p&gt;Use  &lt;a href="https://github.com/jedisct1/libsodium"&gt;libsodium&lt;/a&gt; It builds everywhere, has interface thatâ€™s designed to be hard to misuse, and you wonâ€™t have to shell out to a binary to use it.&lt;/p&gt;
&lt;h3&gt;Encrypting Files&lt;/h3&gt;
&lt;p&gt;This really is a problem. If youâ€™re/not/making a backup, and youâ€™re /not/archiving something offline for long-term storage, and youâ€™re /not/encrypting in order to securely send the file to someone else, and youâ€™re /not/encrypting virtual drives that you mount/unmount as needed to get work done, then thereâ€™s no one good tool that does this now. Filippo Valsorda is working on â€œ&lt;a href="https://docs.google.com/document/d/11yHom20CrsuX8KQJXBBw04s80Unjv8zCg_A7sPAX_9Y/view"&gt;age&lt;/a&gt;â€ for these use cases, and I'm super optimistic about it, but it's not there yet.&lt;/p&gt;
&lt;p&gt;Hopefully itâ€™s clear that this is a pretty narrow use case. We work in software security and handle sensitive data, including bug bounty reports (another super common â€œwe need PGP!â€ use case), and we almost never have to touch PGP.&lt;/p&gt;
&lt;p&gt;(This post was syndicated on the Latacora blog.)&lt;/p&gt;&lt;/div&gt;</description><category>cryptography</category><category>security</category><guid>https://www.lvh.io/posts/the-pgp-problem/</guid><pubDate>Wed, 17 Jul 2019 03:14:00 GMT</pubDate></item><item><title>Analyzing a simple encryption scheme using GitHub SSH keys</title><link>https://www.lvh.io/posts/analyzing-a-simple-encryption-scheme-using-github-ssh-keys/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;p&gt;(This is an introductory level analysis of a scheme involving RSA. If you're already comfortable with Bleichenbacher oracles you should skip it.)&lt;/p&gt;
&lt;p&gt;Someone pointed me at the following suggestion on the Internet for encrypting secrets to people based on their GitHub SSH keys. I like the idea of making it easier for people to leverage key material and tools they already have.  The encryption instructions are:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;"my secret"&lt;/span&gt; &amp;gt; message.txt
curl -q github.com/&lt;span class="nv"&gt;$USER&lt;/span&gt;.keys &lt;span class="p"&gt;|&lt;/span&gt; head -n &lt;span class="m"&gt;1&lt;/span&gt; &amp;gt; recipient.pub
ssh-keygen -e -m pkcs8 -f recipient.pub &amp;gt; recipient.pem
openssl rsautl -encrypt -pubin -inkey recipient.pem -ssl &lt;span class="se"&gt;\&lt;/span&gt;
    -in message.txt -out encrypted.txt
&lt;/pre&gt;


&lt;p&gt;Anything using an openssl command line tool makes me a little uncomfortable. Let's poke at it a little.&lt;/p&gt;
&lt;p&gt;We'll assume that that first key is really an RSA key and we don't have to worry about EdDSA or ECDSA (or heaven forbid, DSA). You're encrypting a password for someone. The straightforward threat model is an attacker who has the public key and ciphertext (but no plaintext) and wants to decrypt the ciphertext.&lt;/p&gt;
&lt;p&gt;There are a few ways you can try to attack RSA schemes. You could attack the underlying math: maybe the keys were generated with insufficient entropy (e.g. &lt;a href="https://www.lvh.io/posts/analyzing-a-simple-encryption-scheme-using-github-ssh-keys/%5Bcve.mitre.org/cgi-bin/c...%5D(http:/cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2008-0166)"&gt;the Debian weak SSH keys problem&lt;/a&gt;) or bogus prime generation (e.g. &lt;a href="https://www.lvh.io/posts/analyzing-a-simple-encryption-scheme-using-github-ssh-keys/%5Bcve.mitre.org/cgi-bin/c...%5D(https:/cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-15361)"&gt;ROCA&lt;/a&gt;). In either case, you can generate the private key from the public key. These keys off of GitHub are likely OpenSSH-generated SSH keys generated on developer laptops and hence unlikely to have that sort of problem. It's also not specific to this scheme. (A real attacker would still check.)&lt;/p&gt;
&lt;p&gt;Other attacks depend on the type of RSA padding used. The thing that sticks out about that &lt;code&gt;openssl rsautl -encrypt&lt;/code&gt; is the &lt;code&gt;-ssl&lt;/code&gt; flag. The man page claims:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;-pkcs, -oaep, -ssl, -raw&lt;/p&gt;
&lt;p&gt;the padding to use: PKCS#1 v1.5 (the default), PKCS#1 OAEP, special padding used in SSL v2
   backwards compatible handshakes, or no padding, respectively.  For signatures, only -pkcs
   and -raw can be used.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;iA! iA! I forgot that SSLv2 has its own weird padding variant: I remembered it as PKCSv15 from the last time I looked (DROWN). After some source diving (thanks pbsd!) I figured out that backwards-compatible SSLv2 padding is like PKCS1v15, but the first 8 bytes of the random padding are &lt;code&gt;0x03&lt;/code&gt; (&lt;a href="https://www.lvh.io/posts/analyzing-a-simple-encryption-scheme-using-github-ssh-keys/%5Bgithub.com/openssl/o...%5D(https:/github.com/openssl/openssl/blob/1212818eb07add297fe562eba80ac46a9893781e/crypto/rsa/rsa_pk1.c#L117-L152)"&gt;PKCS1v15 code&lt;/a&gt;, &lt;a href="https://www.lvh.io/posts/analyzing-a-simple-encryption-scheme-using-github-ssh-keys/%5Bgithub.com/openssl/o...%5D(https:/github.com/openssl/openssl/blob/1212818eb07add297fe562eba80ac46a9893781e/crypto/rsa/rsa_ssl.c#L16-L53)"&gt;SSLv2 code&lt;/a&gt;). That's weird, but OK: let's just say it's weird PKCSv15 and move on.&lt;/p&gt;
&lt;p&gt;PKCS1v15 and its SSLv2 variant are both vulnerable to Bleichenbacher's oracle attack. That attack relies on being able to mess with a ciphertext and learn from how it fails decryption via an error message or a timing side channel. That doesn't work here: this model is "offline": the attacker gets a ciphertext and a public key, but they don't get to talk to anything that knows how to decrypt.  Hence, they don't get to try to get it to decrypt maliciously modified ciphertexts either.&lt;/p&gt;
&lt;p&gt;There are lots of ways unpadded ("textbook") RSA is unsafe, but one of them is that it's deterministic. If &lt;em&gt;c = m&lt;sup&gt;e&lt;/sup&gt; mod N&lt;/em&gt; and an attacker is given a &lt;em&gt;c&lt;/em&gt; and they can guess a bunch of &lt;em&gt;m&lt;/em&gt;, they know &lt;em&gt;which&lt;/em&gt; &lt;em&gt;m&lt;/em&gt; produced a particular &lt;em&gt;c&lt;/em&gt;, and so decrypted the ciphertext. That sounds like a weird model at first, since the attacker comes up with &lt;em&gt;m&lt;/em&gt; and just "confirms" it's the right one. It would work here regardless: passwords are often low-entropy and can be enumerated, that's the premise of modern password cracking.&lt;/p&gt;
&lt;p&gt;But that's raw RSA, not PKCS1v15 padding, which is &lt;code&gt;EB = 00 || BT || PS || 00 || D&lt;/code&gt; (see &lt;a href="https://www.lvh.io/posts/analyzing-a-simple-encryption-scheme-using-github-ssh-keys/%5Btools.ietf.org/html/rfc2...%5D(https:/tools.ietf.org/html/rfc2313)"&gt;RFC&lt;/a&gt;), where BT is the block type (here 02 for public key encryption). D is the data you're encrypting. PS is the  "padding string", which is a little confusing because the entire operation is padding. It's randomly generated when you're doing an RSA encryption operation. If you call the maximum size we can run through RSA k (the modulus size), the maximum length for PS is k - D - 3 (one for each null byte and one for the BT byte). The spec insists (and OpenSSL correctly enforces) this to be at least 8 bytes, or 64 bits of entropy. You can do about 50k/s public key operations on my dinky virtualized and heavily power throttled laptop. 64 bits is a bunch but not infinity. That's still not a very satisfactory result.&lt;/p&gt;
&lt;p&gt;But wait--it's &lt;em&gt;not&lt;/em&gt; PKCS1V15, it's that weird SSLv2 padding which sets the first 8 bytes of the padding string to 0x03 bytes. If the padding string is just 8 bytes long, that means the padding string is entirely determined. We can verify that by trying to encrypt a message of the appropriate size. For a 2048 bit RSA key, that's 2048 // 8 == 256 bytes worth of modulus, 3 bytes worth of header bytes and 8 bytes worth of padding, so a 256 - 8 - 3 == 245 byte message. You can go check that any 245 message encrypts to the same ciphertext every time. There's no lower bound on the amount of entropy in the ciphertext. A 244 byte message will encrypt to one of 256 ciphertexts: one for each possible pseudorandom padding value.&lt;/p&gt;
&lt;p&gt;Practically, is this still fine? Probably, but only within narrow parameters. If the message you're encrypting is very close to 245 bytes and has plenty of structure known to the attacker, it isn't. If I can get you to generate a lot of these (say, a CI system automating the same scheme), it won't be. It's the kind of crypto that makes me vaguely uncomfortable but you'll probably get away with because there's no justice in the world.&lt;/p&gt;
&lt;p&gt;There's a straightforward way to improve this. Remember how I said &lt;code&gt;-ssl&lt;/code&gt; was weird? Not specifying anything would've resulted in the better-still-not-great PKCS1v15 padding. If you are going to specify a padding strategy, specify &lt;code&gt;-oaep&lt;/code&gt;. OAEP is the good RSA encryption padding. By default, OpenSSL uses SHA1 with it (for both the message digest and in MGF1), which is fine for this purpose. That gives you 160 bits of randomness, which ought to be plenty.&lt;/p&gt;
&lt;p&gt;This is why most schemes use RSA to encrypt a symmetric key.&lt;/p&gt;
&lt;p&gt;Future blog posts: how to fix this, creative scenarios in which we mess with those parameters so it breaks, and how to do the same with ECDSA/EdDSA keys. For the latter: I asked a smart person and the "obvious" thing to them was not the thing I'd have done. For EdDSA, my first choice would be to convert the public key from Ed25519 to X25519 and then use NaCl box. They'd use the EdDSA key directly. So, if you're interested, we'll could do a post on that. And then we'd probably talk about why you use NIST P-256 for both signatures and ECDH, but different curve formats in djb country: Ed25519 for signatures and X25519 for ECDH. Oh, and we should do some entropy estimation. People often know how to do that for passwords, but for this threat model we also need to do that for English prose.&lt;/p&gt;&lt;/div&gt;</description><category>cryptography</category><guid>https://www.lvh.io/posts/analyzing-a-simple-encryption-scheme-using-github-ssh-keys/</guid><pubDate>Sun, 30 Sep 2018 19:54:00 GMT</pubDate></item><item><title>The default OpenSSH key encryption is worse than plaintext</title><link>https://www.lvh.io/posts/the-default-openssh-key-encryption-is-worse-than-plaintext/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;p&gt;The eslint-scope npm package got compromised recently, stealing npm credentials from your home directory. We started running tabletop exercises: what else would you smash-and-grab, and how can we mitigate that risk?&lt;/p&gt;
&lt;p&gt;Most people have an RSA SSH key laying around. That SSH key has all sorts of privileges: typically logging into prod and GitHub access. Unlike an npm credential, an SSH key is encrypted, so perhaps itâ€™s safe even if it leaks? Letâ€™s find out!&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;user&lt;/span&gt;&lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="nv"&gt;work&lt;/span&gt; &lt;span class="nv"&gt;/tmp&lt;/span&gt; &lt;span class="nv"&gt;$&lt;/span&gt; &lt;span class="nv"&gt;ssh-keygen&lt;/span&gt;
&lt;span class="nv"&gt;Generating&lt;/span&gt; &lt;span class="nv"&gt;public/private&lt;/span&gt; &lt;span class="nv"&gt;rsa&lt;/span&gt; &lt;span class="nb"&gt;key &lt;/span&gt;&lt;span class="nv"&gt;pair.&lt;/span&gt;
&lt;span class="nv"&gt;Enter&lt;/span&gt; &lt;span class="nv"&gt;file&lt;/span&gt; &lt;span class="nv"&gt;in&lt;/span&gt; &lt;span class="nv"&gt;which&lt;/span&gt; &lt;span class="nv"&gt;to&lt;/span&gt; &lt;span class="nv"&gt;save&lt;/span&gt; &lt;span class="nv"&gt;the&lt;/span&gt; &lt;span class="nb"&gt;key &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;/home/user/.ssh/id_rsa&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt; &lt;span class="nv"&gt;mykey&lt;/span&gt;
&lt;span class="nv"&gt;...&lt;/span&gt;
&lt;span class="nv"&gt;user&lt;/span&gt;&lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="nv"&gt;work&lt;/span&gt; &lt;span class="nv"&gt;/tmp&lt;/span&gt; &lt;span class="nv"&gt;$&lt;/span&gt; &lt;span class="nv"&gt;head&lt;/span&gt; &lt;span class="nv"&gt;-n&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt; &lt;span class="nv"&gt;mykey&lt;/span&gt;
&lt;span class="nv"&gt;-----BEGIN&lt;/span&gt; &lt;span class="nv"&gt;RSA&lt;/span&gt; &lt;span class="nv"&gt;PRIVATE&lt;/span&gt; &lt;span class="nv"&gt;KEY-----&lt;/span&gt;
&lt;span class="nv"&gt;Proc-Type&lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;,&lt;span class="nv"&gt;ENCRYPTED&lt;/span&gt;
&lt;span class="nv"&gt;DEK-Info&lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt; &lt;span class="nv"&gt;AES-128-CBC&lt;/span&gt;,&lt;span class="nv"&gt;CB973D5520E952B8D5A6B86716C6223F&lt;/span&gt;

&lt;span class="nv"&gt;+5ZVNE65kl8kwZ808e4+Y7Pr8IFstgoArpZJ/bkOs7rB9eAfYrx2CLBqLATk1RT/&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;You can tell itâ€™s encrypted because it says so right there. It also doesnâ€™t start with &lt;code&gt;MII&lt;/code&gt; -- the base64 DER clue that an RSA key follows. And AES! Thatâ€™s good, right? CBC with ostensibly a random IV, even! No MAC, but without something like a padding oracle to try modified ciphertexts on, so that might be OK?&lt;/p&gt;
&lt;p&gt;Itâ€™s tricky to find out what this DEK-Info stuff means. Searching the openssh-portable repo for the string DEK-Info only shows sample keys. The punchline is that the AES key is just MD5(password || IV[:8]). Thatâ€™s not good at all: password storage best practice holds that passwords are bad (low entropy) and in order to turn them into cryptographic key material you need an expensive function like Argon2. MD5 is very cheap to compute. The only thing this design has going for it is that the salt goes after the password, so you canâ€™t just compute the intermediate state of MD5(IV[8:]) and try passwords from there. Thatâ€™s faint praise, especially in a world where I can rent a machine that tries billions of MD5 calls per second. There just arenâ€™t that many passwords.&lt;/p&gt;
&lt;p&gt;You might ask yourself how OpenSSH ended up with this. The sad answer is the OpenSSL command line tool had it as a default, and now weâ€™re stuck with it.&lt;/p&gt;
&lt;p&gt;Thatâ€™s a fair argument to say that standard password-encrypted keys are about as good as plaintext: the encryption is ineffective. But I made a stronger statement: itâ€™s &lt;em&gt;worse&lt;/em&gt;. The argument there is simple: an SSH key password is unlikely to be managed by a password manager: instead itâ€™s something you remember. If you remember it, you probably reused it somewhere. Perhaps itâ€™s even your device password. This leaked key provides an oracle: if I guess the password correctly (and thatâ€™s feasible because the KDF is bad), I know I guessed correctly because I can check against your public key.&lt;/p&gt;
&lt;p&gt;Thereâ€™s nothing wrong with the RSA key pair itself: itâ€™s just the symmetric encryption of the private key. You canâ€™t mount this attack from just a public key.&lt;/p&gt;
&lt;p&gt;How do you fix this? OpenSSH has a new key format that you should use. â€œNewâ€ means 2013. This format uses bcrypt_pbkdf, which is essentially bcrypt with fixed difficulty, operated in a PBKDF2 construction. Conveniently, you always get the new format when generating Ed25519 keys, because the old SSH key format doesnâ€™t support newer key types. Thatâ€™s a weird argument: you donâ€™t really need your key format to define how Ed25519 serialization works since Ed25519 itself already defines how serialization works. But if thatâ€™s how we get good KDFs, thatâ€™s not the pedantic hill I want to die on. Hence, one answer is ssh-keygen -t ed25519. If, for compatibility reasons, you need to stick to RSA, you can use ssh-keygen -o. That will produce the new format, even for old key types. You can upgrade existing keys with ssh-keygen -p -o -f PRIVATEKEY. If your keys live on a Yubikey or a smart card, you don't have this problem either.&lt;/p&gt;
&lt;p&gt;We want to provide a better answer to this. On the one hand, aws-vault has shown the way by moving credentials off disk and into keychains. Another parallel approach is to move development into partitioned environments. Finally, most startups should consider not having long-held SSH keys, instead using temporary credentials issued by an SSH CA, ideally gated on SSO. Unfortunately this doesn't work for GitHub.&lt;/p&gt;
&lt;p&gt;PS: Itâ€™s hard to find an authoritative source, but from my memory: the versioned parameter in the PEM-like OpenSSH private key format only affect the encryption method. That doesnâ€™t matter in the slightest: itâ€™s the KDF thatâ€™s broken. Thatâ€™s an argument against piecemeal negotiating parts of protocols, Iâ€™m sure. Weâ€™ll get you a blog post on that later.&lt;/p&gt;
&lt;p&gt;The full key is available here, just in case you feel like running john the ripper on something today: &lt;a href="https://gist.github.com/lvh/c532c8fd46115d2857f40a433a2416fd"&gt;gist.github.com/lvh/c532c...&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;(This post was syndicated on the Latacora blog.)&lt;/p&gt;&lt;/div&gt;</description><category>cryptography</category><category>security</category><guid>https://www.lvh.io/posts/the-default-openssh-key-encryption-is-worse-than-plaintext/</guid><pubDate>Sat, 04 Aug 2018 02:00:18 GMT</pubDate></item><item><title>Factoring the Noise protocol matrix</title><link>https://www.lvh.io/posts/factoring-the-noise-protocol-matrix/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;style&gt;
    .matrix {
        position: relative;
        margin: auto;
        margin-bottom: 2em;
    }
    .matrix:before, .matrix:after {
        content: "";
        position: absolute;
        top: 0;
        border: 3px solid #000;
        width: 20px;
        height: 100%;
    }
    .matrix:before {
        left: -10px;
        border-right: 0;
    }
    .matrix:after {
        right: -10px;
        border-left: 0;
    }
    .matrix td {
        vertical-align: middle;
        min-width: 100px;
        margin-bottom: 10px;
    }
    .matrix td p {
        vertical-align: middle;
        text-align: center;
        margin: auto;
    }
&lt;/style&gt;

&lt;p&gt;The Noise protocol is one of the best things to happen to encrypted protocol
design. &lt;a href="https://www.wireguard.com"&gt;WireGuard&lt;/a&gt; inherits its elegance from Noise.
Noise is a cryptography engineer's darling spec. It's important not to get
blindsided while fawning over it and to pay attention to where implementers run
into trouble. Someone raised a concern I had run into before: Noise has a
matrix.&lt;/p&gt;
&lt;table class="matrix" style="width:100%"&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;N(rs):&lt;br&gt;  â† s&lt;br&gt;  ...&lt;br&gt;  â†’ e, es&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NN:&lt;br&gt;  â†’ e&lt;br&gt;  â† e, ee&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KN:&lt;br&gt; â†’ s&lt;/span&gt;&lt;br&gt;&lt;span&gt;  ...&lt;br&gt; â†’ e&lt;br&gt; â† e, ee, se&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XN:&lt;br&gt;  â†’ e&lt;br&gt;  â† e, ee&lt;br&gt;  â†’ s, se&lt;/span&gt;&lt;/p&gt;
                &lt;p&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IN:&lt;/span&gt;&lt;br&gt;&lt;span&gt;  â†’ e, s&lt;br&gt;  â† e, ee, se&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;K(s, rs):&lt;br&gt;  â†’ s&lt;br&gt;  â† s&lt;br&gt;  ...&lt;br&gt;  â†’ e, es, ss&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NK:&lt;br&gt;  â† s&lt;br&gt;  ...&lt;br&gt;  â†’ e, es&lt;br&gt;  â† e, ee&lt;/span&gt;&lt;/p&gt;
                &lt;p&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KK:&lt;/span&gt;&lt;br&gt;&lt;span&gt;  â†’ s&lt;/span&gt;&lt;br&gt;&lt;span&gt;  â† s&lt;/span&gt;&lt;br&gt;&lt;span&gt;  â€¦&lt;/span&gt;&lt;br&gt;&lt;span&gt;  â†’ e, es, ss&lt;/span&gt;&lt;br&gt;&lt;span&gt;  â† e, ee, se&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XK:&lt;br&gt;  â† s&lt;br&gt;  ...&lt;br&gt;  â†’ e, es&lt;br&gt;  â† e, ee&lt;br&gt;  â†’ s, se&lt;/span&gt;&lt;/p&gt;
                &lt;p&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IK:&lt;/span&gt;&lt;br&gt;&lt;span&gt;  â† s&lt;br&gt;  ...&lt;br&gt;  â†’ e, es, s, ss&lt;br&gt;  â† e, ee, se&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;X(s, rs):&lt;br&gt;  â† s&lt;br&gt;  ...&lt;br&gt;  â†’ e, es, s, ss&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NX:&lt;br&gt;  â†’ e&lt;br&gt;  â† e, ee, s, es&lt;/span&gt;&lt;/p&gt;
                &lt;p&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KX:&lt;br&gt;  â†’ s&lt;br&gt;  ...&lt;br&gt;  â†’ e&lt;br&gt;  â† e, ee, se, s, es&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XX:&lt;br&gt;  â†’ e&lt;br&gt;  â† e, ee, s, es&lt;br&gt;  â†’ s, se&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt; IX:&lt;/span&gt;&lt;br&gt;&lt;span&gt;  â†’ e, s&lt;/span&gt;&lt;br&gt;&lt;span&gt;  â† e, ee, se, s, es&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;To a cryptography engineer, this matrix is beautiful. These eldritch runes
describe a grammar: the number of ways you can meaningfully compose the phrases
that can make up a Noise handshake into a proper protocol. The rest of the
document describes what the trade-offs between them are: whether the protocol is
one-way or interactive, whether you get resistance against key-compromise
impersonation, what sort of privacy guarantees you get, et cetera.
(Key-compromise impersonation means that if I steal your key, I can impersonate
anyone to you.)&lt;/p&gt;
&lt;p&gt;To the layperson implementer, the matrix is terrifying. They hadn't thought
about key-compromise impersonation or the distinction between known-key,
hidden-key and exposed-key protocols or even forward secrecy. They're going to
fall back to something else: something probably less secure but at least
unambiguous on what to do. As Noise matures into a repository for protocol
templates with wider requirements, this gets worse, not better. The most recent
revision of the Noise protocol adds 23 new "deferred" variants. It's unlikely
these will be the last additions.&lt;/p&gt;
&lt;p&gt;Which Noise variant should that layperson use? Depends on the application of
course, but we can make some reasonable assumptions for most apps. Ignoring
variants, we have:&lt;/p&gt;
&lt;table style="text-align: center" class="matrix"&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;N&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NN&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KN&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XN&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IN&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;K&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;X&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Firstly, let's assume you need bidirectional communication, meaning
initiator and responder can send messages to each other as opposed to
just initiator to responder. That gets rid of the first column of the
matrix.&lt;/p&gt;
&lt;table style="text-align: center" class="matrix"&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;N&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NN&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KN&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XN&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IN&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;K&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;X&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;The other protocols are defined by two letters. From the spec:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The first character refers to the initiator's static key:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;N = No static key for initiator&lt;/li&gt;
&lt;li&gt;K = Static key for initiator Known to responder&lt;/li&gt;
&lt;li&gt;X = Static key for initiator Xmitted ("transmitted") to responder&lt;/li&gt;
&lt;li&gt;I = Static key for initiator Immediately transmitted to responder, despite reduced or absent identity hiding&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The second character refers to the responder's static key:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;N = No static key for responder&lt;/li&gt;
&lt;li&gt;K = Static key for responder Known to initiator&lt;/li&gt;
&lt;li&gt;X = Static key for responder Xmitted ("transmitted") to initiator&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;NN provides confidentiality against a passive attacker but neither party
has any idea who you're talking to because no static (long-term) keys
are involved. For most applications none of the *N suites make a ton of
sense: they imply the initiator does not care who they're connecting to.&lt;/p&gt;
&lt;table style="text-align: center" class="matrix"&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;N&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;NN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;KN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;XN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;IN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;K&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;X&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;NX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;For most applications the client (initiator) ought to have a fixed
static key so we have a convenient cryptographic identity for clients
over time. So really, if you wanted something with an N in it, you'd
know.&lt;/p&gt;
&lt;table style="text-align: center" class="matrix"&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;N&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;NN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;KN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;XN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;IN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;K&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;NK&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;X&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;NX&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;KX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;The responder usually doesn't know what the key is for any initiator that
happens to show up. This mostly makes sense if you have one central initiator
that reaches out to a lot of responders: something like an MDM or sensor data
collection perhaps. In practice, you often end up doing egress from those
devices anyway for reasons that have nothing to do with Noise. So, K* is out.&lt;/p&gt;
&lt;table style="text-align: center" class="matrix"&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;N&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;NN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;KN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;XN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;IN&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;K&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;NK&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;KK&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IK&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;X&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;NX&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;&lt;s&gt;KX&lt;/s&gt;&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;XX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
            &lt;td colspan="1" rowspan="1"&gt;
                &lt;p&gt;&lt;span&gt;IX&lt;/span&gt;&lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;These remaining suites generally trade privacy (how easily can you
identify participants) for latency (how many round trips are needed).&lt;/p&gt;
&lt;p&gt;IX doesn't provide privacy for the initiator at all, but that's the side you
usually care about. It still has the roundtrip downside, making it a niche
variant. XX and XK require an extra round trip before they send over the
initiator's static key. Flip side: they have the strongest possible
privacy protection for the initiator, whose identity is only sent to the
responder after they've been authenticated and forward secrecy has been
established.&lt;/p&gt;
&lt;p&gt;IK provides a reasonable tradeoff: no extra round trip and the
initiator's key is encrypted to the responder's static key. That means
that the initiator's key is only disclosed if the responder's key is
compromised. You probably don't care about that. It does require the
initiator to know the static key of the responder ahead of time but
that's probably true anyway: you want to check that key against a
trusted value. You can also try private keys for the responder offline
but that doesn't matter unless you gratuitously messed up key
generation. In conclusion, you probably want IK.&lt;/p&gt;
&lt;p&gt;This breakdown only works if you're writing a client-server application
that plausibly might've used mTLS instead. WireGuard, for example, is
built on Noise_IK. The other variants aren't pointless: they're just
good at different things. If you care more about protecting your
initiator's privacy than you do about handshake latency, you want
Noise_XK. If you're doing a peer-to-peer IoT system where device
privacy matters, you might end up with Noise_XX. (It's no accident
that IK, XK and XX are in the last set of protocols standing.)&lt;/p&gt;
&lt;h3&gt;Protocol variants&lt;/h3&gt;
&lt;p&gt;Ignore deferred variants for now. If you needed them you'd
know. PSK is an interesting quantum computer hedge. We'll talk more about
quantum key exchanges in a different post, but briefly: a shared PSK among
several participants protects against a passive adversary that records
everything and acquires a quantum computer some time in the future, while
retaining the convenient key distribution of public keys.&lt;/p&gt;
&lt;h3&gt;Conclusion&lt;/h3&gt;
&lt;p&gt;It's incredible how much has happened in the last few years
to make protocols safer, between secure protocol templates like Noise,
new proof systems like Tamarin, and ubiquitous libraries of safer
primitives like libsodium. So far, the right answer for a safe transport
has almost always been TLS, perhaps mutually authenticated. That's not
going to change right away, but if you control both sides of the network
and you need properties hard to get out of TLS, Noise is definitely The
Right Answer. Just don't stare at the eldritch rune matrix too long. You
probably want Noise_IK. Or, you know, ask your security person :)&lt;/p&gt;
&lt;p&gt;Thanks to Katriel Cohn-Gordon for reviewing this blog post.&lt;/p&gt;
&lt;p&gt;(This post was syndicated on the Latacora blog.)&lt;/p&gt;&lt;/div&gt;</description><category>security</category><guid>https://www.lvh.io/posts/factoring-the-noise-protocol-matrix/</guid><pubDate>Wed, 18 Jul 2018 17:59:00 GMT</pubDate></item><item><title>Self-compressing pickles</title><link>https://www.lvh.io/posts/self-compressing-pickles/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;p&gt;Iâ€™ve been working on some pickle security stuff. This is a teaser.&lt;/p&gt;
&lt;p&gt;Python pickles are extremely flexible: they can run essentially whatever code they want. That means you can create a pickle that contains a compressed pickle. The consumer doesnâ€™t know if an incoming pickle will be compressed or not: the Pickle VM takes care of the details.&lt;/p&gt;
&lt;p&gt;To do this, we define a useful little helper class:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;PickleCall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
     &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;
     &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__reduce__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
         &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;PickleCall is nothing but a convenience function for us to encode the function f being called with some args into a pickle. If youâ€™ve used pickle before and you know that it normally encodes classes by name, you might expect that the &lt;s&gt;victi&lt;/s&gt;consumer of the pickle also needs to define PickleCall, but thatâ€™s not the case. This class accomplishes that by explicitly implementing part of the pickle protocol with the __reduce__ method: it tells pickle how to encode it, and PickleCall isn't involved anymore. Of course, the â€œobviousâ€ thing to use PickleCall with is â€œos.systemâ€ and something involving /dev/tcp.&lt;/p&gt;
&lt;p&gt;Once you have PickleCall, writing the function that dumps an object to a string but with embedded zlib compression is straightforward:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pickle&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;loads&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dumps&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;zlib&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;decompress&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;zdumps&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;zpickle&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dumps&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;level&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;unz_call&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PickleCall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;decompress&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;zpickle&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;loads_call&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PickleCall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loads&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;unz_call&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;dumps&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loads_call&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;We can check that it works:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;zpickle = zdumps(["a"] * 100)
pickle = dumps(["a"] * 100)

loads(pickle) == loads(zpickle)
# =&amp;gt; True
len(zpickle), len(pickle)
# =&amp;gt; (82, 214)
&lt;/pre&gt;


&lt;p&gt;Internally, the structure for this looks as follows:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;   0: \x80 PROTO      3
   2: c    GLOBAL     '_pickle loads'
   17: c    GLOBAL     'zlib decompress'
   34: C    SHORT_BINBYTES b'x\xdak`\x8e-d\xd0\x88`d``H,d\xcc\x18\x160U\x0f\x00W\xb6+\xd4'     &amp;lt;= this is zlib-compressed pickle
   63: \x85 TUPLE1   &amp;lt;= set up arguments for zlib decompress
   64: R    REDUCE   &amp;lt;= call zlib decompress
   65: \x85 TUPLE1   &amp;lt;= set up arguments for pickle load
   66: R    REDUCE    &amp;lt;=  call pickle load
   67: .    STOP
&lt;/pre&gt;


&lt;p&gt;If you're trying to protect pickles the punchline here is that you probably need to whitelist because there are too many ways to hide things inside a pickle. (We're working on it.)&lt;/p&gt;
&lt;p&gt;(This post was syndicated on the Latacora blog.)&lt;/p&gt;&lt;/div&gt;</description><category>pickle</category><category>python</category><category>security</category><guid>https://www.lvh.io/posts/self-compressing-pickles/</guid><pubDate>Thu, 05 Jul 2018 14:59:00 GMT</pubDate></item><item><title>Loud subshells</title><link>https://www.lvh.io/posts/loud-subshells/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;p&gt;Default shells usually end in $. Unless you're root and it's #. That
tradition has been around forever: people recognized the need to highlight
you're not just some random shmoe.&lt;/p&gt;
&lt;p&gt;These days we have lots of snazzy shell magic. You might still su, but you're
more likely to sudo. We still temporarily assume extra privileges. If you have
access to more than one set of systems, like production and staging, you
probably have ways of putting on a particular hat. Some combination of setting
an environment variable, adding a key to ssh-agent, or assuming aws AWS role
with &lt;a href="https://github.com/99designs/aws-vault"&gt;aws-vault&lt;/a&gt;. You know, so you don't
accidentally blow away prod.&lt;/p&gt;
&lt;p&gt;If a privilege is important enough not to have around all the time, it's
important enough to be reminded you have it. You're likely to have more than one
terminal open. You might want to be reminded when your extra privileges are
about to expire. That might be something you just set up for your own
environment. But as your organization grows, you'll want to share that with
others. If you develop software, you might want to make it easy for your users
to get a similarly loud shell.&lt;/p&gt;
&lt;p&gt;Major shells you might care about: POSIX sh, bash, zsh, and &lt;a href="https://fishshell.com/"&gt;fish&lt;/a&gt;. POSIX
sh is a spec, not an implementation. POSIX sh compatibility means it'll probably
work in bash and zsh too. You might run into dash or busybox in a tiny Docker
container image. Both are POSIXy. There's large overlap between all of them but
fish, which is different and proud of it.&lt;/p&gt;
&lt;p&gt;There are lots of ways to configure a shell prompt but PS1 is the default.
Just PS1="xyzzy&amp;gt;" $SHELL doesn't work. You get a new shell, but it will
execute a plethora of configuration files. One of them will set PS1
indiscriminately and so your fancy prompt gets clobbered.&lt;/p&gt;
&lt;p&gt;So what do you do? Major techniques:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;An rc-less shell.&lt;/li&gt;
&lt;li&gt;A dedicated environment variable that your shell's PS1 knows about.&lt;/li&gt;
&lt;li&gt;Sourcing scripts&lt;/li&gt;
&lt;li&gt;Crazy hacks like PROMPT_COMMAND or precmd or reconstituted rcfiles&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;rcless shells&lt;/h2&gt;
&lt;p&gt;If you interpret the problem as shells having configuration, you can disable
that. Unfortunately, the flags for this are different across shells:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;bash uses the --norc flag&lt;/li&gt;
&lt;li&gt;zsh uses the --no-rcs flag&lt;/li&gt;
&lt;li&gt;dash doesn't have a flag but instead reads from ENV&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can't necessarily count on any particular shell being available. The good
news is you don't have to care about fish here: it's uncommon and you've already
committed to giving people a limited shell. So, either count on everyone to have
bash or write something like this:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;SHFLAGS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;
&lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$SHELL&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; in
    *zsh*&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;SHFLAGS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"--no-rcs"&lt;/span&gt; &lt;span class="p"&gt;;;&lt;/span&gt;
    *bash*&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;SHFLAGS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"--norc"&lt;/span&gt; &lt;span class="p"&gt;;;&lt;/span&gt;
&lt;span class="k"&gt;esac&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Eventually, you run $SHELL with PS1 set and you're done. The good news is
that rcless shells will work pretty much anywhere. The bad news is that the
shell customization people are used to is gone: aliases, paths, colors, shell
history et cetera. If people don't love the shell you give them, odds are
they're going to look for a workaround.&lt;/p&gt;
&lt;h2&gt;Dedicated environment variables&lt;/h2&gt;
&lt;p&gt;If you interpret the problem as setting PS1 being fundamentally wrong because
that's the shell configuration's job, you could argue that the shell
configuration should also just set the prompt correctly. Your job is not to set
the prompt, but to give the shell everything it needs to set it for you.&lt;/p&gt;
&lt;p&gt;As an example, aws-vault already conveniently sets an environment variable for
you, so you can do this in your zshrc:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; -n &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;AWS_VAULT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;then&lt;/span&gt;
  &lt;span class="nb"&gt;echo&lt;/span&gt; -e &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;tput setab &lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;In aws-vault env &lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;AWS_VAULT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;tput sgr0&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;
  &lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;PS1&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;tput setab &lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;AWS_VAULT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;tput sgr0&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt; &lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;PS1&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Now, just use aws-vault's exec to run a new shell:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;aws-vault &lt;span class="nb"&gt;exec&lt;/span&gt; work -- &lt;span class="nv"&gt;$SHELL&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;... and you'll get a bright red warning telling you that you have elevated
privileges.&lt;/p&gt;
&lt;p&gt;I use tput here and you should too. Under the hood, it'll produce regular old
ANSI escape codes. $(tput setab 1) sets the background to color 1 (red).
$(tput sgr0) resets to defaults. Three reasons you should use tput instead of
manually entering escape codes:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;It's more legible.&lt;/li&gt;
&lt;li&gt;It's more portable across shells. If you did PS1="${REDBG}shouty${NORMAL}"
   it'll work fine in bash but zsh will escape the escape codes and your
   prompt will have literal slashes and brackets in it. Unless you put a dollar
   sign in front of the double quote, which bash doesn't like.&lt;/li&gt;
&lt;li&gt;It's more portable across terminals.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The downside to this is that it fails open. If nobody changes PS1 you don't
get a fancy prompt. It's a pain to enforce this via MDM.&lt;/p&gt;
&lt;h3&gt;&lt;code&gt;source&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;If you reinterpret the problem as trying to create a subshell at all, you could
try to modify the shell you're in. You can do that simply by calling &lt;em&gt;source
somefile&lt;/em&gt;. This is how Python's virtualenv works.&lt;/p&gt;
&lt;p&gt;The upside is that it's pretty clean, the downside is that it's pretty custom
per shell. If you're careful, odds are you can write it in POSIX sh and cover
sh, bash, zsh in one go, though. Unless you need to support fish. Or eshell or
whatever it is that one person on your team uses.&lt;/p&gt;
&lt;h2&gt;PROMPT_COMMAND&lt;/h2&gt;
&lt;p&gt;Let's say you have no shame and you interpret the problem as shells refusing to
bend to your eternal will. You can get past the above restriction with the
rarely used PROMPT_COMMAND environment variable. &lt;a href="http://tldp.org/HOWTO/Bash-Prompt-HOWTO/x264.html"&gt;Quoth the
docs&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Bash provides an environment variable called PROMPT_COMMAND. The contents of
this variable are executed as a regular Bash command just before Bash displays
a prompt.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Because nobody sets PROMPT_COMMAND you can set it in the environment of a new
shell process and it won't get clobbered like PS1 would. Because it's bash
source, it can do whatever it wants, including setting environment variables
like PS1 and un-setting environment variables like PROMPT_COMMAND itself. You
know, something like:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;PROMPT_COMMAND&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'PS1="${PS1} butwhy&amp;gt;";unset PROMPT_COMMAND'&lt;/span&gt;
&lt;/pre&gt;


&lt;p&gt;Of course, you have now forfeited any pretense of being reasonable. This doesn't
play well with others. Another downside is that this doesn't work in zsh. That
has an equivalent precmd() function but won't grab it from an environment
variable. Which brings us to our final trick:&lt;/p&gt;
&lt;h2&gt;Reconstituted rcfile&lt;/h2&gt;
&lt;p&gt;If you absolutely must, you could technically just cobble together the entire
rcfile, including the parts that the shell would ordinarily source itself. I
don't really want to help you do that, but it'd probably look something like
this:&lt;/p&gt;
&lt;pre class="code literal-block"&gt;&lt;span&gt;&lt;/span&gt;$ zsh --rcs &amp;lt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;"echo why are you like this"&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
why are you like this
&lt;/pre&gt;


&lt;p&gt;Please don't do that. Depending on context, use an rc-less shell or a dedicated
environment variable or source something. Please?&lt;/p&gt;
&lt;p&gt;(This post was syndicated on the Latacora blog.)&lt;/p&gt;&lt;/div&gt;</description><guid>https://www.lvh.io/posts/loud-subshells/</guid><pubDate>Thu, 21 Jun 2018 18:21:00 GMT</pubDate></item><item><title>A child's garden of inter-service authentication schemes</title><link>https://www.lvh.io/posts/a-childs-garden-of-inter-service-authentication-schemes/</link><dc:creator>lvh</dc:creator><description>&lt;div&gt;&lt;p&gt;Modern applications tend to be composed from relationships between smaller applications. Secure modern applications thus need a way to express and enforce security policies that span multiple services. This is the â€œserver-to-serverâ€ (S2S) authentication and authorization problem (for simplicity, Iâ€™ll mash both concepts into the term â€œauthâ€ for most of this post).&lt;/p&gt;
&lt;p&gt;Designers today have a lot of options for S2S auth, but there isnâ€™t much clarity about what the options are or why youâ€™d select any of them. Bad decisions sometimes result. What follows is a stab at clearing the question up.&lt;/p&gt;
&lt;h3&gt;Cast Of Characters&lt;/h3&gt;
&lt;p&gt;Alice and Bob are services on a production VPC. Alice wants to make a request of Bob. How can we design a system that allows this to happen?&lt;/p&gt;
&lt;p&gt;Hereâ€™s, I think, a pretty comprehensive overview of available S2S schemes. Iâ€™ve done my best to describe the â€œwhatâ€™sâ€ and minimize the â€œwhyâ€™sâ€, beyond just explaining the motivation for each scheme. Importantly, these are all things that reasonable teams use for S2S auth.&lt;/p&gt;
&lt;h4&gt;Nothing At All&lt;/h4&gt;
&lt;p&gt;Far and away the most popular S2S scheme is â€œno auth at allâ€. Internet users canâ€™t reach internal services. Thereâ€™s little perceived need to protect a service whose only clients are already trusted.&lt;/p&gt;
&lt;h4&gt;Bearer Token&lt;/h4&gt;
&lt;p&gt;Bearer tokens rule everything around us. Give Alice a small blob of data, such that when Bob sees that data presented, he assumes heâ€™s talking to Alice. Cookies are bearer tokens. Most API keys are bearer tokens. OAuth is an elaborate scheme for generating and relaying bearer tokens. SAML assertions are delivered in bearer tokens.&lt;/p&gt;
&lt;p&gt;The canonical bearer token is a random string, generated from a secure RNG, that is at least 16 bytes long (that is: we generally consider 128 bits a reasonable common security denominator). But part of the point of a bearer token is that the holder doesnâ€™t care what it is, so Aliceâ€™s bearer token could also encode data that Bob could recover. This is common in client-server designs and less common in S2S designs.&lt;/p&gt;
&lt;h5&gt;A few words about passwords&lt;/h5&gt;
&lt;p&gt;S2S passwords are disappointingly common. You see them in a lot of over-the-Internet APIs (ie, for S2S relationships that span companies). A password is basically a bearer token that you can memorize and quickly type. Computers are, in 2018, actually pretty good at memorizing and typing, and so you should use real secrets, rather than passwords, in S2S applications.&lt;/p&gt;
&lt;h4&gt;HMAC(timestamp)&lt;/h4&gt;
&lt;p&gt;The problem with bearer tokens is that anybody who has them can use them. And theyâ€™re routinely transmitted. They could get captured off the wire, or logged by a proxy. This keeps smart ops people up at night, and motivates a lot of â€œinnovationâ€.&lt;/p&gt;
&lt;p&gt;You can keep the simplicity of bearer tokens while avoiding the capture-in-flight problem by exchanging the tokens with secrets, and using the secrets to authenticate a timestamp. A valid HMAC proves ownership of the shared secret without revealing it. Youâ€™d then proceed as with bearer tokens.&lt;/p&gt;
&lt;h5&gt;A few words about TOTP&lt;/h5&gt;
&lt;p&gt;TOTP is basically HMAC(timestamp) stripped down to make it easy for humans to briefly memorize and type. As with passwords, you shouldnâ€™t see TOTP in S2S applications.&lt;/p&gt;
&lt;h5&gt;A few words about PAKEs&lt;/h5&gt;
&lt;p&gt;PAKEs are a sort of inexplicably popular cryptographic construction for securely proving knowledge of a password and, from that proof, deriving an ephemeral shared secret. SRP is a PAKE. People go out of their way to find applications for PAKEs. The thing to understand about them is that theyâ€™re fundamentally a way to extract cryptographic strength from passwords. Since this isnâ€™t a problem computers have, PAKEs donâ€™t make sense for S2S auth.&lt;/p&gt;
&lt;h4&gt;Encrypted Tokens&lt;/h4&gt;
&lt;p&gt;HMAC(timestamp) is stateful; it works because thereâ€™s pairwise knowledge of secrets and the metadata associated with them.  Usually, this is fine. But sometimes itâ€™s hard to get all the parties to share metadata.&lt;/p&gt;
&lt;p&gt;Instead of making that metadata implicit to the protocol, you can store it directly in the credential: include it alongside the timestamp and HMAC or encrypt it. This is how Rails cookie storage works; itâ€™s also the dominant use case for JWTs. AWS-style request â€œsigningâ€ is another example (using HMAC and forgoing encryption).&lt;/p&gt;
&lt;p&gt;By themselves, encrypted tokens make more sense in client-server settings than they do for S2S. Unlike client-server, where a server can just use the same secret for all the clients, S2S tokens still require some kind of pairwise state-keeping.&lt;/p&gt;
&lt;h4&gt;Macaroons&lt;/h4&gt;
&lt;p&gt;You canâ€™t easily design a system where Alice takes her encrypted token, reduces its security scope (for instance, from read-write to read-only), and then passes it to Dave to use on her behalf. No matter how â€œsophisticatedâ€ we make the encoding and transmission mechanisms, encrypted tokens still basically express bearer logic.&lt;/p&gt;
&lt;p&gt;Macaroons are an interesting (and criminally underused) construction that directly provides both &lt;em&gt;delegation&lt;/em&gt; and &lt;em&gt;attenuation&lt;/em&gt;. Theyâ€™re a kind of token from which you can derive more restricted tokens (thatâ€™s the â€œattenuationâ€), and, if you want, pass that token to someone else to use without them being able to exceed the authorization you gave them. Macaroons accomplish this by chaining HMAC; the HMAC of a macaroon is the HMAC secret for its derived attenuated macaroons.&lt;/p&gt;
&lt;p&gt;By adding encryption along with HMAC, Macaroons also express â€œthird-partyâ€ conditions. Alice can get Charles to attest that Alice is a member of the super-awesome-best-friends-club, and include that in the Macaroon she delivers to Bob. If Bob also trusts Charles, Bob can safely learn whether Alice is in the club. Macaroons can flexibly express whole trees of these kinds of relationships, capturing identity, revocation, andâ€¦ actually, revocation and identity are the only two big wins I can think of for this feature.&lt;/p&gt;
&lt;h4&gt;Asymmetric Tokens&lt;/h4&gt;
&lt;p&gt;You can swap the symmetric constructions used in tokens for asymmetric tokens and get some additional properties.&lt;/p&gt;
&lt;p&gt;Using signatures instead of HMACs, you get non-repudiability: Bob can verify Aliceâ€™s token, but canâ€™t necessarily mint a new Alice token himself.&lt;/p&gt;
&lt;p&gt;More importantly, you can eliminate pairwise configuration. Bob and Alice can trust Charles, who doesnâ€™t even need to be online all the time, and from that trust derive mutual authentication.&lt;/p&gt;
&lt;p&gt;The trade-offs for these capabilities are speed and complexity. Asymmetric cryptography is much slower and much more error-prone than symmetric cryptography.&lt;/p&gt;
&lt;h4&gt;Mutual TLS&lt;/h4&gt;
&lt;p&gt;Rather than designing a new asymmetric token format, every service can have a certificate. When Alice connects to Bob, Bob can check a whitelist of valid certificate fingerprints, and whether Aliceâ€™s name on her client certificate is allowed. Or, you could set up a simple CA, and Bob could trust any certificate signed by the CA. Things can get more complex; you might take advantage of X.509 and directly encode claims in certs (beyond just names).&lt;/p&gt;
&lt;h5&gt;A few words about SPIFFE&lt;/h5&gt;
&lt;p&gt;If youâ€™re a Kubernetes person this scheme is also sometimes called SPIFFE.&lt;/p&gt;
&lt;h5&gt;A few words about Tokbind&lt;/h5&gt;
&lt;p&gt;If youâ€™re a participant in the IETF TLS Working Group, you can combine bearer tokens and MTLS using tokbind. Think of tokbind as a sort of â€œTLS cookieâ€. Itâ€™s derived from the client and server certificate and survives multiple TLS connections. You can use a tokbind secret to sign a bearer token, resulting in a bearer token that is confined to a particular MTLS relationship that canâ€™t be used in any other context.&lt;/p&gt;
&lt;h4&gt;Magic Headers&lt;/h4&gt;
&lt;p&gt;Instead of building an explicit application-layer S2S scheme, you can punt the problem to your infrastructure. Ensure all requests are routed through one or more trusted, stateful proxies. Have the proxies set headers on the forwarded requests. Have the services trust the headers.&lt;/p&gt;
&lt;p&gt;This accomplishes the same things a complicated Mutual TLS scheme does without requiring slow, error-prone public-key encryption. The trade-off is that your policy is directly coupled to your network infrastructure.&lt;/p&gt;
&lt;h4&gt;Kerberos&lt;/h4&gt;
&lt;p&gt;You can try to get the benefits of magic headers and encrypted tokens at the same time using something like Kerberos, where thereâ€™s a magic server trusted by all parties, but bound by cryptography rather than network configuration. Services need to be introduced to the Kerberos server, but not to each other; mutual trust of the Kerberos server, and authorization logic that lives on that Kerberos server, resolves all auth questions. Notably, no asymmetric cryptography is needed to make this work.&lt;/p&gt;
&lt;h3&gt;Themes&lt;/h3&gt;
&lt;p&gt;What are the things we might want to achieve from an S2S scheme? Hereâ€™s a list. Itâ€™s incomplete. Understand that itâ€™s probably not reasonable to expect &lt;em&gt;all of these things&lt;/em&gt; from a single scheme.&lt;/p&gt;
&lt;h4&gt;Minimalism&lt;/h4&gt;
&lt;p&gt;This goal is less obvious than it seems. People adopt complicated auth schemes without clear rationales. Itâ€™s easy to lose security by doing this; every feature you add to an application  especially security features  adds attack surface. From an application security perspective, â€œdo the simplest thing you can get away withâ€ has a lot of merit. If you understand and keep careful track of your threat model, â€œnothing at allâ€ can be a security-maximizing option. Certainly, minimalism motivates a lot of bearer token deployments.&lt;/p&gt;
&lt;p&gt;The opposite of minimalism is complexity. A reasonable way to think about the tradeoffs in S2S design is to think of complexity as a currency you have to spend. If you introduce new complexity, what are you getting for it?&lt;/p&gt;
&lt;h4&gt;Claims&lt;/h4&gt;
&lt;p&gt;Authentication and authorization are two different things: who are you, and what are you allowed to do? Of the two problems, authorization is the harder one. An auth scheme can handle authorization, or assist authorization, or punt on it altogether.&lt;/p&gt;
&lt;p&gt;Opaque bearer token schemes usually just convey identity. An encrypted token, on the other hand, might bind &lt;em&gt;claims&lt;/em&gt;: statements that limit the scope of what the token enables, or metadata about the identity of the requestor.&lt;/p&gt;
&lt;p&gt;Schemes that donâ€™t bind claims can make sense if authorization logic between services is straightforward, or if thereâ€™s already a trusted system (for instance, a service discovery layer) that expresses authorization. Schemes that do bind claims can be problematic if the claims carried in an credential can be abused, or targeted by application flaws. On the other hand, an S2S scheme that supports claims can do useful things like propagating on-behalf-of requestor identities or supporting distributed tracing.&lt;/p&gt;
&lt;h4&gt;Confinement&lt;/h4&gt;
&lt;p&gt;The big problem with HTTP cookies is that once theyâ€™ve captured one, an attacker can abuse it however they see fit. You can do better than that by adding mitigations or caveats to credentials. They might be valid only for a short period of time, or valid only for a specific IP address (especially powerful when combined with short expiry),  or, as in the case of Tokbind, valid only on a particular MTLS relationship.&lt;/p&gt;
&lt;h4&gt;Statelessness&lt;/h4&gt;
&lt;p&gt;Statelessness means Bob doesnâ€™t have to remember much (or, ideally, anything) about Alice. This is an immensely popular motivator for some S2S schemes. Itâ€™s perceived as eliminating a potential performance bottleneck, and as simplifying deployment.&lt;/p&gt;
&lt;p&gt;The tricky thing about statelessness is that it often doesnâ€™t make sense to minimize state, only to eliminate it. If pairwise statefulness creeps back into the application for some other reason (for instance, Bob has to remember anything at all about Alice), stateless S2S auth can spend a lot of complexity for no real gain.&lt;/p&gt;
&lt;h4&gt;Pairwise Configuration&lt;/h4&gt;
&lt;p&gt;Pairwise configuration is the bÃªte noire of S2S operational requirements. An application secret that has to be generated once for each of several peers and that &lt;em&gt;anybody might ever store in code&lt;/em&gt; is part of a scheme in which secrets are never, ever rotated. In a relatively common set of circumstances, pairwise config means that new services can only be introduced during maintenance windows.&lt;/p&gt;
&lt;p&gt;Still, if you have a relatively small and stable set of services (or if all instances of a particular service might simply share a credential), it can make sense to move complexity out of the application design and into the operational requirements.  Also it makes sense if you have an ops team and you never have to drink with them.&lt;/p&gt;
&lt;p&gt;I kid, really, because if you can get away with it, not spending complexity to eliminate pairwise configuration can make sense. Also, many of the ways S2S schemes manage to eliminate pairwise configurations involve &lt;em&gt;introducing yet another service&lt;/em&gt;, which has a sort of constant factor cost that can swamp the variable cost.&lt;/p&gt;
&lt;h4&gt;Delegation and Attenuation&lt;/h4&gt;
&lt;p&gt;People deploy a lot of pointless delegation. Application providers might use OAuth for their client-server login, for instance, even though no third-party applications exist.  The flip side of this is that if you actually need delegation, you really want to have it expressed carefully in your protocol. The thing you donâ€™t want to do is ever share a bearer token.&lt;/p&gt;
&lt;p&gt;Delegation can show up in internal S2S designs as a building block. For instance, a Macaroon design might have a central identity issuance server that grants all-powerful tokens to systems that in turn filter them for specific requestors.&lt;/p&gt;
&lt;p&gt;Some delegation schemes have implied or out-of-band attenuation. For instance, you might not be able to look at an OAuth token and know what itâ€™s restrictions are. These systems are rough in practice; from an operational security perspective, your starting point probably needs to be that any lost token is game-over for its owner.&lt;/p&gt;
&lt;p&gt;A problem with writing about attenuation is that Macaroons express it so well that itâ€™s hard to write about its value without lapsing into the case for Macaroons.&lt;/p&gt;
&lt;h4&gt;Flexibility&lt;/h4&gt;
&lt;p&gt;If use JSON as your credential format, and you later build a feature that allows a credential to express not just Aliceâ€™s name but also whether sheâ€™s an admin, you can add that feature without changing the credential format. Later, attackers can add the feature where they turn any user into an admin, and you can then add the feature that breaks that attack. JSON is just features all the way down.&lt;/p&gt;
&lt;p&gt;Iâ€™m only mostly serious. If youâ€™re doing something more complicated than a bearer token, youâ€™re going to choose an extensible mechanism. If not, I already made the case for minimalism.&lt;/p&gt;
&lt;h4&gt;Coupling&lt;/h4&gt;
&lt;p&gt;All things being equal, coupling is bad. If your S2S scheme is expressed by network controls and unprotected headers, itâ€™s tightly coupled to the network deployment, which canâ€™t change without updating the security scheme. But if your network configuration doesnâ€™t change often, that limitation might save you a lot of complexity.&lt;/p&gt;
&lt;h4&gt;Revocation&lt;/h4&gt;
&lt;p&gt;People talk about this problem a lot. Stateless schemes have revocation problems: the whole point of a stateless scheme is for Bob not to have to remember anything about Alice (other than perhaps some configuration that says Alice is allowed to make requests, but not Dave, and this gets complicated really quickly and can quickly call into question the value of statelessness but letâ€™s not go there). At any rate: a stateless bearer token will eventually be compromised, and you canâ€™t just let it get used over and over again to steal data.&lt;/p&gt;
&lt;p&gt;The two mainstream answers to this problem are short expiry and revocation lists.&lt;/p&gt;
&lt;p&gt;Short expiry addresses revocation if: (a) you have a dedicated auth server and the channel to that server is somehow more secure than the channel between Alice and Bob.; (b) the auth server relies on a long-lived secret that never appears on the less-secure channel, and (c) issues an access secret that is transmitted on the less-secure channel, but lives only for a few minutes. These schemes are called â€œrefresh tokensâ€. Refresh tends to find its way into a lot of designs where this fact pattern doesnâ€™t hold. Security design is full of wooden headphones and coconut phones.&lt;/p&gt;
&lt;p&gt;Revocation lists (and, usually, some attendant revocation service) are a sort of all-purpose solution to this problem; you just blacklist revoked tokens, for at least as long as the lifetime of the token. This obviously introduces state, but itâ€™s a specific kind of state that doesnâ€™t (you hope) grow as quickly as your service does. If itâ€™s the only state you have to keep, itâ€™s nice to have the flexibility of putting it wherever you want.&lt;/p&gt;
&lt;h4&gt;Rigidity&lt;/h4&gt;
&lt;p&gt;It is hard to screw up a random bearer token. Alice stores the token and supply it on requests. Bob uses the token to look up an entry in a database. There arenâ€™t a lot of questions.&lt;/p&gt;
&lt;p&gt;It is extraordinarily easy to screw up JWT. JWT is a JSON format where you have to parse and interpret a JSON document to figure out how to decrypt and authenticate a JSON document. It has revived bugs we thought long dead, like â€œrepurposing asymmetric public keys as symmetric private keysâ€.&lt;/p&gt;
&lt;p&gt;Problems with rigidity creep up a lot in distributed security. The first draft of this post said that MTLS was rigid; youâ€™re either speaking TLS with a client cert or youâ€™re not. But that ignores how hard X.509 validation is. If youâ€™re not careful, an attacker can just ask Comodo for a free email certificate and use it to access your services. Worse still, MTLS can â€œfail openâ€ in a way that TLS sort of doesnâ€™t: if a service forgets to check for client certificates, TLS will still get negotiated, and you might not notice until an attacker does.&lt;/p&gt;
&lt;p&gt;Long story short: bearer tokens are rigid. JWT is a kind of evil pudding. Donâ€™t use JWT.&lt;/p&gt;
&lt;h4&gt;Universality&lt;/h4&gt;
&lt;p&gt;A nice attribute of widely deployed MTLS is that it can mitigate SSRF bugs (the very bad bug where an attacker coerces one of your service to make an arbitrary HTTP request, probably targeting your internal services, on their behalf). If the normal HTTP-request-generating code doesnâ€™t add a client certificate, and every internal service needs to see one to honor a request, youâ€™ve limited the SSRF attackers options a lot.&lt;/p&gt;
&lt;p&gt;On the other hand, we forget that a lot of our internal services consist of code that we didnâ€™t write. The best example of this is Redis, which for years proudly waved the banner of â€œif you can talk to it, you already own the whole applicationâ€.&lt;/p&gt;
&lt;p&gt;Itâ€™s helpful if we can reasonably expect an auth control to span all the systems we use, from Postgres to our custom revocation server. That might be a realistic goal with Kerberos, or with network controls and magic headers; with tunnels or proxies, itâ€™s even something you can do with MTLS  this is a reason MTLS is such a big deal for Kubernetes, where itâ€™s reasonable for the infrastructure to provide every container with an MTLS-enabled Envoy proxy.  On the other hand itâ€™s unlikely to be something you can achieve with Macaroons or evil puddings.&lt;/p&gt;
&lt;h4&gt;Performance and Complexity&lt;/h4&gt;
&lt;p&gt;If you want performance and simplicity, you probably avoid asymmetric crypto, unless your request frequency is (and will remain) quite low. Similarly, youâ€™d probably want to avoid dedicated auth servers, especially if Bob needs to be in constant contact with them for Alice to make requests to him; this is a reason people tend to migrate away from Kerberos.&lt;/p&gt;
&lt;h3&gt;Our Thoughts&lt;/h3&gt;
&lt;p&gt;Do the simplest thing that makes sense for your application right now. A true fact we can relate from something like a decade of consulting work on these problems: intricate S2S auth schemes are not the norm; if thereâ€™s a norm, itâ€™s â€œnothing at all except for ELBsâ€.  If you need something, but you have to ask whether that something oughtnâ€™t just be bearer tokens, then just use bearer tokens.&lt;/p&gt;
&lt;p&gt;Unfortunately, if thereâ€™s a second norm, itâ€™s adopting complicated auth mechanisms independently or, worse, in combination, and then succumbing to vulnerabilities.&lt;/p&gt;
&lt;p&gt;Macaroons are inexplicably underused. Theyâ€™re the Velvet Underground of authentication mechanisms, hugely influential but with little radio airplay. Unlike the Velvets, Macaroons arenâ€™t overrated. They work well for client-server auth and for s2s auth. Theyâ€™re very flexible but have reassuring format rigidity, and they elegantly take advantage of just a couple simple crypto operations. There are libraries for all the mainstream languages. You will have a hard time coming up with a scenario where weâ€™d try to talk you out of using them.&lt;/p&gt;
&lt;p&gt;JWT is a standard that tries to do too much and ends up doing everything haphazardly.  Our loathing of JWT motivated this post, but this post isnâ€™t about JWT; weâ€™ll write more about it in the future.&lt;/p&gt;
&lt;p&gt;If your inter-service auth problem really decomposes to inter-container (or, without containers, inter-instance) auth, MTLS starts to make sense. The container-container MTLS story usually involves containers including a proxy, like Envoy, that mediates access. If youâ€™re not connecting containers, or have ad-hoc components, MTLS can really start to take on a CORBA feel: random sidecar processes (here stunnel, there Envoy, and this one app that tries to do everything itself). It can be a pain to configure properly, and this is a place you need to get configurations right.&lt;/p&gt;
&lt;p&gt;If you can do MTLS in such a way that there is exactly one way all your applications use it (probably: a single proxy that all your applications install), consider MTLS. Otherwise, be cautious about it.&lt;/p&gt;
&lt;p&gt;Beyond that, we donâ€™t want to be too much more prescriptive. Rather, weâ€™d just urge you to think about what youâ€™re actually getting from an S2S auth scheme before adopting it.&lt;/p&gt;
&lt;p&gt;(But really, you should just use Macaroons.)&lt;/p&gt;
&lt;p&gt;(This post was syndicated on the Latacora blog.)&lt;/p&gt;&lt;/div&gt;</description><category>cryptography</category><category>security</category><guid>https://www.lvh.io/posts/a-childs-garden-of-inter-service-authentication-schemes/</guid><pubDate>Tue, 12 Jun 2018 22:27:00 GMT</pubDate></item></channel></rss>