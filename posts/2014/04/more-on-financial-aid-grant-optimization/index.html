<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>More on financial aid grant optimization | lvh</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#383234">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../rss.xml">
<link rel="canonical" href="https://www.lvh.io/posts/2014/04/more-on-financial-aid-grant-optimization/">
<!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="lvh">
<link rel="prev" href="../../03/optimal-hotel-room-pairing/" title="Optimal hotel room pairing" type="text/html">
<link rel="next" href="../../05/truecrypt-and-full-disk-encryption/" title="TrueCrypt and full-disk encryption" type="text/html">
<meta property="og:site_name" content="lvh">
<meta property="og:title" content="More on financial aid grant optimization">
<meta property="og:url" content="https://www.lvh.io/posts/2014/04/more-on-financial-aid-grant-optimization/">
<meta property="og:description" content="In a previous post, I talked about ways to optimize PyCon
financial aid grants. This is a follow-up on those efforts. Quick
recap:

There is a fixed budget \(b\) available for grants, between 100k
  a">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2014-04-06T20:34:00-07:00">
<meta property="article:tag" content="pycon">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="https://www.lvh.io/">
            <img src="../../../../pinchy.svg" alt="lvh" id="logo" class="d-inline-block align-top"><span id="blog-title">lvh</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../../../about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="../../../../archive/" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../../../tags/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../../../talks/" class="nav-link">Talks</a>
                </li>
<li class="nav-item">
<a href="../../../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<!-- Custom search --><form method="get" id="search" action="//duckduckgo.com/" class="navbar-form pull-right">
<input type="hidden" name="sites" value="https://www.lvh.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Searchâ€¦" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="display: none;">
</form>
<!-- End of custom search -->


            <ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">More on financial aid grant optimization</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    lvh
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2014-04-06T20:34:00-07:00" itemprop="datePublished" title="2014-04-06 20:34">2014-04-06 20:34</time></a>
            </p>
            
        <p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>In <a href="http://www.lvh.io/blog/2014/03/10/optimization-problems-and-pycon-financial-aid/">a previous post</a>, I talked about ways to optimize PyCon
financial aid grants. This is a follow-up on those efforts. Quick
recap:</p>
<ul>
<li>There is a fixed budget \(b\) available for grants, between 100k
  and 200k USD.</li>
<li>There are a number of people (approximately 300) requesting various
  amounts \(r_i\) (approximately between 100 USD and 2000 USD) of
  financial aid, and receive a grant \(g_i\) so that \(0 \le g_i
  \le r_i\).</li>
<li>Financial aid applicants can be assigned scores \(s_i\), a
  relative value describing how much we'd like to have them at PyCon.</li>
<li>PyCon wants to optimize the total expected value of scores. That
  means getting as many people as possible to come, weighted by score.</li>
<li>We've conjectured that we can estimate the probability \(p_i\)
  that someone attends as either \(g_i/r_i\), or \((g_i/r_i)^2\).
  The former prefers to spread the budget across a larger number of
  smaller grants, whereas the latter prefers to focus the budget into
  a smaller number of larger grants.</li>
</ul>
<p>If any of that doesn't make sense, you should read
<a href="http://www.lvh.io/blog/2014/03/10/optimization-problems-and-pycon-financial-aid/">the previous blog post</a> for more details.</p>
<p>In short, we're trying to solve the optimization problem:</p>
<p>$$\max \sum E[S_i] = \sum s_i \cdot p_i$$</p>
<p>Since most optimization texts appear to prefer minimization,
alternatively:</p>
<p>$$\min - \sum s_i \cdot p_i$$</p>
<p>Subject to a budget constraint and an individual grant constraint:</p>
<p>$$\sum g_i \le b$$</p>
<p>$$0 \le g_i \le r_i$$</p>
<p>The greater-than-zero constraint for individual grants is fairly
important, otherwise the algorithm might casually give you answers
like:</p>
<pre class="code literal-block"><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">.</span>  <span class="mi">20</span><span class="p">.</span> <span class="o">-</span><span class="mi">20</span><span class="p">.</span>  <span class="mi">30</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.],</span> <span class="k">sum</span><span class="p">:</span> <span class="mi">150</span><span class="p">.</span><span class="mi">0</span>
</pre>


<p>That list in the middle are the per-person grants. Notice how the
algorithm feels that the third person really ought to pony up some
cash so that some of the other people can go to PyCon ;-)</p>
<h3>Squared problems</h3>
<p>In the <a href="http://www.lvh.io/blog/2014/03/10/optimization-problems-and-pycon-financial-aid/">previous blog post</a> I ran into issues using a very
generic constraint solver. I ended that post saying that I would try
to remeedy that by applying a more specific solver that takes
advantage of a particular structure of the problem.</p>
<p>When you set \(p_i = g_i/r_i\), this turns into a linear programming
problem, since \(r_i\) is a constant. When you set \(p_i =
\left(g_i/r_i\right)^2\), it turns into a quadratic programming
problem. Turns out there's two things I missed about the quadratic
problem:</p>
<ul>
<li>The resulting problem is not convex. That means it's (probably)
  difficult to solve.</li>
<li>The estimated probability that someone will attend falls off sharply
  as soon as they don't receive the full amount they requested. At 50%
  of the requested grant, the estimated probability of attending is
  only 25%; at 90%, it's 81%. This is the opposite of what we want.</li>
</ul>
<h3>Fixing the model</h3>
<p>That doesn't mean we should put the \((g_i/r_i)^k\) out to pasture:
it just means that I didn't pick the \(k\) I really wanted.
Specifically, if I were to pick \(k=1/2\), I'd get:</p>
<p>$$p_i = \left(\frac{g_i}{r_i}\right)^{1/2} = \sqrt{\frac{g_i}{r_i}}$$</p>
<p>In general, if  \(k = 1/n\):</p>
<p>$$p_i = \left(\frac{g_i}{r_i}\right)^{1/n} = \sqrt[n]{\frac{g_i}{r_i}}$$</p>
<p>That problem <em>is</em> convex, but it isn't linear, quadratic, or some
other easy specific problem. It's just constrained multivariate convex
optimization. That's okay, there are still a couple of applicable
optimization algorithms.</p>
<p>Some of these algorithms require the derivative of the goal function
with respect to a particular grant size \(g_j\) at a particular
point. In case we don't have the real derivative, we can still provide
a numerical approximation. In our case, we don't really need to
approximate, since the derivatives are fairly easy to compute
analytically:</p>
<p>$$\frac{\partial}{\partial g_j} \sum_i s_i \cdot
\sqrt[n]{\frac{g_i}{r_i}} = \frac{s_j \cdot {g_j}^{\frac{1}{n} -
1}}{\sqrt[n]{r_j} \cdot n}$$</p>
<h3>Finding a solution with Python</h3>
<p>There are a few Python packages that contain optimization algorithms:</p>
<ul>
<li>SciPy</li>
<li>cvxopt</li>
<li>pyopt</li>
</ul>
<p>Someone originally pointed me towards cvxopt. While I'm sure it's
excellent software, I already knew SciPy, so I went with that.</p>
<p>SciPy's optimization module provides the following algorithms:</p>
<ul>
<li>
<code>fmin_l_bfgs_b</code> - Zhu, Byrd, and Nocedal's constrained optimizer</li>
<li>
<code>fmin_tnc</code> - Truncated Newton code</li>
<li>
<code>fmin_cobyla</code> - Constrained optimization by linear approximation</li>
<li>
<code>fmin_slsqp</code> - Minimization using sequential least-squares programming</li>
<li>
<code>nnls</code> - Linear least-squares problem with non-negativity constraint</li>
</ul>
<p>The first two are not applicable because they only appear to support
bounds on individual variables. I also need a constraint over the
<em>sum</em> of variables for the budget:  \(\sum g_i \le b\). The last one
isn't applicable because this isn't a linear least-squares problem.
That leaves <code>cobyla</code> and <code>slsqp</code>.</p>
<h3>Experimenting with linear approximation (COBYLA)</h3>
<p>Making COBYLA work ended up being pretty easy. The only non-trivial
part is expressing all your constraints as expressions greater than or
equal to zero.</p>
<p>I've uploaded my IPython notebook
(<a href="http://nbviewer.ipython.org/gist/lvh/10107818">viewer</a>,
<a href="https://gist.github.com/lvh/10107818">gist</a>).</p>
<p>This produced the following results:</p>
<pre class="code literal-block"><span></span><span class="n">scores</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">5</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">requested</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span> <span class="mi">20</span> <span class="mi">30</span> <span class="mi">30</span> <span class="mi">50</span> <span class="mi">10</span> <span class="mi">50</span><span class="p">]</span> <span class="n">total</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="n">budget</span><span class="p">:</span> <span class="mi">150</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">.</span>  <span class="mi">20</span><span class="p">.</span>  <span class="mi">30</span><span class="p">.</span>  <span class="mi">30</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>   <span class="mi">0</span><span class="p">.],</span> <span class="k">sum</span><span class="p">:</span> <span class="mi">150</span><span class="p">.</span><span class="mi">0</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">.</span>  <span class="o">-</span><span class="mi">0</span><span class="p">.</span>   <span class="mi">0</span><span class="p">.</span>  <span class="mi">30</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.],</span> <span class="k">sum</span><span class="p">:</span> <span class="mi">150</span><span class="p">.</span><span class="mi">0</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>   <span class="mi">7</span><span class="p">.</span>  <span class="mi">27</span><span class="p">.</span>  <span class="mi">36</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.],</span> <span class="k">sum</span><span class="p">:</span> <span class="mi">150</span><span class="p">.</span><span class="mi">0</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">.</span>  <span class="mi">11</span><span class="p">.</span>   <span class="mi">9</span><span class="p">.</span>  <span class="mi">25</span><span class="p">.</span>  <span class="mi">35</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.],</span> <span class="k">sum</span><span class="p">:</span> <span class="mi">150</span><span class="p">.</span><span class="mi">0</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">.</span>  <span class="mi">11</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>  <span class="mi">24</span><span class="p">.</span>  <span class="mi">35</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.],</span> <span class="k">sum</span><span class="p">:</span> <span class="mi">150</span><span class="p">.</span><span class="mi">0</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">10</span><span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">.</span>  <span class="mi">11</span><span class="p">.</span>  <span class="mi">11</span><span class="p">.</span>  <span class="mi">23</span><span class="p">.</span>  <span class="mi">35</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.],</span> <span class="k">sum</span><span class="p">:</span> <span class="mi">150</span><span class="p">.</span><span class="mi">0</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">100</span><span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">.</span>  <span class="mi">11</span><span class="p">.</span>  <span class="mi">11</span><span class="p">.</span>  <span class="mi">23</span><span class="p">.</span>  <span class="mi">34</span><span class="p">.</span>  <span class="mi">10</span><span class="p">.</span>  <span class="mi">50</span><span class="p">.],</span> <span class="k">sum</span><span class="p">:</span> <span class="mi">150</span><span class="p">.</span><span class="mi">0</span>
</pre>


<p>Some takeaways:</p>
<ul>
<li>As predicted, as \(1/k\) increases, the optimization gradually
  starts spreading the budget out more evenly; preferring to give many
  partial grants rather than a few large ones.</li>
<li>This effect is mostly only pronounced for \(1/k = 2, 3\); after
  that, increasing \(1/k\) doesn't make much of a difference
  anymore. This is what I'd expect when I visualize the \(p_i\)
  functions in my head, but I haven't ruled out numerical instability.</li>
<li>Even at high \(1/k\), the two high scorers get their full grant
  amount. That's quite understandable for the one that's only asking
  for 10, but even the one asking for a large grant gets it
  unconditionally. This probably means that tweaking the scoring
  functions is going to be very important.</li>
<li>The linear version is apparently already quite brutal: the person
  with score 3 requesting 50 simply gets it entirely, leaving no
  budget left over for the people with score 1.</li>
</ul>
<p>Since I'm so pleased with these results, I'm skipping <code>slsqp</code> until I
feel like it. Next up, I'll try to compare the COBYLA results above
with the results of the greedy algorithm under various fitness
metrics.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../tags/pycon/" rel="tag">pycon</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../../03/optimal-hotel-room-pairing/" rel="prev" title="Optimal hotel room pairing">Previous post</a>
            </li>
            <li class="next">
                <a href="../../05/truecrypt-and-full-disk-encryption/" rel="next" title="TrueCrypt and full-disk encryption">Next post</a>
            </li>
        </ul></nav></aside><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-SDRP1VVYu+tgAGKhddBSl5+ezofHKZeI+OzxakbIe/Y=" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']]}});
        </script></article><!--End of body content--><footer id="footer">
            Contents Â© 2019         <a href="mailto:_@lvh.io">lvh</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


        <script src="../../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36779422-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
