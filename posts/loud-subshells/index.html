<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Loud subshells | lvh</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#383234">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://www.lvh.io/posts/loud-subshells/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="lvh">
<link rel="prev" href="../a-childs-garden-of-inter-service-authentication-schemes/" title="A child's garden of inter-service authentication schemes" type="text/html">
<link rel="next" href="../self-compressing-pickles/" title="Self-compressing pickles" type="text/html">
<meta property="og:site_name" content="lvh">
<meta property="og:title" content="Loud subshells">
<meta property="og:url" content="https://www.lvh.io/posts/loud-subshells/">
<meta property="og:description" content="Default shells usually end in $. Unless you're root and it's #. That
tradition has been around forever: people recognized the need to highlight
you're not just some random shmoe.
These days we have lo">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-06-21T11:21:00-07:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="https://www.lvh.io/">
            <img src="../../pinchy.svg" alt="lvh" id="logo" class="d-inline-block align-top"><span id="blog-title">lvh</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="../../archive/" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../tags/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../talks/" class="nav-link">Talks</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<!-- Custom search --><form method="get" id="search" action="//duckduckgo.com/" class="navbar-form pull-right">
<input type="hidden" name="sites" value="https://www.lvh.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="display: none;">
</form>
<!-- End of custom search -->


            <ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Loud subshells</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    lvh
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2018-06-21T11:21:00-07:00" itemprop="datePublished" title="2018-06-21 11:21">2018-06-21 11:21</time></a>
            </p>
            
        <p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>Default shells usually end in $. Unless you're root and it's #. That
tradition has been around forever: people recognized the need to highlight
you're not just some random shmoe.</p>
<p>These days we have lots of snazzy shell magic. You might still su, but you're
more likely to sudo. We still temporarily assume extra privileges. If you have
access to more than one set of systems, like production and staging, you
probably have ways of putting on a particular hat. Some combination of setting
an environment variable, adding a key to ssh-agent, or assuming aws AWS role
with <a href="https://github.com/99designs/aws-vault">aws-vault</a>. You know, so you don't
accidentally blow away prod.</p>
<p>If a privilege is important enough not to have around all the time, it's
important enough to be reminded you have it. You're likely to have more than one
terminal open. You might want to be reminded when your extra privileges are
about to expire. That might be something you just set up for your own
environment. But as your organization grows, you'll want to share that with
others. If you develop software, you might want to make it easy for your users
to get a similarly loud shell.</p>
<p>Major shells you might care about: POSIX sh, bash, zsh, and <a href="https://fishshell.com/">fish</a>. POSIX
sh is a spec, not an implementation. POSIX sh compatibility means it'll probably
work in bash and zsh too. You might run into dash or busybox in a tiny Docker
container image. Both are POSIXy. There's large overlap between all of them but
fish, which is different and proud of it.</p>
<p>There are lots of ways to configure a shell prompt but PS1 is the default.
Just PS1="xyzzy&gt;" $SHELL doesn't work. You get a new shell, but it will
execute a plethora of configuration files. One of them will set PS1
indiscriminately and so your fancy prompt gets clobbered.</p>
<p>So what do you do? Major techniques:</p>
<ul>
<li>An rc-less shell.</li>
<li>A dedicated environment variable that your shell's PS1 knows about.</li>
<li>Sourcing scripts</li>
<li>Crazy hacks like PROMPT_COMMAND or precmd or reconstituted rcfiles</li>
</ul>
<h2>rcless shells</h2>
<p>If you interpret the problem as shells having configuration, you can disable
that. Unfortunately, the flags for this are different across shells:</p>
<ul>
<li>bash uses the --norc flag</li>
<li>zsh uses the --no-rcs flag</li>
<li>dash doesn't have a flag but instead reads from ENV</li>
</ul>
<p>You can't necessarily count on any particular shell being available. The good
news is you don't have to care about fish here: it's uncommon and you've already
committed to giving people a limited shell. So, either count on everyone to have
bash or write something like this:</p>
<pre class="code literal-block"><span></span><span class="nv">SHFLAGS</span><span class="o">=</span><span class="s2">""</span>
<span class="k">case</span> <span class="s2">"</span><span class="nv">$SHELL</span><span class="s2">"</span> in
    *zsh*<span class="o">)</span> <span class="nv">SHFLAGS</span><span class="o">=</span><span class="s2">"--no-rcs"</span> <span class="p">;;</span>
    *bash*<span class="o">)</span> <span class="nv">SHFLAGS</span><span class="o">=</span><span class="s2">"--norc"</span> <span class="p">;;</span>
<span class="k">esac</span>
</pre>


<p>Eventually, you run $SHELL with PS1 set and you're done. The good news is
that rcless shells will work pretty much anywhere. The bad news is that the
shell customization people are used to is gone: aliases, paths, colors, shell
history et cetera. If people don't love the shell you give them, odds are
they're going to look for a workaround.</p>
<h2>Dedicated environment variables</h2>
<p>If you interpret the problem as setting PS1 being fundamentally wrong because
that's the shell configuration's job, you could argue that the shell
configuration should also just set the prompt correctly. Your job is not to set
the prompt, but to give the shell everything it needs to set it for you.</p>
<p>As an example, aws-vault already conveniently sets an environment variable for
you, so you can do this in your zshrc:</p>
<pre class="code literal-block"><span></span><span class="k">if</span> <span class="o">[</span> -n <span class="s2">"</span><span class="si">${</span><span class="nv">AWS_VAULT</span><span class="si">}</span><span class="s2">"</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> -e <span class="s2">"</span><span class="k">$(</span>tput setab <span class="m">1</span><span class="k">)</span><span class="s2">In aws-vault env </span><span class="si">${</span><span class="nv">AWS_VAULT</span><span class="si">}</span><span class="k">$(</span>tput sgr0<span class="k">)</span><span class="s2">"</span>
  <span class="nb">export</span> <span class="nv">PS1</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span>tput setab <span class="m">1</span><span class="k">)</span><span class="s2">&lt;&lt;</span><span class="si">${</span><span class="nv">AWS_VAULT</span><span class="si">}</span><span class="s2">&gt;&gt;</span><span class="k">$(</span>tput sgr0<span class="k">)</span><span class="s2"> </span><span class="si">${</span><span class="nv">PS1</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
<span class="k">fi</span><span class="p">;</span>
</pre>


<p>Now, just use aws-vault's exec to run a new shell:</p>
<pre class="code literal-block"><span></span>aws-vault <span class="nb">exec</span> work -- <span class="nv">$SHELL</span>
</pre>


<p>... and you'll get a bright red warning telling you that you have elevated
privileges.</p>
<p>I use tput here and you should too. Under the hood, it'll produce regular old
ANSI escape codes. $(tput setab 1) sets the background to color 1 (red).
$(tput sgr0) resets to defaults. Three reasons you should use tput instead of
manually entering escape codes:</p>
<ol>
<li>It's more legible.</li>
<li>It's more portable across shells. If you did PS1="${REDBG}shouty${NORMAL}"
   it'll work fine in bash but zsh will escape the escape codes and your
   prompt will have literal slashes and brackets in it. Unless you put a dollar
   sign in front of the double quote, which bash doesn't like.</li>
<li>It's more portable across terminals.</li>
</ol>
<p>The downside to this is that it fails open. If nobody changes PS1 you don't
get a fancy prompt. It's a pain to enforce this via MDM.</p>
<h3><code>source</code></h3>
<p>If you reinterpret the problem as trying to create a subshell at all, you could
try to modify the shell you're in. You can do that simply by calling <em>source
somefile</em>. This is how Python's virtualenv works.</p>
<p>The upside is that it's pretty clean, the downside is that it's pretty custom
per shell. If you're careful, odds are you can write it in POSIX sh and cover
sh, bash, zsh in one go, though. Unless you need to support fish. Or eshell or
whatever it is that one person on your team uses.</p>
<h2>PROMPT_COMMAND</h2>
<p>Let's say you have no shame and you interpret the problem as shells refusing to
bend to your eternal will. You can get past the above restriction with the
rarely used PROMPT_COMMAND environment variable. <a href="http://tldp.org/HOWTO/Bash-Prompt-HOWTO/x264.html">Quoth the
docs</a>:</p>
<blockquote>
<p>Bash provides an environment variable called PROMPT_COMMAND. The contents of
this variable are executed as a regular Bash command just before Bash displays
a prompt.</p>
</blockquote>
<p>Because nobody sets PROMPT_COMMAND you can set it in the environment of a new
shell process and it won't get clobbered like PS1 would. Because it's bash
source, it can do whatever it wants, including setting environment variables
like PS1 and un-setting environment variables like PROMPT_COMMAND itself. You
know, something like:</p>
<pre class="code literal-block"><span></span><span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s1">'PS1="${PS1} butwhy&gt;";unset PROMPT_COMMAND'</span>
</pre>


<p>Of course, you have now forfeited any pretense of being reasonable. This doesn't
play well with others. Another downside is that this doesn't work in zsh. That
has an equivalent precmd() function but won't grab it from an environment
variable. Which brings us to our final trick:</p>
<h2>Reconstituted rcfile</h2>
<p>If you absolutely must, you could technically just cobble together the entire
rcfile, including the parts that the shell would ordinarily source itself. I
don't really want to help you do that, but it'd probably look something like
this:</p>
<pre class="code literal-block"><span></span>$ zsh --rcs &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s2">"echo why are you like this"</span><span class="o">)</span>
why are you like this
</pre>


<p>Please don't do that. Depending on context, use an rc-less shell or a dedicated
environment variable or source something. Please?</p>
<p>(This post was syndicated on the Latacora blog.)</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../a-childs-garden-of-inter-service-authentication-schemes/" rel="prev" title="A child's garden of inter-service authentication schemes">Previous post</a>
            </li>
            <li class="next">
                <a href="../self-compressing-pickles/" rel="next" title="Self-compressing pickles">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2019         <a href="mailto:_@lvh.io">lvh</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36779422-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
