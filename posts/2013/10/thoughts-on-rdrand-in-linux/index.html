<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Thoughts on RDRAND in Linux | lvh</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#383234">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../rss.xml">
<link rel="canonical" href="https://www.lvh.io/posts/2013/10/thoughts-on-rdrand-in-linux/">
<!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="lvh">
<link rel="prev" href="../../01/securing-against-timing-attacks-with-twisted/" title="Securing against timing attacks with Twisted" type="text/html">
<link rel="next" href="../../11/using-protractor-with-angularjs-and-yeoman/" title="Using protractor with AngularJS and Yeoman" type="text/html">
<meta property="og:site_name" content="lvh">
<meta property="og:title" content="Thoughts on RDRAND in Linux">
<meta property="og:url" content="https://www.lvh.io/posts/2013/10/thoughts-on-rdrand-in-linux/">
<meta property="og:description" content="This is a response to Linus' response to the petition to remove RDRAND from
/dev/random. RDRAND is a CPU instruction introduced by Intel on recent
CPUs. It (supposedly) uses a hardware entropy source,">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2013-10-19T21:47:00-07:00">
<meta property="article:tag" content="cryptography">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="https://www.lvh.io/">
            <img src="../../../../pinchy.svg" alt="lvh" id="logo" class="d-inline-block align-top"><span id="blog-title">lvh</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../../../about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="../../../../archive/" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../../../tags/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../../../talks/" class="nav-link">Talks</a>
                </li>
<li class="nav-item">
<a href="../../../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<!-- Custom search --><form method="get" id="search" action="//duckduckgo.com/" class="navbar-form pull-right">
<input type="hidden" name="sites" value="https://www.lvh.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="display: none;">
</form>
<!-- End of custom search -->


            <ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Thoughts on RDRAND in Linux</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    lvh
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2013-10-19T21:47:00-07:00" itemprop="datePublished" title="2013-10-19 21:47">2013-10-19 21:47</time></a>
            </p>
            
        <p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>This is a response to <a href="https://www.change.org/en-GB/petitions/linus-torvalds-remove-rdrand-from-dev-random-4/responses/9066">Linus' response to the petition to remove <code>RDRAND</code> from
/dev/random</a>. <code>RDRAND</code> is a CPU instruction introduced by Intel on recent
CPUs. It (supposedly) uses a hardware entropy source, and runs it through AES in
CBC-MAC mode, to produce random numbers. Out of fear that <code>RDRAND</code> may somehow
be backdoored, someone petitioned to remove <code>RDRAND</code> support to "improve the
overall security of the kernel". If <code>RDRAND</code> contains a back door, and an
unknown attacker can control the output, that could break pretty much all
userland crypto.</p>
<p>Linus fulminated, as he does. He suggested we go read <code>drivers/char/random.c</code>. I
quote (expletives and insults omitted):</p>
<blockquote>
<p>we use rdrand as <em>one</em> of many inputs into the random pool, and we
use it as a way to <em>improve</em> that random pool. So even if rdrand
were to be back-doored by the NSA, our use of rdrand actually
improves the quality of the random numbers you get from
/dev/random.</p>
</blockquote>
<p>I went ahead and read <code>random.c</code>. You can read it for yourself <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/char/random.c">in Linus'
tree</a>. The function I'm interested in is <code>extract_buf</code>:</p>
<pre class="code literal-block"><span></span>    <span class="cm">/*</span>
<span class="cm">     * If we have a architectural hardware random number</span>
<span class="cm">     * generator, mix that in, too.</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LONGS</span><span class="p">(</span><span class="n">EXTRACT_SIZE</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arch_get_random_long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">hash</span><span class="p">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">v</span><span class="p">;</span>
    <span class="p">}</span>
</pre>


<p>This is in the extraction phase. This is after the hash is being mixed back in
to the pool (and that's for backtracking attacks: not intended as an input to
the pool). The output of <code>arch_get_random_long</code> is being XORed in with the
extracted output, not with the pool.</p>
<p>If I were to put on my tin-foil hat, I would suggest that the difficulty has now
been moved from being able to subvert the pool as one of its entropy sources
(which we believe is impossible), versus being able to see what you're about to
be XORed with. The latter seems a lot closer to the realm of stuff a microcode
instruction can do.</p>
<p>To put it into Python:</p>
<pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">currentframe</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">getrandbits</span>

<span class="k">def</span> <span class="nf">extract_buf</span><span class="p">():</span>
    <span class="sd">"""Gets 16 bytes from the pool, and mixes them with RDRAND output.</span>

<span class="sd">    """</span>
    <span class="n">pool_bits</span> <span class="o">=</span> <span class="n">extract_from_pool</span><span class="p">()</span>
    <span class="n">rdrand_bits</span> <span class="o">=</span> <span class="n">rdrand</span><span class="p">()</span>
    <span class="k">return</span>  <span class="n">pool_bits</span> <span class="o">^</span> <span class="n">rdrand_bits</span>

<span class="k">def</span> <span class="nf">extract_from_pool</span><span class="p">():</span>
    <span class="sd">"""Pretend to get some good, unpredictable bytes from the pool.</span>

<span class="sd">    Actually gets a long with some non-cryptographically secure random</span>
<span class="sd">    bits from random.getrandbits, which is usually a Mersenne Twister.</span>

<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rdrand</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    A malicious hardware instruction.</span>
<span class="sd">    """</span>
    <span class="n">pool_bits</span> <span class="o">=</span> <span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">"pool_bits"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pool_bits</span> <span class="o">^</span> <span class="mh">0xabad1dea</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">extract_buf</span><span class="p">()</span> <span class="o">==</span> <span class="mh">0xabad1dea</span>
</pre>


<p>Why can't RDRAND work like this?</p>
<p>Some comments based on feedback I've gotten so far:</p>
<ol>
<li>
<p>This attack does not need to know where the PRNG state lives in memory. First
of all, this isn't an attack on the PRNG state, it's on the PRNG output.
Secondly, the instruction only needs to peek ahead at what is about to happen
(specifically, what's about to be XORed with) the RDRAND output. That doesn't
require knowing where the PRNG state (or its output) is being stored in memory;
we're already talking register level at that point.</p>
</li>
<li>
<p>While it's certainly true that if you can't trust the CPU, you can't trust
anything, that doesn't really make this problem go away. <code>RDRAND</code> being broken
wouldn't make software crash, which is a lot harder for almost all other
instructions. <code>RDRAND</code> being broken wouldn't result in measurable side-effects,
unlike what would happen if <code>PCLMULDQ</code> contained a back door. Furthermore, it's
a lot easier to backdoor one single microcode instruction and a lot more
plausible and feasible for a CSPRNG to be backdoored than it is to think of a
CPU as some kind of intelligent being that's actively malicious or being
remotely controlled.</p>
</li>
</ol>
<p>For what it's worth, it seems <a href="https://twitter.com/zooko/status/392334674690723840">Zooko agrees with me</a>.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../tags/cryptography/" rel="tag">cryptography</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../../01/securing-against-timing-attacks-with-twisted/" rel="prev" title="Securing against timing attacks with Twisted">Previous post</a>
            </li>
            <li class="next">
                <a href="../../11/using-protractor-with-angularjs-and-yeoman/" rel="next" title="Using protractor with AngularJS and Yeoman">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2019         <a href="mailto:_@lvh.io">lvh</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


        <script src="../../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36779422-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
