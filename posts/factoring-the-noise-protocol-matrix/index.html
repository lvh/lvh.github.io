<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Factoring the Noise protocol matrix | lvh</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#383234">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://www.lvh.io/posts/factoring-the-noise-protocol-matrix/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="lvh">
<link rel="prev" href="../self-compressing-pickles/" title="Self-compressing pickles" type="text/html">
<link rel="next" href="../the-default-openssh-key-encryption-is-worse-than-plaintext/" title="The default OpenSSH key encryption is worse than plaintext" type="text/html">
<meta property="og:site_name" content="lvh">
<meta property="og:title" content="Factoring the Noise protocol matrix">
<meta property="og:url" content="https://www.lvh.io/posts/factoring-the-noise-protocol-matrix/">
<meta property="og:description" content='.matrix {
        position: relative;
        margin: auto;
        margin-bottom: 2em;
    }
    .matrix:before, .matrix:after {
        content: "";
        position: absolute;
        top: 0;
     '>
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-07-18T10:59:00-07:00">
<meta property="article:tag" content="security">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../">
            <img src="../../pinchy.svg" alt="lvh" id="logo" class="d-inline-block align-top"><span id="blog-title">lvh</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="../../archive/" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../tags/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../talks/" class="nav-link">Talks</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<!-- Custom search --><form method="get" id="search" action="//duckduckgo.com/" class="navbar-form pull-right">
<input type="hidden" name="sites" value="https://www.lvh.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="display: none;">
</form>
<!-- End of custom search -->


            <ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Factoring the Noise protocol matrix</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    lvh
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2018-07-18T10:59:00-07:00" itemprop="datePublished" title="2018-07-18 10:59">2018-07-18 10:59</time></a>
            </p>
            
        <p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <style>
    .matrix {
        position: relative;
        margin: auto;
        margin-bottom: 2em;
    }
    .matrix:before, .matrix:after {
        content: "";
        position: absolute;
        top: 0;
        border: 3px solid #000;
        width: 20px;
        height: 100%;
    }
    .matrix:before {
        left: -10px;
        border-right: 0;
    }
    .matrix:after {
        right: -10px;
        border-left: 0;
    }
    .matrix td {
        vertical-align: middle;
        min-width: 100px;
        margin-bottom: 10px;
    }
    .matrix td p {
        vertical-align: middle;
        text-align: center;
        margin: auto;
    }
</style>
<p>The Noise protocol is one of the best things to happen to encrypted protocol
design. <a href="https://www.wireguard.com">WireGuard</a> inherits its elegance from Noise.
Noise is a cryptography engineer's darling spec. It's important not to get
blindsided while fawning over it and to pay attention to where implementers run
into trouble. Someone raised a concern I had run into before: Noise has a
matrix.</p>
<table class="matrix" style="width:100%"><tbody>
<tr>
<td colspan="1" rowspan="1">
                <p><span>N(rs):<br>  ← s<br>  ...<br>  → e, es</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NN:<br>  → e<br>  ← e, ee</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KN:<br> → s</span><br><span>  ...<br> → e<br> ← e, ee, se</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XN:<br>  → e<br>  ← e, ee<br>  → s, se</span></p>
                <p><span></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IN:</span><br><span>  → e, s<br>  ← e, ee, se</span><br><span></span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span>K(s, rs):<br>  → s<br>  ← s<br>  ...<br>  → e, es, ss</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NK:<br>  ← s<br>  ...<br>  → e, es<br>  ← e, ee</span></p>
                <p><span></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KK:</span><br><span>  → s</span><br><span>  ← s</span><br><span>  …</span><br><span>  → e, es, ss</span><br><span>  ← e, ee, se</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XK:<br>  ← s<br>  ...<br>  → e, es<br>  ← e, ee<br>  → s, se</span></p>
                <p><span></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IK:</span><br><span>  ← s<br>  ...<br>  → e, es, s, ss<br>  ← e, ee, se</span><br><span></span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span>X(s, rs):<br>  ← s<br>  ...<br>  → e, es, s, ss</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NX:<br>  → e<br>  ← e, ee, s, es</span></p>
                <p><span></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KX:<br>  → s<br>  ...<br>  → e<br>  ← e, ee, se, s, es</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XX:<br>  → e<br>  ← e, ee, s, es<br>  → s, se</span><br><span></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span> IX:</span><br><span>  → e, s</span><br><span>  ← e, ee, se, s, es</span><br><span></span></p>
            </td>
        </tr>
</tbody></table>
<p>To a cryptography engineer, this matrix is beautiful. These eldritch runes
describe a grammar: the number of ways you can meaningfully compose the phrases
that can make up a Noise handshake into a proper protocol. The rest of the
document describes what the trade-offs between them are: whether the protocol is
one-way or interactive, whether you get resistance against key-compromise
impersonation, what sort of privacy guarantees you get, et cetera.
(Key-compromise impersonation means that if I steal your key, I can impersonate
anyone to you.)</p>
<p>To the layperson implementer, the matrix is terrifying. They hadn't thought
about key-compromise impersonation or the distinction between known-key,
hidden-key and exposed-key protocols or even forward secrecy. They're going to
fall back to something else: something probably less secure but at least
unambiguous on what to do. As Noise matures into a repository for protocol
templates with wider requirements, this gets worse, not better. The most recent
revision of the Noise protocol adds 23 new "deferred" variants. It's unlikely
these will be the last additions.</p>
<p>Which Noise variant should that layperson use? Depends on the application of
course, but we can make some reasonable assumptions for most apps. Ignoring
variants, we have:</p>
<table style="text-align: center" class="matrix"><tbody>
<tr>
<td colspan="1" rowspan="1">
                <p><span>N</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NN</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KN</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XN</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IN</span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span>K</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IK</span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span>X</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IX</span></p>
            </td>
        </tr>
</tbody></table>
<p>Firstly, let's assume you need bidirectional communication, meaning
initiator and responder can send messages to each other as opposed to
just initiator to responder. That gets rid of the first column of the
matrix.</p>
<table style="text-align: center" class="matrix"><tbody>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>N</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NN</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KN</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XN</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IN</span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>K</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IK</span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>X</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IX</span></p>
            </td>
        </tr>
</tbody></table>
<p>The other protocols are defined by two letters. From the spec:</p>
<blockquote>
<p>The first character refers to the initiator's static key:</p>
<ul>
<li>N = No static key for initiator</li>
<li>K = Static key for initiator Known to responder</li>
<li>X = Static key for initiator Xmitted ("transmitted") to responder</li>
<li>I = Static key for initiator Immediately transmitted to responder, despite reduced or absent identity hiding</li>
</ul>
<p>The second character refers to the responder's static key:</p>
<ul>
<li>N = No static key for responder</li>
<li>K = Static key for responder Known to initiator</li>
<li>X = Static key for responder Xmitted ("transmitted") to initiator</li>
</ul>
</blockquote>
<p>NN provides confidentiality against a passive attacker but neither party
has any idea who you're talking to because no static (long-term) keys
are involved. For most applications none of the *N suites make a ton of
sense: they imply the initiator does not care who they're connecting to.</p>
<table style="text-align: center" class="matrix"><tbody>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>N</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>NN</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>KN</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>XN</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>IN</s></span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>K</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IK</span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>X</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>NX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IX</span></p>
            </td>
        </tr>
</tbody></table>
<p>For most applications the client (initiator) ought to have a fixed
static key so we have a convenient cryptographic identity for clients
over time. So really, if you wanted something with an N in it, you'd
know.</p>
<table style="text-align: center" class="matrix"><tbody>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>N</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>NN</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>KN</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>XN</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>IN</s></span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>K</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>NK</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IK</span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>X</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>NX</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>KX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IX</span></p>
            </td>
        </tr>
</tbody></table>
<p>The responder usually doesn't know what the key is for any initiator that
happens to show up. This mostly makes sense if you have one central initiator
that reaches out to a lot of responders: something like an MDM or sensor data
collection perhaps. In practice, you often end up doing egress from those
devices anyway for reasons that have nothing to do with Noise. So, K* is out.</p>
<table style="text-align: center" class="matrix"><tbody>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>N</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>NN</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>KN</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>XN</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>IN</s></span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>K</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>NK</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>KK</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XK</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IK</span></p>
            </td>
        </tr>
<tr>
<td colspan="1" rowspan="1">
                <p><span><s>X</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>NX</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span><s>KX</s></span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>XX</span></p>
            </td>
            <td colspan="1" rowspan="1">
                <p><span>IX</span></p>
            </td>
        </tr>
</tbody></table>
<p>These remaining suites generally trade privacy (how easily can you
identify participants) for latency (how many round trips are needed).</p>
<p>IX doesn't provide privacy for the initiator at all, but that's the side you
usually care about. It still has the roundtrip downside, making it a niche
variant. XX and XK require an extra round trip before they send over the
initiator's static key. Flip side: they have the strongest possible
privacy protection for the initiator, whose identity is only sent to the
responder after they've been authenticated and forward secrecy has been
established.</p>
<p>IK provides a reasonable tradeoff: no extra round trip and the
initiator's key is encrypted to the responder's static key. That means
that the initiator's key is only disclosed if the responder's key is
compromised. You probably don't care about that. It does require the
initiator to know the static key of the responder ahead of time but
that's probably true anyway: you want to check that key against a
trusted value. You can also try private keys for the responder offline
but that doesn't matter unless you gratuitously messed up key
generation. In conclusion, you probably want IK.</p>
<p>This breakdown only works if you're writing a client-server application
that plausibly might've used mTLS instead. WireGuard, for example, is
built on Noise_IK. The other variants aren't pointless: they're just
good at different things. If you care more about protecting your
initiator's privacy than you do about handshake latency, you want
Noise_XK. If you're doing a peer-to-peer IoT system where device
privacy matters, you might end up with Noise_XX. (It's no accident
that IK, XK and XX are in the last set of protocols standing.)</p>
<h3>Protocol variants</h3>
<p>Ignore deferred variants for now. If you needed them you'd
know. PSK is an interesting quantum computer hedge. We'll talk more about
quantum key exchanges in a different post, but briefly: a shared PSK among
several participants protects against a passive adversary that records
everything and acquires a quantum computer some time in the future, while
retaining the convenient key distribution of public keys.</p>
<h3>Conclusion</h3>
<p>It's incredible how much has happened in the last few years
to make protocols safer, between secure protocol templates like Noise,
new proof systems like Tamarin, and ubiquitous libraries of safer
primitives like libsodium. So far, the right answer for a safe transport
has almost always been TLS, perhaps mutually authenticated. That's not
going to change right away, but if you control both sides of the network
and you need properties hard to get out of TLS, Noise is definitely The
Right Answer. Just don't stare at the eldritch rune matrix too long. You
probably want Noise_IK. Or, you know, ask your security person :)</p>
<p>Thanks to Katriel Cohn-Gordon for reviewing this blog post.</p>
<p>(This post was syndicated on the Latacora blog.)</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/security/" rel="tag">security</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../self-compressing-pickles/" rel="prev" title="Self-compressing pickles">Previous post</a>
            </li>
            <li class="next">
                <a href="../the-default-openssh-key-encryption-is-worse-than-plaintext/" rel="next" title="The default OpenSSH key encryption is worse than plaintext">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2022         <a href="mailto:_@lvh.io">lvh</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36779422-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
