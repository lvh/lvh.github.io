<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HTTPS requests with client certificates in Clojure | lvh</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="https://www.lvh.io/posts/https-requests-with-client-certificates-in-clojure.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="lvh">
<link rel="prev" href="call-for-proposal-proposals.html" title="Call for proposal proposals" type="text/html">
<link rel="next" href="they-do-take-security-seriously.html" title="They do take security seriously" type="text/html">
<meta property="og:site_name" content="lvh">
<meta property="og:title" content="HTTPS requests with client certificates in Clojure">
<meta property="og:url" content="https://www.lvh.io/posts/https-requests-with-client-certificates-in-clojure.html">
<meta property="og:description" content="The vast majority of TLS connections only authenticate the
server. When the client opens the connection, the server sends its
certificate. The client checks the certificate against the list of
certifi">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-07-02T08:53:20-07:00">
<meta property="article:tag" content="security">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://www.lvh.io/">
                <img src="../pinchy.svg" alt="lvh" id="logo"><span id="blog-title">lvh</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../about.html">About</a>
                </li>
<li>
<a href="../archive.html">Archive</a>
                </li>
<li>
<a href="../categories/index.html">Tags</a>
                </li>
<li>
<a href="../talks.html">Talks</a>
                </li>
<li>
<a href="../rss.xml">RSS feed</a>

                
            </li>
</ul>
<!-- Custom search --><form method="get" id="search" action="//duckduckgo.com/" class="navbar-form pull-right">
<input type="hidden" name="sites" value="https://www.lvh.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="display: none;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right">
<li>
    <a href="https-requests-with-client-certificates-in-clojure.md" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">HTTPS requests with client certificates in Clojure</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    lvh
            </span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2015-07-02T08:53:20-07:00" itemprop="datePublished" title="2015-07-02 08:53">2015-07-02 08:53</time></a></p>
            
        <p class="sourceline"><a href="https-requests-with-client-certificates-in-clojure.md" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>The vast majority of TLS connections only authenticate the
server. When the client opens the connection, the server sends its
certificate. The client checks the certificate against the list of
certificate authorities that it knows about. The client is typically
authenticated, but over the inner HTTP connection, not at a TLS level.</p>
<p>That isn't the only way TLS can work. TLS also supports authenticating
clients with certificates, just like it authenticates servers. This is
called mutually authenticated TLS, because both peers authenticate
each other. At Rackspace Managed Security, we use this for all
communication between internal nodes. We also operate our own
certificate authority to sign all of those certificates.</p>
<p>One major library, <a href="https://github.com/http-kit/http-kit"><code>http-kit</code></a>, makes use of Java's
<code>javax.net.ssl</code>, notably <code>SSLContext</code> and <code>SSLEngine</code>. These Java APIs
are exhaustive, and very... Java. While it's easy to make fun of these
APIs, most other development environments leave you using OpenSSL,
whose APIs are patently misanthropic. While some of these APIs do
leave something to be desired, <a href="https://aphyr.com/">aphyr</a> has done a lot of the
hard work of making them more palatable with
<a href="https://github.com/aphyr/less-awful-ssl"><code>less-awful-ssl</code></a>. That gives you an
<code>SSLContext</code>. Request methods in <code>http-kit</code> have an <code>opts</code> map that
you can pass a <code>:sslengine</code> object to. Given an <code>SSLContext</code>, you just
need to do <code>(.createSSLEngine ctx)</code> to get the engine object you want.</p>
<p>Another major library, <a href="https://github.com/dakrone/clj-http"><code>clj-http</code></a>, uses lower-level
APIs. Specifically, it requires [<code>KeyStore</code>][keystore] instances for
its <code>:key-store</code> and <code>:trust-store</code> options. That requires diving deep
into Java's cryptographic APIs, which, as mentioned before, might be
something you want to avoid. While <code>clj-http</code> is probably the most
popular library, if you want to do fancy TLS tricks, you probably want
to use <code>http-kit</code> instead for now.</p>
<p>My favorite HTTP library is <a href="http://aleph.io/"><code>aleph</code></a> by
<a href="http://ideolalia.com/">Zach Tellman</a>.  It uses Netty instead of the usual Java IO
components. Fortunately, Netty's API is at least marginally friendlier
than the one in <code>javax.net.ssl</code>. Unfortunately, there's no
<code>less-awful-ssl</code> for Aleph. Plus, since I'm using <a href="https://github.com/ptaoussanis/sente"><code>sente</code></a> for
asynchronous client-server communication, which doesn't have support
for <code>aleph</code> yet. So, I'm comfortably stuck with <code>http-kit</code> for now.</p>
<p>In conclusion, API design <em>is</em> UX design. The library that "won" for
us was simply the one that was easiest to use.</p>
<p>For a deeper dive in how TLS and its building blocks work, you should
watch my talk, <a href="https://www.youtube.com/watch?v=3rmCGsCYJF8">Crypto 101</a>, or the matching <a href="https://www.crypto101.io">book</a>. It's
free! Oh, and if you're looking for information security positions
(that includes entry-level!) in an inclusive and friendly environment
that puts a heavy emphasis on teaching and personal development, you
should get in touch with me at <code>_@lvh.io</code>.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../categories/security.html" rel="tag">security</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="call-for-proposal-proposals.html" rel="prev" title="Call for proposal proposals">Previous post</a>
            </li>
            <li class="next">
                <a href="they-do-take-security-seriously.html" rel="next" title="They do take security seriously">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:_@lvh.io">lvh</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36779422-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
