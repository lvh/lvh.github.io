<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="https://www.lvh.io/posts/queryselectorall-from-an-element-probably-doesnt-do-what-you-think-it-does.html">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>querySelectorAll from an element probably doesn't do what you think it does | lvh</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="https://www.lvh.io/posts/queryselectorall-from-an-element-probably-doesnt-do-what-you-think-it-does.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="lvh">
<link rel="prev" href="todays-openssl-bug-for-techies-without-infosec-chops.html" title="Today's OpenSSL bug (for techies without infosec chops)" type="text/html">
<link rel="next" href="dont-expose-the-docker-socket-not-even-to-a-container.html" title="Don't expose the Docker socket (not even to a container)" type="text/html">
<meta property="og:site_name" content="lvh">
<meta property="og:title" content="querySelectorAll from an element probably doesn't do what you think it">
<meta property="og:url" content="https://www.lvh.io/posts/queryselectorall-from-an-element-probably-doesnt-do-what-you-think-it-does.html">
<meta property="og:description" content="Modern browsers have APIs called querySelector and querySelectorAll. They
find one or more elements matching a CSS selector. I'm assuming basic
familiarity with CSS selectors: how you select elements,">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-08-21T12:11:23-07:00">
<meta property="article:tag" content="css">
<meta property="article:tag" content="dom">
<meta property="article:tag" content="webdev">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://www.lvh.io/">
                <img src="../pinchy.svg" alt="lvh" id="logo"><span id="blog-title">lvh</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../about.html">About</a>
                </li>
<li>
<a href="../archive.html">Archive</a>
                </li>
<li>
<a href="../categories/index.html">Tags</a>
                </li>
<li>
<a href="../talks.html">Talks</a>
                </li>
<li>
<a href="../rss.xml">RSS feed</a>

                
            </li>
</ul>
<!-- Custom search --><form method="get" id="search" action="//duckduckgo.com/" class="navbar-form pull-right">
<input type="hidden" name="sites" value="https://www.lvh.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="display: none;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right">
<li>
    <a href="queryselectorall-from-an-element-probably-doesnt-do-what-you-think-it-does.md" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">querySelectorAll from an element probably doesn't do what you think it does</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    lvh
            </span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2015-08-21T12:11:23-07:00" itemprop="datePublished" title="2015-08-21 12:11">2015-08-21 12:11</time></a></p>
            
        <p class="sourceline"><a href="queryselectorall-from-an-element-probably-doesnt-do-what-you-think-it-does.md" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>Modern browsers have APIs called <code>querySelector</code> and <code>querySelectorAll</code>. They
find one or more elements matching a CSS selector. I'm assuming basic
familiarity with CSS selectors: how you select elements, classes and ids. If
you haven't used them, the Mozilla Developer Network has an excellent
<a href="https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Getting_started/Selectors">introduction</a>.</p>
<p>Imagine the following HTML page:</p>
<pre class="code literal-block"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">id=</span><span class="s">"outside"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"my-id"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;img</span> <span class="na">id=</span><span class="s">"inside"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"lonely"</span><span class="nt">&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"outer"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"inner"</span><span class="nt">&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre>


<p><code>document.querySelectorAll("div")</code> returns a <code>NodeList</code> of all of the <code>&lt;div&gt;</code>
elements on the page. <code>document.querySelector("div.lonely")</code> returns that
single lonely div.</p>
<p><code>document</code> supports both <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelector"><code>querySelector</code></a> and
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll"><code>querySelectorAll</code></a>, letting you find elements in the entire
document. Elements themselves also support both <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/querySelector"><code>querySelector</code></a> and
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/querySelectorAll"><code>querySelectorAll</code></a>, letting you query for elements that are
descendants of that element. For example, the following expression will find
images that are descendants of <code>#my-id</code>:</p>
<pre class="code literal-block"><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"#my-id"</span><span class="p">).</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">"img"</span><span class="p">)</span>
</pre>


<p>In the sample HTML page above, it will find <code>&lt;img id="inside"&gt;</code> but not <code>&lt;img
id="outside"&gt;</code>.</p>
<p>With that in mind, what do these two expressions do?</p>
<pre class="code literal-block"><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">"#my-id div div"</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"#my-id"</span><span class="p">).</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">"div div"</span><span class="p">);</span>
</pre>


<p>You might reasonably expect them to be equivalent. After all, one asks for
<code>div</code> elements inside <code>div</code> elements inside <code>#my-id</code>, and the other asks for
<code>div</code> elements inside <code>div</code> elements that are <em>descendants</em> of
<code>#my-id</code>. However, when you look at <a href="http://jsbin.com/hineco/edit?html,js,output">this JSbin</a>, you'll see that they
produce very different results:</p>
<pre class="code literal-block"><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">"#my-id div div"</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"#my-id"</span><span class="p">).</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">"div div"</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span><span class="p">;</span>
</pre>


<p>What is going on here?</p>
<p>It turns out that <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/querySelectorAll"><code>element.querySelectorAll</code></a> doesn't match elements
starting from <code>element</code>. Instead, it matches elements matching the query that
are also descendants of <code>element</code>. Therefore, we're seeing three <code>div</code>
elements: <code>div.lonely</code>, <code>div.outer</code>, <code>div.inner</code>. We're seeing them because
they both match the <code>div div</code> selector and are all descendants of <code>#my-id</code>.</p>
<p>The trick to remembering this is that CSS selectors are absolute. They are not
relative to any particular element, not even the element you're calling
<code>querySelectorAll</code> on.</p>
<p>This even works with elements <em>outside</em> the element you're calling
<code>querySelectorAll</code> on. For example, this selector:</p>
<pre class="code literal-block"><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"#my-id"</span><span class="p">).</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"div div div"</span><span class="p">)</span>
</pre>


<p>... matches <code>div.inner</code> in this snippet (<a href="http://jsbin.com/woropuc/edit?html,js,output">JSbin</a>):</p>
<pre class="code literal-block"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"my-id"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"inner"</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre>


<p>I think this API is surprising, and the front-end engineers I've asked seem to
agree with me. This is, however, not a bug. It's how the spec defines it to
work, and browsers consistently implement it that way.
Safari. <a href="http://ejohn.org/blog/thoughts-on-queryselectorall/">John Resig commented</a> how he and others felt this behavior
was quite confusing back when the spec came out.</p>
<p>If you can't easily rewrite the selector to be absolute like we did above,
there are two alternatives: the <code>:scope</code> CSS pseudo-selector, and
<code>query</code>/<code>queryAll</code>.</p>
<p>The <code>:scope</code> pseudo-selector matches against the current scope. The
name comes from the <a href="https://html.spec.whatwg.org/multipage/semantics.html#attr-style-scoped">CSS scoping</a>, which limits the scope
of styles to part of the document. The element we're calling
<code>querySelectorAll</code> on also counts as a scope, so this expression only
matches <code>div.inner</code>:</p>
<pre class="code literal-block"><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"#my-id"</span><span class="p">).</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">":scope div div"</span><span class="p">);</span>
</pre>


<p>Unfortunately, <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/%3Ascope#Browser_compatibility">browser support</a> for scoped CSS and the <code>:scope</code>
pseudo-selector is extremely limited. Only recent versions of Firefox support
it by default. Blink-based browsers like Chrome and Opera require the
well-hidden experimental features flag to be turned on. Safari has a buggy
implementation. Internet Explorer doesn't support it at all.</p>
<p>The other alternative is <code>element.query</code>/<code>queryAll</code>. These are alternative
methods to <code>querySelector</code> and <code>querySelectorAll</code> that exist on DOM parent
nodes. They also take selectors, except these selectors are interpreted
relative to the element being queried from.  Unfortunately, these methods are
even more obscure: they are not referenced on MDN or <code>caniuse.com</code>, and are
missing from the <a href="http://www.w3.org/TR/dom/#interface-parentnode">current DOM4 working draft</a>, dated 18
June 2015. They were still present in <a href="http://www.w3.org/TR/2014/WD-dom-20140204/#interface-parentnode">an older version</a>, dated 4
February 2014, as well as in the <a href="https://dom.spec.whatwg.org/#interface-parentnode">WHATWG Living Document</a> version
of the spec. They have also been implemented by at least two polyfills:</p>
<ul>
<li><a href="https://webreflection.github.io/dom4/">Dom4</a></li>
<li><a href="https://github.com/barberboy/dom-elements">dom-elements</a></li>
</ul>
<p>In conclusion, the DOM spec doesn't always necessarily do the most obvious
thing. It's important to know pitfalls like these, because they're difficult
to discover from just the behavior. Fortunately, you can often rewrite your
selector so that it isn't a problem. If you can't, there's always a polyfill
to give you the modern API you want. Alternatively, libraries like jQuery can
also help you get a consistent, friendly interface for querying the DOM.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../categories/css.html" rel="tag">css</a></li>
            <li><a class="tag p-category" href="../categories/dom.html" rel="tag">dom</a></li>
            <li><a class="tag p-category" href="../categories/webdev.html" rel="tag">webdev</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="todays-openssl-bug-for-techies-without-infosec-chops.html" rel="prev" title="Today's OpenSSL bug (for techies without infosec chops)">Previous post</a>
            </li>
            <li class="next">
                <a href="dont-expose-the-docker-socket-not-even-to-a-container.html" rel="next" title="Don't expose the Docker socket (not even to a container)">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:_@lvh.io">lvh</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36779422-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
